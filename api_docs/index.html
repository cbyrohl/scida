
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.2, mkdocs-material-8.5.10">
    
    
      
        <title>API documentation - scida</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.975780f9.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.2505c338.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../stylesheets/gridview.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
        html.glightbox-open { overflow: initial; height: 100%; }
        .gslide-title { margin-top: 0px; user-select: text; }
        .gslide-desc { color: #666; user-select: text; }
        .gslide-image img { background: white; }
        
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}
            </style> <script src="../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="None" data-md-color-accent="None">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#api-documentation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="scida" class="md-header__button md-logo" aria-label="scida" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            scida
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              API documentation
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/cbyrohl/scida" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="scida" class="md-nav__button md-logo" aria-label="scida" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    scida
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/cbyrohl/scida" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Scida
      </a>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2">
          Getting Started
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Getting Started" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Getting Started
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../install/" class="md-nav__link">
        Installation
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" type="checkbox" id="__nav_2_2" >
      
      
      
        
          
            
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../tutorial/">Tutorial</a>
          
            <label for="__nav_2_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Tutorial" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          Tutorial
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tutorial/simulations/" class="md-nav__link">
        Simulations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tutorial/observations/" class="md-nav__link">
        Observations
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3">
          Features
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Features" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Features
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../supported_data/" class="md-nav__link">
        Supported datasets
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../visualization/" class="md-nav__link">
        Visualization
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../units/" class="md-nav__link">
        Units
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../derived_fields/" class="md-nav__link">
        Derived fields
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../series/" class="md-nav__link">
        Data series
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../largedatasets/" class="md-nav__link">
        Large datasets
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4">
          Advanced Topics
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Advanced Topics" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Advanced Topics
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_1" type="checkbox" id="__nav_4_1" >
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_1">
          Arepo Simulations
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Arepo Simulations" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_1">
          <span class="md-nav__icon md-icon"></span>
          Arepo Simulations
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../halocatalogs/" class="md-nav__link">
        Halo Catalogs
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../configuration/" class="md-nav__link">
        Configuration
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../faq/" class="md-nav__link">
        FAQ
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          API documentation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        API documentation
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#scida" class="md-nav__link">
    scida
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scida.config" class="md-nav__link">
    config
  </a>
  
    <nav class="md-nav" aria-label="config">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.config.copy_defaultconfig" class="md-nav__link">
    copy_defaultconfig()
  </a>
  
    <nav class="md-nav" aria-label="copy_defaultconfig()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.config.copy_defaultconfig--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.config.get_config" class="md-nav__link">
    get_config()
  </a>
  
    <nav class="md-nav" aria-label="get_config()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.config.get_config--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.config.get_config_fromfile" class="md-nav__link">
    get_config_fromfile()
  </a>
  
    <nav class="md-nav" aria-label="get_config_fromfile()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.config.get_config_fromfile--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.config.get_config_fromfiles" class="md-nav__link">
    get_config_fromfiles()
  </a>
  
    <nav class="md-nav" aria-label="get_config_fromfiles()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.config.get_config_fromfiles--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.config.merge_dicts_recursively" class="md-nav__link">
    merge_dicts_recursively()
  </a>
  
    <nav class="md-nav" aria-label="merge_dicts_recursively()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.config.merge_dicts_recursively--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scida.convenience" class="md-nav__link">
    convenience
  </a>
  
    <nav class="md-nav" aria-label="convenience">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.convenience.download_and_extract" class="md-nav__link">
    download_and_extract()
  </a>
  
    <nav class="md-nav" aria-label="download_and_extract()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.convenience.download_and_extract--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.convenience.find_path" class="md-nav__link">
    find_path()
  </a>
  
    <nav class="md-nav" aria-label="find_path()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.convenience.find_path--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.convenience.get_dataset_by_name" class="md-nav__link">
    get_dataset_by_name()
  </a>
  
    <nav class="md-nav" aria-label="get_dataset_by_name()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.convenience.get_dataset_by_name--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.convenience.get_testdata" class="md-nav__link">
    get_testdata()
  </a>
  
    <nav class="md-nav" aria-label="get_testdata()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.convenience.get_testdata--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scida.customs" class="md-nav__link">
    customs
  </a>
  
    <nav class="md-nav" aria-label="customs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo" class="md-nav__link">
    arepo
  </a>
  
    <nav class="md-nav" aria-label="arepo">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.MTNG" class="md-nav__link">
    MTNG
  </a>
  
    <nav class="md-nav" aria-label="MTNG">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.MTNG.dataset" class="md-nav__link">
    dataset
  </a>
  
    <nav class="md-nav" aria-label="dataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.MTNG.dataset.MTNGArepoCatalog" class="md-nav__link">
    MTNGArepoCatalog
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.MTNG.dataset.MTNGArepoCatalog.validate_path--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.MTNG.dataset.MTNGArepoSnapshot" class="md-nav__link">
    MTNGArepoSnapshot
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.MTNG.dataset.MTNGArepoSnapshot.validate_path--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.TNGcluster" class="md-nav__link">
    TNGcluster
  </a>
  
    <nav class="md-nav" aria-label="TNGcluster">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.TNGcluster.dataset" class="md-nav__link">
    dataset
  </a>
  
    <nav class="md-nav" aria-label="dataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.TNGcluster.dataset.TNGClusterSnapshot" class="md-nav__link">
    TNGClusterSnapshot
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.TNGcluster.dataset.TNGClusterSnapshot.validate_path--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset" class="md-nav__link">
    dataset
  </a>
  
    <nav class="md-nav" aria-label="dataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.ArepoCatalog" class="md-nav__link">
    ArepoCatalog
  </a>
  
    <nav class="md-nav" aria-label="ArepoCatalog">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.ArepoCatalog.validate_path" class="md-nav__link">
    validate_path()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.ArepoCatalog.validate_path--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.ArepoSnapshot" class="md-nav__link">
    ArepoSnapshot
  </a>
  
    <nav class="md-nav" aria-label="ArepoSnapshot">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.ArepoSnapshot.add_catalogIDs" class="md-nav__link">
    add_catalogIDs()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.ArepoSnapshot.discover_catalog" class="md-nav__link">
    discover_catalog()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.ArepoSnapshot.get_grouplengths" class="md-nav__link">
    get_grouplengths()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.ArepoSnapshot.get_subhalolengths" class="md-nav__link">
    get_subhalolengths()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.ArepoSnapshot.register_field" class="md-nav__link">
    register_field()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.ArepoSnapshot.register_field--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.ArepoSnapshot.validate_path" class="md-nav__link">
    validate_path()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.ArepoSnapshot.validate_path--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.Temperature" class="md-nav__link">
    Temperature()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.compute_haloindex" class="md-nav__link">
    compute_haloindex()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.compute_haloquantity" class="md-nav__link">
    compute_haloquantity()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.get_hidx" class="md-nav__link">
    get_hidx()
  </a>
  
    <nav class="md-nav" aria-label="get_hidx()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.get_hidx--parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.get_localshidx" class="md-nav__link">
    get_localshidx()
  </a>
  
    <nav class="md-nav" aria-label="get_localshidx()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.get_localshidx--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.get_shcounts_shcells" class="md-nav__link">
    get_shcounts_shcells()
  </a>
  
    <nav class="md-nav" aria-label="get_shcounts_shcells()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.get_shcounts_shcells--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.map_group_operation" class="md-nav__link">
    map_group_operation()
  </a>
  
    <nav class="md-nav" aria-label="map_group_operation()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.map_group_operation--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.map_group_operation_get_chunkedges" class="md-nav__link">
    map_group_operation_get_chunkedges()
  </a>
  
    <nav class="md-nav" aria-label="map_group_operation_get_chunkedges()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.map_group_operation_get_chunkedges--parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.map_group_operation_get_chunkedges--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.memorycost_limiter" class="md-nav__link">
    memorycost_limiter()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.helpers" class="md-nav__link">
    helpers
  </a>
  
    <nav class="md-nav" aria-label="helpers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.helpers.part_type_num" class="md-nav__link">
    part_type_num()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.series" class="md-nav__link">
    series
  </a>
  
    <nav class="md-nav" aria-label="series">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.series.ArepoSimulation" class="md-nav__link">
    ArepoSimulation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.gadgetstyle" class="md-nav__link">
    gadgetstyle
  </a>
  
    <nav class="md-nav" aria-label="gadgetstyle">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.customs.gadgetstyle.dataset" class="md-nav__link">
    dataset
  </a>
  
    <nav class="md-nav" aria-label="dataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.customs.gadgetstyle.dataset.GadgetStyleSnapshot" class="md-nav__link">
    GadgetStyleSnapshot
  </a>
  
    <nav class="md-nav" aria-label="GadgetStyleSnapshot">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.customs.gadgetstyle.dataset.GadgetStyleSnapshot.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.gadgetstyle.dataset.GadgetStyleSnapshot.validate_path" class="md-nav__link">
    validate_path()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.gadgetstyle.dataset.GadgetStyleSnapshot.validate_path--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.gadgetstyle.series" class="md-nav__link">
    series
  </a>
  
    <nav class="md-nav" aria-label="series">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.customs.gadgetstyle.series.GadgetStyleSimulation" class="md-nav__link">
    GadgetStyleSimulation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scida.discovertypes" class="md-nav__link">
    discovertypes
  </a>
  
    <nav class="md-nav" aria-label="discovertypes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.discovertypes.CandidateStatus" class="md-nav__link">
    CandidateStatus
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scida.fields" class="md-nav__link">
    fields
  </a>
  
    <nav class="md-nav" aria-label="fields">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.fields.FieldContainer" class="md-nav__link">
    FieldContainer
  </a>
  
    <nav class="md-nav" aria-label="FieldContainer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.fields.FieldContainer.__repr__" class="md-nav__link">
    __repr__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.fields.FieldContainer.get" class="md-nav__link">
    get()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.fields.FieldContainer.items" class="md-nav__link">
    items()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.fields.FieldContainer.keys" class="md-nav__link">
    keys()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.fields.FieldContainer.values" class="md-nav__link">
    values()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.fields.FieldType" class="md-nav__link">
    FieldType
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scida.helpers_hdf5" class="md-nav__link">
    helpers_hdf5
  </a>
  
    <nav class="md-nav" aria-label="helpers_hdf5">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.helpers_hdf5.create_mergedhdf5file" class="md-nav__link">
    create_mergedhdf5file()
  </a>
  
    <nav class="md-nav" aria-label="create_mergedhdf5file()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.helpers_hdf5.create_mergedhdf5file--parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.helpers_hdf5.create_mergedhdf5file--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scida.helpers_misc" class="md-nav__link">
    helpers_misc
  </a>
  
    <nav class="md-nav" aria-label="helpers_misc">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.helpers_misc.RecursiveNamespace" class="md-nav__link">
    RecursiveNamespace
  </a>
  
    <nav class="md-nav" aria-label="RecursiveNamespace">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.helpers_misc.RecursiveNamespace.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.helpers_misc.map_blocks" class="md-nav__link">
    map_blocks()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.helpers_misc.sprint" class="md-nav__link">
    sprint()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scida.interface" class="md-nav__link">
    interface
  </a>
  
    <nav class="md-nav" aria-label="interface">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.interface.BaseDataset" class="md-nav__link">
    BaseDataset
  </a>
  
    <nav class="md-nav" aria-label="BaseDataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.interface.BaseDataset.__dask_tokenize__" class="md-nav__link">
    __dask_tokenize__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.interface.BaseDataset.__hash__" class="md-nav__link">
    __hash__()
  </a>
  
    <nav class="md-nav" aria-label="__hash__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.interface.BaseDataset.__hash__--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.interface.BaseDataset.__init_subclass__" class="md-nav__link">
    __init_subclass__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.interface.BaseDataset.__repr__" class="md-nav__link">
    __repr__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.interface.BaseDataset.info" class="md-nav__link">
    info()
  </a>
  
    <nav class="md-nav" aria-label="info()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.interface.BaseDataset.info--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.interface.BaseDataset.return_data" class="md-nav__link">
    return_data()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.interface.BaseDataset.save" class="md-nav__link">
    save()
  </a>
  
    <nav class="md-nav" aria-label="save()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.interface.BaseDataset.save--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.interface.BaseDataset.validate_path" class="md-nav__link">
    validate_path()
  </a>
  
    <nav class="md-nav" aria-label="validate_path()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.interface.BaseDataset.validate_path--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.interface.Dataset" class="md-nav__link">
    Dataset
  </a>
  
    <nav class="md-nav" aria-label="Dataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.interface.Dataset.validate_path" class="md-nav__link">
    validate_path()
  </a>
  
    <nav class="md-nav" aria-label="validate_path()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.interface.Dataset.validate_path--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.interface.Selector" class="md-nav__link">
    Selector
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scida.misc" class="md-nav__link">
    misc
  </a>
  
    <nav class="md-nav" aria-label="misc">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.misc.check_config_for_dataset" class="md-nav__link">
    check_config_for_dataset()
  </a>
  
    <nav class="md-nav" aria-label="check_config_for_dataset()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.misc.check_config_for_dataset--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.misc.deepdictkeycopy" class="md-nav__link">
    deepdictkeycopy()
  </a>
  
    <nav class="md-nav" aria-label="deepdictkeycopy()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.misc.deepdictkeycopy--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.misc.map_interface_args" class="md-nav__link">
    map_interface_args()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.misc.path_hdf5cachefile_exists" class="md-nav__link">
    path_hdf5cachefile_exists()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.misc.return_cachefile_path" class="md-nav__link">
    return_cachefile_path()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scida.series" class="md-nav__link">
    series
  </a>
  
    <nav class="md-nav" aria-label="series">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.series.DatasetSeries" class="md-nav__link">
    DatasetSeries
  </a>
  
    <nav class="md-nav" aria-label="DatasetSeries">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.series.DatasetSeries.__init_subclass__" class="md-nav__link">
    __init_subclass__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.series.DatasetSeries.__repr__" class="md-nav__link">
    __repr__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.series.DatasetSeries.get_dataset" class="md-nav__link">
    get_dataset()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.series.DirectoryCatalog" class="md-nav__link">
    DirectoryCatalog
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.series.HomogeneousSeries" class="md-nav__link">
    HomogeneousSeries
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#scida" class="md-nav__link">
    scida
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scida.config" class="md-nav__link">
    config
  </a>
  
    <nav class="md-nav" aria-label="config">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.config.copy_defaultconfig" class="md-nav__link">
    copy_defaultconfig()
  </a>
  
    <nav class="md-nav" aria-label="copy_defaultconfig()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.config.copy_defaultconfig--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.config.get_config" class="md-nav__link">
    get_config()
  </a>
  
    <nav class="md-nav" aria-label="get_config()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.config.get_config--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.config.get_config_fromfile" class="md-nav__link">
    get_config_fromfile()
  </a>
  
    <nav class="md-nav" aria-label="get_config_fromfile()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.config.get_config_fromfile--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.config.get_config_fromfiles" class="md-nav__link">
    get_config_fromfiles()
  </a>
  
    <nav class="md-nav" aria-label="get_config_fromfiles()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.config.get_config_fromfiles--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.config.merge_dicts_recursively" class="md-nav__link">
    merge_dicts_recursively()
  </a>
  
    <nav class="md-nav" aria-label="merge_dicts_recursively()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.config.merge_dicts_recursively--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scida.convenience" class="md-nav__link">
    convenience
  </a>
  
    <nav class="md-nav" aria-label="convenience">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.convenience.download_and_extract" class="md-nav__link">
    download_and_extract()
  </a>
  
    <nav class="md-nav" aria-label="download_and_extract()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.convenience.download_and_extract--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.convenience.find_path" class="md-nav__link">
    find_path()
  </a>
  
    <nav class="md-nav" aria-label="find_path()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.convenience.find_path--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.convenience.get_dataset_by_name" class="md-nav__link">
    get_dataset_by_name()
  </a>
  
    <nav class="md-nav" aria-label="get_dataset_by_name()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.convenience.get_dataset_by_name--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.convenience.get_testdata" class="md-nav__link">
    get_testdata()
  </a>
  
    <nav class="md-nav" aria-label="get_testdata()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.convenience.get_testdata--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scida.customs" class="md-nav__link">
    customs
  </a>
  
    <nav class="md-nav" aria-label="customs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo" class="md-nav__link">
    arepo
  </a>
  
    <nav class="md-nav" aria-label="arepo">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.MTNG" class="md-nav__link">
    MTNG
  </a>
  
    <nav class="md-nav" aria-label="MTNG">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.MTNG.dataset" class="md-nav__link">
    dataset
  </a>
  
    <nav class="md-nav" aria-label="dataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.MTNG.dataset.MTNGArepoCatalog" class="md-nav__link">
    MTNGArepoCatalog
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.MTNG.dataset.MTNGArepoCatalog.validate_path--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.MTNG.dataset.MTNGArepoSnapshot" class="md-nav__link">
    MTNGArepoSnapshot
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.MTNG.dataset.MTNGArepoSnapshot.validate_path--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.TNGcluster" class="md-nav__link">
    TNGcluster
  </a>
  
    <nav class="md-nav" aria-label="TNGcluster">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.TNGcluster.dataset" class="md-nav__link">
    dataset
  </a>
  
    <nav class="md-nav" aria-label="dataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.TNGcluster.dataset.TNGClusterSnapshot" class="md-nav__link">
    TNGClusterSnapshot
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.TNGcluster.dataset.TNGClusterSnapshot.validate_path--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset" class="md-nav__link">
    dataset
  </a>
  
    <nav class="md-nav" aria-label="dataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.ArepoCatalog" class="md-nav__link">
    ArepoCatalog
  </a>
  
    <nav class="md-nav" aria-label="ArepoCatalog">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.ArepoCatalog.validate_path" class="md-nav__link">
    validate_path()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.ArepoCatalog.validate_path--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.ArepoSnapshot" class="md-nav__link">
    ArepoSnapshot
  </a>
  
    <nav class="md-nav" aria-label="ArepoSnapshot">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.ArepoSnapshot.add_catalogIDs" class="md-nav__link">
    add_catalogIDs()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.ArepoSnapshot.discover_catalog" class="md-nav__link">
    discover_catalog()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.ArepoSnapshot.get_grouplengths" class="md-nav__link">
    get_grouplengths()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.ArepoSnapshot.get_subhalolengths" class="md-nav__link">
    get_subhalolengths()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.ArepoSnapshot.register_field" class="md-nav__link">
    register_field()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.ArepoSnapshot.register_field--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.ArepoSnapshot.validate_path" class="md-nav__link">
    validate_path()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.ArepoSnapshot.validate_path--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.Temperature" class="md-nav__link">
    Temperature()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.compute_haloindex" class="md-nav__link">
    compute_haloindex()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.compute_haloquantity" class="md-nav__link">
    compute_haloquantity()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.get_hidx" class="md-nav__link">
    get_hidx()
  </a>
  
    <nav class="md-nav" aria-label="get_hidx()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.get_hidx--parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.get_localshidx" class="md-nav__link">
    get_localshidx()
  </a>
  
    <nav class="md-nav" aria-label="get_localshidx()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.get_localshidx--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.get_shcounts_shcells" class="md-nav__link">
    get_shcounts_shcells()
  </a>
  
    <nav class="md-nav" aria-label="get_shcounts_shcells()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.get_shcounts_shcells--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.map_group_operation" class="md-nav__link">
    map_group_operation()
  </a>
  
    <nav class="md-nav" aria-label="map_group_operation()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.map_group_operation--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.map_group_operation_get_chunkedges" class="md-nav__link">
    map_group_operation_get_chunkedges()
  </a>
  
    <nav class="md-nav" aria-label="map_group_operation_get_chunkedges()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.map_group_operation_get_chunkedges--parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.map_group_operation_get_chunkedges--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.dataset.memorycost_limiter" class="md-nav__link">
    memorycost_limiter()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.helpers" class="md-nav__link">
    helpers
  </a>
  
    <nav class="md-nav" aria-label="helpers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.helpers.part_type_num" class="md-nav__link">
    part_type_num()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.series" class="md-nav__link">
    series
  </a>
  
    <nav class="md-nav" aria-label="series">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.customs.arepo.series.ArepoSimulation" class="md-nav__link">
    ArepoSimulation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.gadgetstyle" class="md-nav__link">
    gadgetstyle
  </a>
  
    <nav class="md-nav" aria-label="gadgetstyle">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.customs.gadgetstyle.dataset" class="md-nav__link">
    dataset
  </a>
  
    <nav class="md-nav" aria-label="dataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.customs.gadgetstyle.dataset.GadgetStyleSnapshot" class="md-nav__link">
    GadgetStyleSnapshot
  </a>
  
    <nav class="md-nav" aria-label="GadgetStyleSnapshot">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.customs.gadgetstyle.dataset.GadgetStyleSnapshot.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.gadgetstyle.dataset.GadgetStyleSnapshot.validate_path" class="md-nav__link">
    validate_path()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.gadgetstyle.dataset.GadgetStyleSnapshot.validate_path--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.customs.gadgetstyle.series" class="md-nav__link">
    series
  </a>
  
    <nav class="md-nav" aria-label="series">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.customs.gadgetstyle.series.GadgetStyleSimulation" class="md-nav__link">
    GadgetStyleSimulation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scida.discovertypes" class="md-nav__link">
    discovertypes
  </a>
  
    <nav class="md-nav" aria-label="discovertypes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.discovertypes.CandidateStatus" class="md-nav__link">
    CandidateStatus
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scida.fields" class="md-nav__link">
    fields
  </a>
  
    <nav class="md-nav" aria-label="fields">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.fields.FieldContainer" class="md-nav__link">
    FieldContainer
  </a>
  
    <nav class="md-nav" aria-label="FieldContainer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.fields.FieldContainer.__repr__" class="md-nav__link">
    __repr__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.fields.FieldContainer.get" class="md-nav__link">
    get()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.fields.FieldContainer.items" class="md-nav__link">
    items()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.fields.FieldContainer.keys" class="md-nav__link">
    keys()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.fields.FieldContainer.values" class="md-nav__link">
    values()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.fields.FieldType" class="md-nav__link">
    FieldType
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scida.helpers_hdf5" class="md-nav__link">
    helpers_hdf5
  </a>
  
    <nav class="md-nav" aria-label="helpers_hdf5">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.helpers_hdf5.create_mergedhdf5file" class="md-nav__link">
    create_mergedhdf5file()
  </a>
  
    <nav class="md-nav" aria-label="create_mergedhdf5file()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.helpers_hdf5.create_mergedhdf5file--parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.helpers_hdf5.create_mergedhdf5file--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scida.helpers_misc" class="md-nav__link">
    helpers_misc
  </a>
  
    <nav class="md-nav" aria-label="helpers_misc">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.helpers_misc.RecursiveNamespace" class="md-nav__link">
    RecursiveNamespace
  </a>
  
    <nav class="md-nav" aria-label="RecursiveNamespace">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.helpers_misc.RecursiveNamespace.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.helpers_misc.map_blocks" class="md-nav__link">
    map_blocks()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.helpers_misc.sprint" class="md-nav__link">
    sprint()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scida.interface" class="md-nav__link">
    interface
  </a>
  
    <nav class="md-nav" aria-label="interface">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.interface.BaseDataset" class="md-nav__link">
    BaseDataset
  </a>
  
    <nav class="md-nav" aria-label="BaseDataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.interface.BaseDataset.__dask_tokenize__" class="md-nav__link">
    __dask_tokenize__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.interface.BaseDataset.__hash__" class="md-nav__link">
    __hash__()
  </a>
  
    <nav class="md-nav" aria-label="__hash__()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.interface.BaseDataset.__hash__--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.interface.BaseDataset.__init_subclass__" class="md-nav__link">
    __init_subclass__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.interface.BaseDataset.__repr__" class="md-nav__link">
    __repr__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.interface.BaseDataset.info" class="md-nav__link">
    info()
  </a>
  
    <nav class="md-nav" aria-label="info()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.interface.BaseDataset.info--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.interface.BaseDataset.return_data" class="md-nav__link">
    return_data()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.interface.BaseDataset.save" class="md-nav__link">
    save()
  </a>
  
    <nav class="md-nav" aria-label="save()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.interface.BaseDataset.save--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.interface.BaseDataset.validate_path" class="md-nav__link">
    validate_path()
  </a>
  
    <nav class="md-nav" aria-label="validate_path()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.interface.BaseDataset.validate_path--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.interface.Dataset" class="md-nav__link">
    Dataset
  </a>
  
    <nav class="md-nav" aria-label="Dataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.interface.Dataset.validate_path" class="md-nav__link">
    validate_path()
  </a>
  
    <nav class="md-nav" aria-label="validate_path()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.interface.Dataset.validate_path--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.interface.Selector" class="md-nav__link">
    Selector
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scida.misc" class="md-nav__link">
    misc
  </a>
  
    <nav class="md-nav" aria-label="misc">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.misc.check_config_for_dataset" class="md-nav__link">
    check_config_for_dataset()
  </a>
  
    <nav class="md-nav" aria-label="check_config_for_dataset()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.misc.check_config_for_dataset--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.misc.deepdictkeycopy" class="md-nav__link">
    deepdictkeycopy()
  </a>
  
    <nav class="md-nav" aria-label="deepdictkeycopy()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.misc.deepdictkeycopy--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.misc.map_interface_args" class="md-nav__link">
    map_interface_args()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.misc.path_hdf5cachefile_exists" class="md-nav__link">
    path_hdf5cachefile_exists()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.misc.return_cachefile_path" class="md-nav__link">
    return_cachefile_path()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scida.series" class="md-nav__link">
    series
  </a>
  
    <nav class="md-nav" aria-label="series">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.series.DatasetSeries" class="md-nav__link">
    DatasetSeries
  </a>
  
    <nav class="md-nav" aria-label="DatasetSeries">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scida.series.DatasetSeries.__init_subclass__" class="md-nav__link">
    __init_subclass__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.series.DatasetSeries.__repr__" class="md-nav__link">
    __repr__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.series.DatasetSeries.get_dataset" class="md-nav__link">
    get_dataset()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.series.DirectoryCatalog" class="md-nav__link">
    DirectoryCatalog
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scida.series.HomogeneousSeries" class="md-nav__link">
    HomogeneousSeries
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <a href="https://github.com/cbyrohl/scida/edit/master/docs/api_docs.md" title="Edit this page" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


<div><h1 id="api-documentation">API documentation</h1>


  <div class="doc doc-object doc-module">

<a id="scida"></a>
    <div class="doc doc-contents first">




  <div class="doc doc-children">










  <div class="doc doc-object doc-module">



<h2 id="scida.config" class="doc doc-heading">
        <code>config</code>



</h2>

    <div class="doc doc-contents ">




  <div class="doc doc-children">









  <div class="doc doc-object doc-function">



<h3 id="scida.config.copy_defaultconfig" class="doc doc-heading">
<code class="highlight language-python"><span class="n">copy_defaultconfig</span><span class="p">(</span><span class="n">overwrite</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Copy the configuration example to the user's home directory.
Parameters</p>
<hr>
<div class="admonition overwrite">
<p class="admonition-title">bool</p>
<p>Overwrite existing configuration file.</p>
</div>
<h5 id="scida.config.copy_defaultconfig--returns">Returns</h5>

        <details class="quote">
          <summary>Source code in <code>scida/config.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">copy_defaultconfig</span><span class="p">(</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Copy the configuration example to the user's home directory.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    overwrite: bool</span>
<span class="sd">        Overwrite existing configuration file.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    """</span>

    <span class="n">path_user</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">"~"</span><span class="p">)</span>
    <span class="n">path_confdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_user</span><span class="p">,</span> <span class="s2">".config/scida"</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_confdir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path_confdir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">path_conf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_confdir</span><span class="p">,</span> <span class="s2">"config.yaml"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_conf</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Configuration file already exists at '</span><span class="si">%s</span><span class="s2">'"</span> <span class="o">%</span> <span class="n">path_conf</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">importlib</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="s2">"scida.configfiles"</span><span class="p">,</span> <span class="s2">"config.yaml"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_conf</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">newfile</span><span class="p">:</span>
                <span class="n">newfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="scida.config.get_config" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_config</span><span class="p">(</span><span class="n">reload</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">update_global</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Load the configuration from the default path.
Parameters</p>
<hr>
<div class="admonition reload">
<p class="admonition-title">bool</p>
<p>Reload the configuration, even if it has already been loaded.</p>
</div>
<div class="admonition update_global">
<p class="admonition-title">bool</p>
<p>Update the global configuration dictionary.</p>
</div>
<h5 id="scida.config.get_config--returns">Returns</h5>
<p>dict
    The configuration dictionary.</p>

        <details class="quote">
          <summary>Source code in <code>scida/config.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_config</span><span class="p">(</span><span class="n">reload</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">update_global</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Load the configuration from the default path.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    reload: bool</span>
<span class="sd">        Reload the configuration, even if it has already been loaded.</span>
<span class="sd">    update_global: bool</span>
<span class="sd">        Update the global configuration dictionary.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        The configuration dictionary.</span>

<span class="sd">    """</span>
    <span class="k">global</span> <span class="n">_conf</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="s2">"SCIDA_"</span>
    <span class="n">envconf</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">k</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="n">v</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1"># in any case, we make sure that there is some config in the default path.</span>
    <span class="n">path_confdir</span> <span class="o">=</span> <span class="n">_access_confdir</span><span class="p">()</span>
    <span class="n">path_conf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_confdir</span><span class="p">,</span> <span class="s2">"config.yaml"</span><span class="p">)</span>

    <span class="c1"># next, we load the config from the default path, unless explicitly overridden.</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">envconf</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"config_path"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">path_conf</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">reload</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">_conf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_conf</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config_fromfile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"copied_default"</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">"Warning! Using default configuration. Please adjust/replace in '</span><span class="si">%s</span><span class="s2">'."</span>
            <span class="o">%</span> <span class="n">path</span>
        <span class="p">)</span>

    <span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">envconf</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">update_global</span><span class="p">:</span>
        <span class="n">_conf</span> <span class="o">=</span> <span class="n">config</span>
    <span class="k">return</span> <span class="n">config</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="scida.config.get_config_fromfile" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_config_fromfile</span><span class="p">(</span><span class="n">resource</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Load config from a YAML file.
Parameters</p>
<hr>
<p>resource
    The name of the resource or file path.</p>
<h5 id="scida.config.get_config_fromfile--returns">Returns</h5>

        <details class="quote">
          <summary>Source code in <code>scida/config.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_config_fromfile</span><span class="p">(</span><span class="n">resource</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Load config from a YAML file.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    resource</span>
<span class="sd">        The name of the resource or file path.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">resource</span> <span class="o">==</span> <span class="s2">""</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Config name cannot be empty."</span><span class="p">)</span>
    <span class="c1"># order (in descending order of priority):</span>
    <span class="c1"># 1. absolute path?</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">conf</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">conf</span>
    <span class="c1"># 2. non-absolute path?</span>
    <span class="c1"># 2.1. check ~/.config/scida/</span>
    <span class="n">bpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">"~/.config/scida"</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bpath</span><span class="p">,</span> <span class="n">resource</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">conf</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">conf</span>
    <span class="c1"># 2.2 check scida package resources</span>
    <span class="n">resource_path</span> <span class="o">=</span> <span class="s2">"scida.configfiles"</span>
    <span class="n">resource_elements</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span>
    <span class="n">rname</span> <span class="o">=</span> <span class="n">resource_elements</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">resource_elements</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">resource_path</span> <span class="o">+=</span> <span class="s2">"."</span> <span class="o">+</span> <span class="s2">"."</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">resource_elements</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">with</span> <span class="n">importlib</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="n">resource_path</span><span class="p">,</span> <span class="n">rname</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">conf</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">conf</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="scida.config.get_config_fromfiles" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_config_fromfiles</span><span class="p">(</span><span class="n">paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">subconf_keys</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Load and merge multiple YAML config files
Parameters</p>
<hr>
<p>paths
    Paths to the config files.
subconf_keys
    The keys to the correct sub configuration within each config.</p>
<h5 id="scida.config.get_config_fromfiles--returns">Returns</h5>

        <details class="quote">
          <summary>Source code in <code>scida/config.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_config_fromfiles</span><span class="p">(</span><span class="n">paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">subconf_keys</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Load and merge multiple YAML config files</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    paths</span>
<span class="sd">        Paths to the config files.</span>
<span class="sd">    subconf_keys</span>
<span class="sd">        The keys to the correct sub configuration within each config.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    """</span>
    <span class="n">confs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
        <span class="n">confs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_config_fromfile</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
    <span class="n">conf</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">confdict</span> <span class="ow">in</span> <span class="n">confs</span><span class="p">:</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="n">merge_dicts_recursively</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">confdict</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">conf</span>
</code></pre></div>
        </details>
    </div>

  </div>




  <div class="doc doc-object doc-function">



<h3 id="scida.config.merge_dicts_recursively" class="doc doc-heading">
<code class="highlight language-python"><span class="n">merge_dicts_recursively</span><span class="p">(</span><span class="n">dict_a</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">dict_b</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mergefunc_keys</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">function</span> <span class="nb">callable</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mergefunc_values</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">function</span> <span class="nb">callable</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Merge two dictionaries recursively.
Parameters</p>
<hr>
<p>dict_a
    The first dictionary.
dict_b
    The second dictionary.
path
    The path to the current node.</p>
<div class="admonition mergefunc_keys">
<p class="admonition-title">callable</p>
<p>The function to use for merging. If None, we recursively enter the dictionary.</p>
</div>
<div class="admonition mergefunc_values">
<p class="admonition-title">callable</p>
<p>The function to use for merging. If None, collisions will raise an exception.</p>
</div>
<h5 id="scida.config.merge_dicts_recursively--returns">Returns</h5>
<p>dict</p>

        <details class="quote">
          <summary>Source code in <code>scida/config.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">merge_dicts_recursively</span><span class="p">(</span>
    <span class="n">dict_a</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="n">dict_b</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">mergefunc_keys</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">mergefunc_values</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Merge two dictionaries recursively.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dict_a</span>
<span class="sd">        The first dictionary.</span>
<span class="sd">    dict_b</span>
<span class="sd">        The second dictionary.</span>
<span class="sd">    path</span>
<span class="sd">        The path to the current node.</span>
<span class="sd">    mergefunc_keys: callable</span>
<span class="sd">        The function to use for merging. If None, we recursively enter the dictionary.</span>
<span class="sd">    mergefunc_values: callable</span>
<span class="sd">        The function to use for merging. If None, collisions will raise an exception.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dict_b</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dict_a</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mergefunc_keys</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dict_a</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">mergefunc_keys</span><span class="p">(</span><span class="n">dict_a</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">dict_b</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dict_a</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dict_b</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">merge_dicts_recursively</span><span class="p">(</span>
                    <span class="n">dict_a</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                    <span class="n">dict_b</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                    <span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)],</span>
                    <span class="n">mergefunc_keys</span><span class="o">=</span><span class="n">mergefunc_keys</span><span class="p">,</span>
                    <span class="n">mergefunc_values</span><span class="o">=</span><span class="n">mergefunc_values</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">dict_a</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="n">dict_b</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                <span class="k">pass</span>  <span class="c1"># same leaf value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mergefunc_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">dict_a</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">mergefunc_values</span><span class="p">(</span><span class="n">dict_a</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">dict_b</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Conflict at </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="s2">"."</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dict_a</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_b</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">dict_a</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>




  <div class="doc doc-object doc-module">



<h2 id="scida.convenience" class="doc doc-heading">
        <code>convenience</code>



</h2>

    <div class="doc doc-contents ">




  <div class="doc doc-children">









  <div class="doc doc-object doc-function">



<h3 id="scida.convenience.download_and_extract" class="doc doc-heading">
<code class="highlight language-python"><span class="n">download_and_extract</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">progressbar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Download and extract a file from a given url.
Parameters</p>
<hr>
<div class="admonition url">
<p class="admonition-title">str</p>
<p>The url to download from.</p>
</div>
<div class="admonition path">
<p class="admonition-title">pathlib.Path</p>
<p>The path to download to.</p>
</div>
<div class="admonition progressbar">
<p class="admonition-title">bool</p>
<p>Whether to show a progress bar.</p>
</div>
<div class="admonition overwrite">
<p class="admonition-title">bool</p>
<p>Whether to overwrite an existing file.</p>
</div>
<h5 id="scida.convenience.download_and_extract--returns">Returns</h5>
<p>str
    The path to the downloaded and extracted file(s).</p>

        <details class="quote">
          <summary>Source code in <code>scida/convenience.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">download_and_extract</span><span class="p">(</span>
    <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span> <span class="n">progressbar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Download and extract a file from a given url.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    url: str</span>
<span class="sd">        The url to download from.</span>
<span class="sd">    path: pathlib.Path</span>
<span class="sd">        The path to download to.</span>
<span class="sd">    progressbar: bool</span>
<span class="sd">        Whether to show a progress bar.</span>
<span class="sd">    overwrite: bool</span>
<span class="sd">        Whether to overwrite an existing file.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        The path to the downloaded and extracted file(s).</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Target path '</span><span class="si">%s</span><span class="s2">' already exists."</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">r</span><span class="p">:</span>
        <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="n">totlength</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"content-length"</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">lread</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">22</span><span class="p">):</span>  <span class="c1"># chunks of 4MB</span>
                <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                <span class="n">lread</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">progressbar</span><span class="p">:</span>
                    <span class="n">rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">lread</span> <span class="o">/</span> <span class="mi">2</span><span class="o">**</span><span class="mi">20</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">t2</span> <span class="o">-</span> <span class="n">t1</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="s2">"</span><span class="se">\r</span><span class="s2">Downloaded </span><span class="si">%.2f</span><span class="s2">/</span><span class="si">%.2f</span><span class="s2"> Megabytes (</span><span class="si">%.2f%%</span><span class="s2">, </span><span class="si">%.2f</span><span class="s2"> MB/s)"</span>
                        <span class="o">%</span> <span class="p">(</span>
                            <span class="n">lread</span> <span class="o">/</span> <span class="mi">2</span><span class="o">**</span><span class="mi">20</span><span class="p">,</span>
                            <span class="n">totlength</span> <span class="o">/</span> <span class="mi">2</span><span class="o">**</span><span class="mi">20</span><span class="p">,</span>
                            <span class="mf">100.0</span> <span class="o">*</span> <span class="n">lread</span> <span class="o">/</span> <span class="n">totlength</span><span class="p">,</span>
                            <span class="n">rate</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">tar</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">"r:gz"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tar</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">isdir</span><span class="p">():</span>
            <span class="n">t</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="s2">"0755"</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="s2">"0644"</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">tar</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">foldername</span> <span class="o">=</span> <span class="n">tar</span><span class="o">.</span><span class="n">getmembers</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># parent folder of extracted tar.gz</span>
    <span class="n">tar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">foldername</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="scida.convenience.find_path" class="doc doc-heading">
<code class="highlight language-python"><span class="n">find_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">overwrite</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Find path to dataset.
Parameters</p>
<hr>
<p>path: str</p>
<div class="admonition overwrite">
<p class="admonition-title">bool</p>
<p>Only for remote datasets. Whether to overwrite an existing download.</p>
</div>
<h5 id="scida.convenience.find_path--returns">Returns</h5>
<p>str</p>

        <details class="quote">
          <summary>Source code in <code>scida/convenience.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">find_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Find path to dataset.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path: str</span>
<span class="sd">    overwrite: bool</span>
<span class="sd">        Only for remote datasets. Whether to overwrite an existing download.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>

<span class="sd">    """</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="c1"># datasets on disk</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">":"</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># check different alternative backends</span>
        <span class="n">databackend</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"://"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dataname</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"://"</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">databackend</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"http"</span><span class="p">,</span> <span class="s2">"https"</span><span class="p">]:</span>
            <span class="c1"># dataset on the internet</span>
            <span class="n">savepath</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"download_path"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">savepath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">"Have not specified 'download_path' in config. Using 'cache_path' instead."</span>
                <span class="p">)</span>
                <span class="n">savepath</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"cache_path"</span><span class="p">)</span>
            <span class="n">savepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">savepath</span><span class="p">)</span>
            <span class="n">savepath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">savepath</span><span class="p">)</span>
            <span class="n">savepath</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">urlhash</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">"utf-8"</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(),</span> <span class="mi">16</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span><span class="o">**</span><span class="mi">8</span>
            <span class="p">)</span>
            <span class="n">savepath</span> <span class="o">=</span> <span class="n">savepath</span> <span class="o">/</span> <span class="p">(</span><span class="s2">"download"</span> <span class="o">+</span> <span class="n">urlhash</span><span class="p">)</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s2">"archive.tar.gz"</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">savepath</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">savepath</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">overwrite</span><span class="p">:</span>
                <span class="c1"># delete all files in folder</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">savepath</span><span class="p">):</span>
                    <span class="n">fp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savepath</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fp</span><span class="p">):</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
            <span class="n">foldercontent</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">savepath</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">"*"</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">foldercontent</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">savepath</span> <span class="o">=</span> <span class="n">savepath</span> <span class="o">/</span> <span class="n">filename</span>
                <span class="n">extractpath</span> <span class="o">=</span> <span class="n">download_and_extract</span><span class="p">(</span>
                    <span class="n">path</span><span class="p">,</span> <span class="n">savepath</span><span class="p">,</span> <span class="n">progressbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">extractpath</span> <span class="o">=</span> <span class="n">savepath</span>
            <span class="n">extractpath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">extractpath</span><span class="p">)</span>

            <span class="c1"># count folders in savepath</span>
            <span class="n">nfolders</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">extractpath</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">"*"</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()])</span>
            <span class="n">nobjects</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">extractpath</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">"*"</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()])</span>
            <span class="k">if</span> <span class="n">nobjects</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">nfolders</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">extractpath</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">extractpath</span> <span class="o">/</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">extractpath</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">"*"</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()][</span><span class="mi">0</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">extractpath</span>
        <span class="k">elif</span> <span class="n">databackend</span> <span class="o">==</span> <span class="s2">"testdata"</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">get_testdata</span><span class="p">(</span><span class="n">dataname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># potentially custom dataset.</span>
            <span class="n">resources</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"resources"</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="n">databackend</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">resources</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Unknown resource '</span><span class="si">%s</span><span class="s2">'"</span> <span class="o">%</span> <span class="n">databackend</span><span class="p">)</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">resources</span><span class="p">[</span><span class="n">databackend</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">dataname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">"Unknown dataset '</span><span class="si">%s</span><span class="s2">' in resource '</span><span class="si">%s</span><span class="s2">'"</span> <span class="o">%</span> <span class="p">(</span><span class="n">dataname</span><span class="p">,</span> <span class="n">databackend</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">dataname</span><span class="p">][</span><span class="s2">"path"</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s2">"datafolders"</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">"datafolders"</span><span class="p">]:</span>
                <span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">path</span><span class="p">)):</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Specified path '</span><span class="si">%s</span><span class="s2">' unknown."</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">path</span>
</code></pre></div>
        </details>
    </div>

  </div>




  <div class="doc doc-object doc-function">



<h3 id="scida.convenience.get_dataset_by_name" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_dataset_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Get dataset name from alias or name found in the configuration files.
Parameters</p>
<hr>
<div class="admonition name">
<p class="admonition-title">str</p>
<p>Name or alias of dataset.</p>
</div>
<h5 id="scida.convenience.get_dataset_by_name--returns">Returns</h5>
<p>str</p>

        <details class="quote">
          <summary>Source code in <code>scida/convenience.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_dataset_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Get dataset name from alias or name found in the configuration files.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name: str</span>
<span class="sd">        Name or alias of dataset.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">    """</span>
    <span class="n">dname</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>
    <span class="k">if</span> <span class="s2">"datasets"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dname</span>
    <span class="n">datasets</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s2">"datasets"</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">:</span>
        <span class="n">dname</span> <span class="o">=</span> <span class="n">name</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># could still be an alias</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">datasets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">"aliases"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">v</span><span class="p">[</span><span class="s2">"aliases"</span><span class="p">]:</span>
                <span class="n">dname</span> <span class="o">=</span> <span class="n">k</span>
                <span class="k">break</span>
    <span class="k">return</span> <span class="n">dname</span>
</code></pre></div>
        </details>
    </div>

  </div>





  <div class="doc doc-object doc-function">



<h3 id="scida.convenience.get_testdata" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_testdata</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Get path to test data identifier.
Parameters</p>
<hr>
<div class="admonition name">
<p class="admonition-title">str</p>
<p>Name of test data.</p>
</div>
<h5 id="scida.convenience.get_testdata--returns">Returns</h5>
<p>str</p>

        <details class="quote">
          <summary>Source code in <code>scida/convenience.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_testdata</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Get path to test data identifier.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name: str</span>
<span class="sd">        Name of test data.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">    """</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>
    <span class="n">tdpath</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"testdata_path"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tdpath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Test data directory not specified in configuration"</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">tdpath</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Invalid test data path"</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="n">f</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tdpath</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">tdpath</span><span class="p">)}</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Specified test data not available."</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</code></pre></div>
        </details>
    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="scida.customs" class="doc doc-heading">
        <code>customs</code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h2>

    <div class="doc doc-contents ">




  <div class="doc doc-children">










  <div class="doc doc-object doc-module">



<h3 id="scida.customs.arepo" class="doc doc-heading">
        <code>arepo</code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h3>

    <div class="doc doc-contents ">




  <div class="doc doc-children">










  <div class="doc doc-object doc-module">



<h4 id="scida.customs.arepo.MTNG" class="doc doc-heading">
        <code>MTNG</code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h4>

    <div class="doc doc-contents ">




  <div class="doc doc-children">










  <div class="doc doc-object doc-module">



<h5 id="scida.customs.arepo.MTNG.dataset" class="doc doc-heading">
        <code>dataset</code>



</h5>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h6 id="scida.customs.arepo.MTNG.dataset.MTNGArepoCatalog" class="doc doc-heading">
        <code>
MTNGArepoCatalog            (<a class="autorefs autorefs-internal" title="scida.customs.arepo.dataset.ArepoCatalog" href="#scida.customs.arepo.dataset.ArepoCatalog">ArepoCatalog</a>)
        </code>



</h6>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>scida/customs/arepo/MTNG/dataset.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MTNGArepoCatalog</span><span class="p">(</span><span class="n">ArepoCatalog</span><span class="p">):</span>
    <span class="n">_fileprefix</span> <span class="o">=</span> <span class="s2">"fof_subhalo_tab"</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">"iscatalog"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="s2">"fileprefix"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">"fileprefix"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"fof_subhalo_tab"</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">"choose_prefix"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">validate_path</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CandidateStatus</span><span class="p">:</span>
        <span class="n">tkwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fileprefix</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">_fileprefix</span><span class="p">)</span>
        <span class="n">tkwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">validate_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">tkwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">valid</span> <span class="o">==</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">NO</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">valid</span>
        <span class="n">metadata_raw</span> <span class="o">=</span> <span class="n">load_metadata</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">tkwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">"/Config"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metadata_raw</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">NO</span>
        <span class="k">if</span> <span class="s2">"MTNG"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metadata_raw</span><span class="p">[</span><span class="s2">"/Config"</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">NO</span>
        <span class="k">return</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">YES</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h7 id="scida.customs.arepo.MTNG.dataset.MTNGArepoCatalog.validate_path" class="doc doc-heading">
<code class="highlight language-python"><span class="n">validate_path</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CandidateStatus</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-classmethod"><code>classmethod</code></small>
  </span>

</h7>

    <div class="doc doc-contents ">

      <p>Check if path is valid for this interface.
Parameters</p>
<hr>
<div class="admonition path">
<p class="admonition-title">str, os.PathLike</p>
<p>path to check</p>
</div>
<p>args
kwargs</p>
<h6 id="scida.customs.arepo.MTNG.dataset.MTNGArepoCatalog.validate_path--returns">Returns</h6>
<p>bool</p>

        <details class="quote">
          <summary>Source code in <code>scida/customs/arepo/MTNG/dataset.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">validate_path</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CandidateStatus</span><span class="p">:</span>
    <span class="n">tkwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fileprefix</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">_fileprefix</span><span class="p">)</span>
    <span class="n">tkwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">valid</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">validate_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">tkwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">valid</span> <span class="o">==</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">NO</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">valid</span>
    <span class="n">metadata_raw</span> <span class="o">=</span> <span class="n">load_metadata</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">tkwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">"/Config"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metadata_raw</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">NO</span>
    <span class="k">if</span> <span class="s2">"MTNG"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metadata_raw</span><span class="p">[</span><span class="s2">"/Config"</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">NO</span>
    <span class="k">return</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">YES</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h6 id="scida.customs.arepo.MTNG.dataset.MTNGArepoSnapshot" class="doc doc-heading">
        <code>
MTNGArepoSnapshot            (<a class="autorefs autorefs-internal" title="scida.customs.arepo.dataset.ArepoSnapshot" href="#scida.customs.arepo.dataset.ArepoSnapshot">ArepoSnapshot</a>)
        </code>



</h6>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>scida/customs/arepo/MTNG/dataset.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MTNGArepoSnapshot</span><span class="p">(</span><span class="n">ArepoSnapshot</span><span class="p">):</span>
    <span class="n">_fileprefix_catalog</span> <span class="o">=</span> <span class="s2">"fof_subhalo_tab"</span>
    <span class="n">_fileprefix</span> <span class="o">=</span> <span class="s2">"snapshot_"</span>  <span class="c1"># underscore is important!</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="s2">"auto"</span><span class="p">,</span> <span class="n">catalog</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tkwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">fileprefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fileprefix</span><span class="p">,</span>
            <span class="n">fileprefix_catalog</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_fileprefix_catalog</span><span class="p">,</span>
            <span class="n">catalog_cls</span><span class="o">=</span><span class="n">MTNGArepoCatalog</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">tkwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># in MTNG, we have two kinds of snapshots:</span>
        <span class="c1"># 1. regular (prefix: "snapshot_"), contains all particle types</span>
        <span class="c1"># 2. mostbound (prefix: "snapshot-prevmostboundonly_"), only contains DM particles</span>
        <span class="c1"># Most snapshots are of type 2, but some selected snapshots have type 1 and type 2.</span>

        <span class="c1"># attempt to load regular snapshot</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="n">chunksize</span><span class="p">,</span> <span class="n">catalog</span><span class="o">=</span><span class="n">catalog</span><span class="p">,</span> <span class="o">**</span><span class="n">tkwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">tkwargs</span><span class="p">[</span><span class="s2">"fileprefix"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"snapshot-prevmostboundonly_"</span><span class="p">:</span>
            <span class="c1"># this is a mostbound snapshot, so we are done</span>
            <span class="k">return</span>

        <span class="c1"># next, attempt to load mostbound snapshot. This is done by loading into sub-object.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mostbound</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">tkwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fileprefix</span><span class="o">=</span><span class="s2">"snapshot-prevmostboundonly_"</span><span class="p">,</span> <span class="n">catalog</span><span class="o">=</span><span class="s2">"none"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mostbound</span> <span class="o">=</span> <span class="n">MTNGArepoSnapshot</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="n">chunksize</span><span class="p">,</span> <span class="o">**</span><span class="n">tkwargs</span><span class="p">)</span>
        <span class="c1"># hacky: remove unused containers from mostbound snapshot</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">"PartType0"</span><span class="p">,</span>
            <span class="s2">"PartType2"</span><span class="p">,</span>
            <span class="s2">"PartType3"</span><span class="p">,</span>
            <span class="s2">"PartType4"</span><span class="p">,</span>
            <span class="s2">"PartType5"</span><span class="p">,</span>
            <span class="s2">"Group"</span><span class="p">,</span>
            <span class="s2">"Subhalo"</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mostbound</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">mostbound</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">merge_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mostbound</span><span class="p">,</span> <span class="n">fieldname_suffix</span><span class="o">=</span><span class="s2">"_mostbound"</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">validate_path</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CandidateStatus</span><span class="p">:</span>
        <span class="n">tkwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">fileprefix</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">_fileprefix</span><span class="p">,</span> <span class="n">fileprefix_catalog</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">_fileprefix_catalog</span>
        <span class="p">)</span>
        <span class="n">tkwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">validate_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">tkwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">NO</span>
            <span class="c1"># might raise ValueError in case of partial snap</span>

        <span class="k">if</span> <span class="n">valid</span> <span class="o">==</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">NO</span><span class="p">:</span>
            <span class="c1"># check for partial snap</span>
            <span class="n">tkwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fileprefix</span><span class="o">=</span><span class="s2">"snapshot-prevmostboundonly_"</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">valid</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">validate_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">tkwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">valid</span> <span class="o">=</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">NO</span>

        <span class="k">if</span> <span class="n">valid</span> <span class="o">==</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">NO</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">valid</span>
        <span class="n">metadata_raw</span> <span class="o">=</span> <span class="n">load_metadata</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">tkwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">"/Config"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metadata_raw</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">NO</span>
        <span class="k">if</span> <span class="s2">"MTNG"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metadata_raw</span><span class="p">[</span><span class="s2">"/Config"</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">NO</span>
        <span class="k">if</span> <span class="s2">"Ngroups_Total"</span> <span class="ow">in</span> <span class="n">metadata_raw</span><span class="p">[</span><span class="s2">"/Header"</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">NO</span>  <span class="c1"># this is a catalog</span>
        <span class="k">return</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">YES</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h7 id="scida.customs.arepo.MTNG.dataset.MTNGArepoSnapshot.validate_path" class="doc doc-heading">
<code class="highlight language-python"><span class="n">validate_path</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CandidateStatus</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-classmethod"><code>classmethod</code></small>
  </span>

</h7>

    <div class="doc doc-contents ">

      <p>Check if path is valid for this interface.
Parameters</p>
<hr>
<div class="admonition path">
<p class="admonition-title">str, os.PathLike</p>
<p>path to check</p>
</div>
<p>args
kwargs</p>
<h6 id="scida.customs.arepo.MTNG.dataset.MTNGArepoSnapshot.validate_path--returns">Returns</h6>
<p>bool</p>

        <details class="quote">
          <summary>Source code in <code>scida/customs/arepo/MTNG/dataset.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">validate_path</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CandidateStatus</span><span class="p">:</span>
    <span class="n">tkwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">fileprefix</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">_fileprefix</span><span class="p">,</span> <span class="n">fileprefix_catalog</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">_fileprefix_catalog</span>
    <span class="p">)</span>
    <span class="n">tkwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">validate_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">tkwargs</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">NO</span>
        <span class="c1"># might raise ValueError in case of partial snap</span>

    <span class="k">if</span> <span class="n">valid</span> <span class="o">==</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">NO</span><span class="p">:</span>
        <span class="c1"># check for partial snap</span>
        <span class="n">tkwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fileprefix</span><span class="o">=</span><span class="s2">"snapshot-prevmostboundonly_"</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">validate_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">tkwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">NO</span>

    <span class="k">if</span> <span class="n">valid</span> <span class="o">==</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">NO</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">valid</span>
    <span class="n">metadata_raw</span> <span class="o">=</span> <span class="n">load_metadata</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">tkwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">"/Config"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metadata_raw</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">NO</span>
    <span class="k">if</span> <span class="s2">"MTNG"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metadata_raw</span><span class="p">[</span><span class="s2">"/Config"</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">NO</span>
    <span class="k">if</span> <span class="s2">"Ngroups_Total"</span> <span class="ow">in</span> <span class="n">metadata_raw</span><span class="p">[</span><span class="s2">"/Header"</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">NO</span>  <span class="c1"># this is a catalog</span>
    <span class="k">return</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">YES</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>




  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h4 id="scida.customs.arepo.TNGcluster" class="doc doc-heading">
        <code>TNGcluster</code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h4>

    <div class="doc doc-contents ">




  <div class="doc doc-children">










  <div class="doc doc-object doc-module">



<h5 id="scida.customs.arepo.TNGcluster.dataset" class="doc doc-heading">
        <code>dataset</code>



</h5>

    <div class="doc doc-contents ">




  <div class="doc doc-children">








  <div class="doc doc-object doc-class">



<h6 id="scida.customs.arepo.TNGcluster.dataset.TNGClusterSnapshot" class="doc doc-heading">
        <code>
TNGClusterSnapshot            (<a class="autorefs autorefs-internal" title="scida.customs.arepo.dataset.ArepoSnapshot" href="#scida.customs.arepo.dataset.ArepoSnapshot">ArepoSnapshot</a>)
        </code>



</h6>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>scida/customs/arepo/TNGcluster/dataset.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">TNGClusterSnapshot</span><span class="p">(</span><span class="n">ArepoSnapshot</span><span class="p">):</span>
    <span class="n">_fileprefix_catalog</span> <span class="o">=</span> <span class="s2">"fof_subhalo_tab_"</span>
    <span class="n">_fileprefix</span> <span class="o">=</span> <span class="s2">"snap_"</span>
    <span class="n">ntargets</span> <span class="o">=</span> <span class="mi">352</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># we can get the offsets from the header as our load routine concats the various values from different files</span>
        <span class="c1"># these offsets can be used to select a given halo.</span>
        <span class="c1"># see: https://tng-project.org/w/index.php/TNG-Cluster</span>
        <span class="c1"># each zoom-target has two entries i and i+N, where N=352 is the number of zoom targets.</span>
        <span class="c1"># the first file contains the particles that were contained in the original low-res run</span>
        <span class="c1"># the second file contains all other remaining particles in a given zoom target</span>
        <span class="k">def</span> <span class="nf">len_to_offsets</span><span class="p">(</span><span class="n">lengths</span><span class="p">):</span>
            <span class="n">lengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span>
            <span class="n">shp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lengths</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">lengths</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">shp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">lengths</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">))]</span>
                <span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span> <span class="n">lengths</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)]),</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">res</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lengths_zoom</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">particles</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">"NumPart_ThisFile"</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offsets_zoom</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">particles</span><span class="o">=</span><span class="n">len_to_offsets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lengths_zoom</span><span class="p">[</span><span class="s2">"particles"</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"catalog"</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lengths_zoom</span><span class="p">[</span><span class="s2">"groups"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">"Ngroups_ThisFile"</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">offsets_zoom</span><span class="p">[</span><span class="s2">"groups"</span><span class="p">]</span> <span class="o">=</span> <span class="n">len_to_offsets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lengths_zoom</span><span class="p">[</span><span class="s2">"groups"</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lengths_zoom</span><span class="p">[</span><span class="s2">"subgroups"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">"Nsubgroups_ThisFile"</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">offsets_zoom</span><span class="p">[</span><span class="s2">"subgroups"</span><span class="p">]</span> <span class="o">=</span> <span class="n">len_to_offsets</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lengths_zoom</span><span class="p">[</span><span class="s2">"subgroups"</span><span class="p">]</span>
            <span class="p">)</span>

    <span class="nd">@TNGClusterSelector</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">return_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">return_data</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">validate_path</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CandidateStatus</span><span class="p">:</span>
        <span class="n">tkwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">fileprefix</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">_fileprefix</span><span class="p">,</span> <span class="n">fileprefix_catalog</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">_fileprefix_catalog</span>
        <span class="p">)</span>
        <span class="n">tkwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">validate_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">tkwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">valid</span> <span class="o">==</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">NO</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">valid</span>
        <span class="n">metadata_raw</span> <span class="o">=</span> <span class="n">load_metadata</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">tkwargs</span><span class="p">)</span>

        <span class="n">matchingattrs</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">parameters</span> <span class="o">=</span> <span class="n">metadata_raw</span><span class="p">[</span><span class="s2">"/Parameters"</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">"InitCondFile"</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
            <span class="n">matchingattrs</span> <span class="o">&amp;=</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">"InitCondFile"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"various"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">NO</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">metadata_raw</span><span class="p">[</span><span class="s2">"/Header"</span><span class="p">]</span>
        <span class="n">matchingattrs</span> <span class="o">&amp;=</span> <span class="n">header</span><span class="p">[</span><span class="s2">"BoxSize"</span><span class="p">]</span> <span class="o">==</span> <span class="mf">680000.0</span>
        <span class="n">matchingattrs</span> <span class="o">&amp;=</span> <span class="n">header</span><span class="p">[</span><span class="s2">"NumPart_Total"</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1944529344</span>
        <span class="n">matchingattrs</span> <span class="o">&amp;=</span> <span class="n">header</span><span class="p">[</span><span class="s2">"NumPart_Total"</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">586952200</span>

        <span class="k">if</span> <span class="n">matchingattrs</span><span class="p">:</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">YES</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">NO</span>
        <span class="k">return</span> <span class="n">valid</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">












  <div class="doc doc-object doc-method">



<h7 id="scida.customs.arepo.TNGcluster.dataset.TNGClusterSnapshot.validate_path" class="doc doc-heading">
<code class="highlight language-python"><span class="n">validate_path</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CandidateStatus</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-classmethod"><code>classmethod</code></small>
  </span>

</h7>

    <div class="doc doc-contents ">

      <p>Check if path is valid for this interface.
Parameters</p>
<hr>
<div class="admonition path">
<p class="admonition-title">str, os.PathLike</p>
<p>path to check</p>
</div>
<p>args
kwargs</p>
<h6 id="scida.customs.arepo.TNGcluster.dataset.TNGClusterSnapshot.validate_path--returns">Returns</h6>
<p>bool</p>

        <details class="quote">
          <summary>Source code in <code>scida/customs/arepo/TNGcluster/dataset.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">validate_path</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CandidateStatus</span><span class="p">:</span>
    <span class="n">tkwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">fileprefix</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">_fileprefix</span><span class="p">,</span> <span class="n">fileprefix_catalog</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">_fileprefix_catalog</span>
    <span class="p">)</span>
    <span class="n">tkwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">valid</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">validate_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">tkwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">valid</span> <span class="o">==</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">NO</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">valid</span>
    <span class="n">metadata_raw</span> <span class="o">=</span> <span class="n">load_metadata</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">tkwargs</span><span class="p">)</span>

    <span class="n">matchingattrs</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">parameters</span> <span class="o">=</span> <span class="n">metadata_raw</span><span class="p">[</span><span class="s2">"/Parameters"</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">"InitCondFile"</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
        <span class="n">matchingattrs</span> <span class="o">&amp;=</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">"InitCondFile"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"various"</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">NO</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">metadata_raw</span><span class="p">[</span><span class="s2">"/Header"</span><span class="p">]</span>
    <span class="n">matchingattrs</span> <span class="o">&amp;=</span> <span class="n">header</span><span class="p">[</span><span class="s2">"BoxSize"</span><span class="p">]</span> <span class="o">==</span> <span class="mf">680000.0</span>
    <span class="n">matchingattrs</span> <span class="o">&amp;=</span> <span class="n">header</span><span class="p">[</span><span class="s2">"NumPart_Total"</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1944529344</span>
    <span class="n">matchingattrs</span> <span class="o">&amp;=</span> <span class="n">header</span><span class="p">[</span><span class="s2">"NumPart_Total"</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">586952200</span>

    <span class="k">if</span> <span class="n">matchingattrs</span><span class="p">:</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">YES</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">NO</span>
    <span class="k">return</span> <span class="n">valid</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>




  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h4 id="scida.customs.arepo.dataset" class="doc doc-heading">
        <code>dataset</code>



</h4>

    <div class="doc doc-contents ">




  <div class="doc doc-children">










  <div class="doc doc-object doc-class">



<h5 id="scida.customs.arepo.dataset.ArepoCatalog" class="doc doc-heading">
        <code>
ArepoCatalog            (<a class="autorefs autorefs-internal" title="scida.customs.arepo.dataset.ArepoSnapshot" href="#scida.customs.arepo.dataset.ArepoSnapshot">ArepoSnapshot</a>)
        </code>



</h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>scida/customs/arepo/dataset.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ArepoCatalog</span><span class="p">(</span><span class="n">ArepoSnapshot</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">"iscatalog"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="s2">"fileprefix"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">"fileprefix"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"groups"</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">validate_path</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CandidateStatus</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">"fileprefix"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_fileprefix</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">validate_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">expect_grp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">valid</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h6 id="scida.customs.arepo.dataset.ArepoCatalog.validate_path" class="doc doc-heading">
<code class="highlight language-python"><span class="n">validate_path</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CandidateStatus</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-classmethod"><code>classmethod</code></small>
  </span>

</h6>

    <div class="doc doc-contents ">

      <p>Check if path is valid for this interface.
Parameters</p>
<hr>
<div class="admonition path">
<p class="admonition-title">str, os.PathLike</p>
<p>path to check</p>
</div>
<p>args
kwargs</p>
<h6 id="scida.customs.arepo.dataset.ArepoCatalog.validate_path--returns">Returns</h6>
<p>bool</p>

        <details class="quote">
          <summary>Source code in <code>scida/customs/arepo/dataset.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">validate_path</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CandidateStatus</span><span class="p">:</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s2">"fileprefix"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_fileprefix</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">valid</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">validate_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">expect_grp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">valid</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h5 id="scida.customs.arepo.dataset.ArepoSnapshot" class="doc doc-heading">
        <code>
ArepoSnapshot            (<span title="scida.interfaces.mixins.spatial.SpatialCartesian3DMixin">SpatialCartesian3DMixin</span>, <a class="autorefs autorefs-internal" title="scida.customs.gadgetstyle.dataset.GadgetStyleSnapshot" href="#scida.customs.gadgetstyle.dataset.GadgetStyleSnapshot">GadgetStyleSnapshot</a>)
        </code>



</h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>scida/customs/arepo/dataset.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ArepoSnapshot</span><span class="p">(</span><span class="n">SpatialCartesian3DMixin</span><span class="p">,</span> <span class="n">GadgetStyleSnapshot</span><span class="p">):</span>
    <span class="n">_fileprefix_catalog</span> <span class="o">=</span> <span class="s2">"groups"</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="s2">"auto"</span><span class="p">,</span> <span class="n">catalog</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iscatalog</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"iscatalog"</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_defaultunitfiles</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"units/gadget_cosmological.yaml"</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_grouplengths</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subhalolengths</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># not needed for group catalogs as entries are back-to-back there, we will provide a property for this</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subhalooffsets</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">misc</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># for storing misc info</span>
        <span class="n">prfx</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"fileprefix"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prfx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prfx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fileprefix</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="n">chunksize</span><span class="p">,</span> <span class="n">fileprefix</span><span class="o">=</span><span class="n">prfx</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span> <span class="o">=</span> <span class="n">catalog</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">iscatalog</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">discover_catalog</span><span class="p">()</span>
                <span class="c1"># try to discover group catalog in parent directories.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span> <span class="o">==</span> <span class="s2">"none"</span><span class="p">:</span>
                <span class="k">pass</span>  <span class="c1"># this string can be set to explicitly disable catalog</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">:</span>
                <span class="n">catalog_cls</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"catalog_cls"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">load_catalog</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">catalog_cls</span><span class="o">=</span><span class="n">catalog_cls</span><span class="p">)</span>

        <span class="c1"># add aliases</span>
        <span class="n">aliases</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">PartType0</span><span class="o">=</span><span class="p">[</span><span class="s2">"gas"</span><span class="p">,</span> <span class="s2">"baryons"</span><span class="p">],</span>
            <span class="n">PartType1</span><span class="o">=</span><span class="p">[</span><span class="s2">"dm"</span><span class="p">,</span> <span class="s2">"dark matter"</span><span class="p">],</span>
            <span class="n">PartType2</span><span class="o">=</span><span class="p">[</span><span class="s2">"lowres"</span><span class="p">,</span> <span class="s2">"lowres dm"</span><span class="p">],</span>
            <span class="n">PartType3</span><span class="o">=</span><span class="p">[</span><span class="s2">"tracer"</span><span class="p">,</span> <span class="s2">"tracers"</span><span class="p">],</span>
            <span class="n">PartType4</span><span class="o">=</span><span class="p">[</span><span class="s2">"stars"</span><span class="p">],</span>
            <span class="n">PartType5</span><span class="o">=</span><span class="p">[</span><span class="s2">"bh"</span><span class="p">,</span> <span class="s2">"black holes"</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">lst</span> <span class="ow">in</span> <span class="n">aliases</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">add_alias</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>

        <span class="c1"># set metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_metadata</span><span class="p">()</span>

        <span class="c1"># add some default fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">fielddefs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load_catalog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">catalog_cls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">virtualcache</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># copy catalog for better performance</span>
        <span class="n">catalog_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"catalog_kwargs"</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">catalog_kwargs</span><span class="p">[</span><span class="s2">"overwritecache"</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"overwritecache"</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># fileprefix = catalog_kwargs.get("fileprefix", self._fileprefix_catalog)</span>
        <span class="n">prfx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fileprefix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">)</span>

        <span class="c1"># explicitly need to create unitaware class for catalog as needed</span>
        <span class="c1"># TODO: should just be determined from mixins of parent?</span>
        <span class="k">if</span> <span class="n">catalog_cls</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="n">ArepoCatalog</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="n">catalog_cls</span>
        <span class="n">withunits</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"units"</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">mixins</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">withunits</span><span class="p">:</span>
            <span class="n">mixins</span> <span class="o">+=</span> <span class="p">[</span><span class="n">UnitMixin</span><span class="p">]</span>

        <span class="n">other_mixins</span> <span class="o">=</span> <span class="n">_determine_mixins</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="n">mixins</span> <span class="o">+=</span> <span class="n">other_mixins</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="n">create_MixinDataset</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">mixins</span><span class="p">)</span>

        <span class="n">ureg</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"ureg"</span><span class="p">):</span>
            <span class="n">ureg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ureg</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">,</span>
            <span class="n">virtualcache</span><span class="o">=</span><span class="n">virtualcache</span><span class="p">,</span>
            <span class="n">fileprefix</span><span class="o">=</span><span class="n">prfx</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">withunits</span><span class="p">,</span>
            <span class="n">ureg</span><span class="o">=</span><span class="n">ureg</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="s2">"Redshift"</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">header</span> <span class="ow">and</span> <span class="s2">"Redshift"</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
            <span class="n">z_catalog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">"Redshift"</span><span class="p">]</span>
            <span class="n">z_snap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">"Redshift"</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">z_catalog</span><span class="p">,</span> <span class="n">z_snap</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">"Redshift mismatch between snapshot and catalog: "</span>
                    <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">z_snap</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">z_catalog</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">"</span>
                <span class="p">)</span>

        <span class="c1"># merge data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">merge_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">)</span>

        <span class="c1"># first snapshots often do not have groups</span>
        <span class="k">if</span> <span class="s2">"Group"</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="n">ngkeys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"Group"</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ngkeys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_catalogIDs</span><span class="p">()</span>

        <span class="c1"># merge hints from snap and catalog</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">merge_hints</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">validate_path</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CandidateStatus</span><span class="p">:</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">validate_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">valid</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">MAYBE</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">MAYBE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">valid</span>
        <span class="c1"># Arepo has no dedicated attribute to identify such runs.</span>
        <span class="c1"># lets just query a bunch of attributes that are present for arepo runs</span>
        <span class="n">metadata_raw</span> <span class="o">=</span> <span class="n">load_metadata</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">matchingattrs</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">matchingattrs</span> <span class="o">&amp;=</span> <span class="s2">"Git_commit"</span> <span class="ow">in</span> <span class="n">metadata_raw</span><span class="p">[</span><span class="s2">"/Header"</span><span class="p">]</span>
        <span class="c1"># not existent for any arepo run?</span>
        <span class="n">matchingattrs</span> <span class="o">&amp;=</span> <span class="s2">"Compactify_Version"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metadata_raw</span><span class="p">[</span><span class="s2">"/Header"</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">matchingattrs</span><span class="p">:</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">MAYBE</span>

        <span class="k">return</span> <span class="n">valid</span>

    <span class="nd">@ArepoSelector</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">return_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Return data.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        """</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">return_data</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">discover_catalog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Discover the group catalog given the current path</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        """</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="c1"># order of candidates matters. For Illustris "groups" must precede "fof_subhalo_tab"</span>
        <span class="n">candidates</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">p</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"snapshot"</span><span class="p">,</span> <span class="s2">"group"</span><span class="p">),</span>
            <span class="n">p</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"snapshot"</span><span class="p">,</span> <span class="s2">"groups"</span><span class="p">),</span>
            <span class="n">p</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"snapdir"</span><span class="p">,</span> <span class="s2">"groups"</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"snap"</span><span class="p">,</span> <span class="s2">"groups"</span><span class="p">),</span>
            <span class="n">p</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"snapdir"</span><span class="p">,</span> <span class="s2">"groups"</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"snap"</span><span class="p">,</span> <span class="s2">"fof_subhalo_tab"</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">candidate</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">candidate</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span> <span class="o">=</span> <span class="n">candidate</span>
            <span class="k">break</span>

    <span class="k">def</span> <span class="nf">register_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parttype</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">construct</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Register a field.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        parttype: str</span>
<span class="sd">            name of particle type</span>
<span class="sd">        name: str</span>
<span class="sd">            name of field</span>
<span class="sd">        construct: bool</span>
<span class="sd">            construct field immediately</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        """</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">part_type_num</span><span class="p">(</span><span class="n">parttype</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">construct</span><span class="p">:</span>  <span class="c1"># TODO: introduce (immediate) construct option later</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="k">if</span> <span class="n">num</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>  <span class="c1"># TODO: all particle species</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s2">"all"</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s2">"PartType"</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">parttype</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">register_field</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_catalogIDs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Add field for halo and subgroup IDs for all particle types.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        """</span>
        <span class="c1"># TODO: make these delayed objects and properly pass into (delayed?) numba functions:</span>
        <span class="c1"># https://docs.dask.org/en/stable/delayed-best-practices.html#avoid-repeatedly-putting-large-inputs-into-delayed-calls</span>

        <span class="n">maxint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">misc</span><span class="p">[</span><span class="s2">"unboundID"</span><span class="p">]</span> <span class="o">=</span> <span class="n">maxint</span>

        <span class="c1"># Group ID</span>
        <span class="k">if</span> <span class="s2">"Group"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>  <span class="c1"># can happen for empty catalogs</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"PartType"</span><span class="p">)):</span>
                    <span class="k">continue</span>
                <span class="n">uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">"uid"</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">"GroupID"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">misc</span><span class="p">[</span><span class="s2">"unboundID"</span><span class="p">]</span> <span class="o">*</span> <span class="n">da</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span>
                    <span class="n">uid</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">"SubhaloID"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">misc</span><span class="p">[</span><span class="s2">"unboundID"</span><span class="p">]</span> <span class="o">*</span> <span class="n">da</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span>
                    <span class="n">uid</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span>
                <span class="p">)</span>
            <span class="k">return</span>

        <span class="n">glen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"Group"</span><span class="p">][</span><span class="s2">"GroupLenType"</span><span class="p">]</span>
        <span class="n">ngrp</span> <span class="o">=</span> <span class="n">glen</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">da_halocelloffsets</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
                <span class="n">da</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">glen</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># remove last entry to match shapematch shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"Group"</span><span class="p">][</span><span class="s2">"GroupOffsetsType"</span><span class="p">]</span> <span class="o">=</span> <span class="n">da_halocelloffsets</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rechunk</span><span class="p">(</span>
            <span class="n">glen</span><span class="o">.</span><span class="n">chunks</span>
        <span class="p">)</span>
        <span class="n">halocelloffsets</span> <span class="o">=</span> <span class="n">da_halocelloffsets</span><span class="o">.</span><span class="n">rechunk</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">index_unbound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">misc</span><span class="p">[</span><span class="s2">"unboundID"</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"PartType"</span><span class="p">)):</span>
                <span class="k">continue</span>
            <span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="s2">"uid"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                <span class="k">continue</span>  <span class="c1"># can happen for empty containers</span>
            <span class="n">gidx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">"uid"</span><span class="p">]</span>
            <span class="n">hidx</span> <span class="o">=</span> <span class="n">compute_haloindex</span><span class="p">(</span>
                <span class="n">gidx</span><span class="p">,</span> <span class="n">halocelloffsets</span><span class="p">[:,</span> <span class="n">num</span><span class="p">],</span> <span class="n">index_unbound</span><span class="o">=</span><span class="n">index_unbound</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">"GroupID"</span><span class="p">]</span> <span class="o">=</span> <span class="n">hidx</span>

        <span class="c1"># Subhalo ID</span>
        <span class="k">if</span> <span class="s2">"Subhalo"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>  <span class="c1"># can happen for empty catalogs</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"PartType"</span><span class="p">)):</span>
                    <span class="k">continue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">"SubhaloID"</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">da</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span>
                    <span class="n">da</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">"uid"</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span>
                <span class="p">)</span>
            <span class="k">return</span>

        <span class="n">shnr_attr</span> <span class="o">=</span> <span class="s2">"SubhaloGrNr"</span>
        <span class="k">if</span> <span class="n">shnr_attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"Subhalo"</span><span class="p">]:</span>
            <span class="n">shnr_attr</span> <span class="o">=</span> <span class="s2">"SubhaloGroupNr"</span>  <span class="c1"># what MTNG does</span>
        <span class="k">if</span> <span class="n">shnr_attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"Subhalo"</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">"Could not find 'SubhaloGrNr' or 'SubhaloGroupNr' in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="si">}</span><span class="s2">"</span>
            <span class="p">)</span>

        <span class="n">subhalogrnr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"Subhalo"</span><span class="p">][</span><span class="n">shnr_attr</span><span class="p">]</span>
        <span class="n">subhalocellcounts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"Subhalo"</span><span class="p">][</span><span class="s2">"SubhaloLenType"</span><span class="p">]</span>

        <span class="c1"># remove "units" for numba funcs</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">subhalogrnr</span><span class="p">,</span> <span class="s2">"magnitude"</span><span class="p">):</span>
            <span class="n">subhalogrnr</span> <span class="o">=</span> <span class="n">subhalogrnr</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">subhalocellcounts</span><span class="p">,</span> <span class="s2">"magnitude"</span><span class="p">):</span>
            <span class="n">subhalocellcounts</span> <span class="o">=</span> <span class="n">subhalocellcounts</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="n">grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"Group"</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">"GroupFirstSub"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">grp</span> <span class="ow">or</span> <span class="s2">"GroupNsubs"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">grp</span><span class="p">:</span>
            <span class="c1"># if not provided, we calculate:</span>
            <span class="c1"># "GroupFirstSub": First subhalo index for each halo</span>
            <span class="c1"># "GroupNsubs": Number of subhalos for each halo</span>
            <span class="n">dlyd</span> <span class="o">=</span> <span class="n">delayed</span><span class="p">(</span><span class="n">get_shcounts_shcells</span><span class="p">)(</span><span class="n">subhalogrnr</span><span class="p">,</span> <span class="n">ngrp</span><span class="p">)</span>
            <span class="n">grp</span><span class="p">[</span><span class="s2">"GroupFirstSub"</span><span class="p">]</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">dlyd</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">grp</span><span class="p">[</span><span class="s2">"GroupNsubs"</span><span class="p">]</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">dlyd</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># remove "units" for numba funcs</span>
        <span class="n">grpfirstsub</span> <span class="o">=</span> <span class="n">grp</span><span class="p">[</span><span class="s2">"GroupFirstSub"</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">grpfirstsub</span><span class="p">,</span> <span class="s2">"magnitude"</span><span class="p">):</span>
            <span class="n">grpfirstsub</span> <span class="o">=</span> <span class="n">grpfirstsub</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="n">grpnsubs</span> <span class="o">=</span> <span class="n">grp</span><span class="p">[</span><span class="s2">"GroupNsubs"</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">grpnsubs</span><span class="p">,</span> <span class="s2">"magnitude"</span><span class="p">):</span>
            <span class="n">grpnsubs</span> <span class="o">=</span> <span class="n">grpnsubs</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"PartType"</span><span class="p">)):</span>
                <span class="k">continue</span>
            <span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">pdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">"uid"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                <span class="k">continue</span>  <span class="c1"># can happen for empty containers</span>
            <span class="n">gidx</span> <span class="o">=</span> <span class="n">pdata</span><span class="p">[</span><span class="s2">"uid"</span><span class="p">]</span>

            <span class="c1"># we need to make other dask arrays delayed,</span>
            <span class="c1"># map_block does not incorrectly infer output shape from these</span>
            <span class="n">halocelloffsets_dlyd</span> <span class="o">=</span> <span class="n">delayed</span><span class="p">(</span><span class="n">halocelloffsets</span><span class="p">[:,</span> <span class="n">num</span><span class="p">])</span>
            <span class="n">grpfirstsub_dlyd</span> <span class="o">=</span> <span class="n">delayed</span><span class="p">(</span><span class="n">grpfirstsub</span><span class="p">)</span>
            <span class="n">grpnsubs_dlyd</span> <span class="o">=</span> <span class="n">delayed</span><span class="p">(</span><span class="n">grpnsubs</span><span class="p">)</span>
            <span class="n">subhalocellcounts_dlyd</span> <span class="o">=</span> <span class="n">delayed</span><span class="p">(</span><span class="n">subhalocellcounts</span><span class="p">[:,</span> <span class="n">num</span><span class="p">])</span>

            <span class="n">sidx</span> <span class="o">=</span> <span class="n">compute_localsubhaloindex</span><span class="p">(</span>
                <span class="n">gidx</span><span class="p">,</span>
                <span class="n">halocelloffsets_dlyd</span><span class="p">,</span>
                <span class="n">grpfirstsub_dlyd</span><span class="p">,</span>
                <span class="n">grpnsubs_dlyd</span><span class="p">,</span>
                <span class="n">subhalocellcounts_dlyd</span><span class="p">,</span>
                <span class="n">index_unbound</span><span class="o">=</span><span class="n">index_unbound</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">pdata</span><span class="p">[</span><span class="s2">"LocalSubhaloID"</span><span class="p">]</span> <span class="o">=</span> <span class="n">sidx</span>

            <span class="c1"># reconstruct SubhaloID from Group's GroupFirstSub and LocalSubhaloID</span>
            <span class="c1"># should be easier to do it directly, but quicker to write down like this:</span>

            <span class="c1"># calculate first subhalo of each halo that a particle belongs to</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_groupquantity_to_particles</span><span class="p">(</span><span class="s2">"GroupFirstSub"</span><span class="p">,</span> <span class="n">parttype</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
            <span class="n">pdata</span><span class="p">[</span><span class="s2">"SubhaloID"</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdata</span><span class="p">[</span><span class="s2">"GroupFirstSub"</span><span class="p">]</span> <span class="o">+</span> <span class="n">pdata</span><span class="p">[</span><span class="s2">"LocalSubhaloID"</span><span class="p">]</span>
            <span class="n">pdata</span><span class="p">[</span><span class="s2">"SubhaloID"</span><span class="p">]</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">pdata</span><span class="p">[</span><span class="s2">"SubhaloID"</span><span class="p">]</span> <span class="o">==</span> <span class="n">index_unbound</span><span class="p">,</span> <span class="n">index_unbound</span><span class="p">,</span> <span class="n">pdata</span><span class="p">[</span><span class="s2">"SubhaloID"</span><span class="p">]</span>
            <span class="p">)</span>

    <span class="nd">@computedecorator</span>
    <span class="k">def</span> <span class="nf">map_group_operation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">func</span><span class="p">,</span>
        <span class="n">cpucost_halo</span><span class="o">=</span><span class="mf">1e4</span><span class="p">,</span>
        <span class="n">nchunks_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">chunksize_bytes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">nmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">idxlist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">objtype</span><span class="o">=</span><span class="s2">"halo"</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Apply a function to each halo in the catalog.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        objtype: str</span>
<span class="sd">            Type of object to process. Can be "halo" or "subhalo". Default: "halo"</span>
<span class="sd">        idxlist: Optional[np.ndarray]</span>
<span class="sd">            List of halo indices to process. If not provided, all halos are processed.</span>
<span class="sd">        func: function</span>
<span class="sd">            Function to apply to each halo. Must take a dictionary of arrays as input.</span>
<span class="sd">        cpucost_halo:</span>
<span class="sd">            "CPU cost" of processing a single halo. This is a relative value to the processing time per input particle</span>
<span class="sd">            used for calculating the dask chunks. Default: 1e4</span>
<span class="sd">        nchunks_min: Optional[int]</span>
<span class="sd">            Minimum number of particles in a halo to process it. Default: None</span>
<span class="sd">        chunksize_bytes: Optional[int]</span>
<span class="sd">        nmax: Optional[int]</span>
<span class="sd">            Only process the first nmax halos.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        """</span>
        <span class="n">dfltkwargs</span> <span class="o">=</span> <span class="n">get_kwargs</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="n">fieldnames</span> <span class="o">=</span> <span class="n">dfltkwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"fieldnames"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fieldnames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fieldnames</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="n">parttype</span> <span class="o">=</span> <span class="n">dfltkwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"parttype"</span><span class="p">,</span> <span class="s2">"PartType0"</span><span class="p">)</span>
        <span class="n">entry_nbytes_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">parttype</span><span class="p">][</span><span class="n">f</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">nbytes</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fieldnames</span><span class="p">])</span>
        <span class="n">objtype</span> <span class="o">=</span> <span class="n">grp_type_str</span><span class="p">(</span><span class="n">objtype</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">objtype</span> <span class="o">==</span> <span class="s2">"halo"</span><span class="p">:</span>
            <span class="n">lengths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_grouplengths</span><span class="p">(</span><span class="n">parttype</span><span class="o">=</span><span class="n">parttype</span><span class="p">)</span>
            <span class="n">offsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_groupoffsets</span><span class="p">(</span><span class="n">parttype</span><span class="o">=</span><span class="n">parttype</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">objtype</span> <span class="o">==</span> <span class="s2">"subhalo"</span><span class="p">:</span>
            <span class="n">lengths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subhalolengths</span><span class="p">(</span><span class="n">parttype</span><span class="o">=</span><span class="n">parttype</span><span class="p">)</span>
            <span class="n">offsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subhalooffsets</span><span class="p">(</span><span class="n">parttype</span><span class="o">=</span><span class="n">parttype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"objtype must be 'halo' or 'subhalo', not </span><span class="si">{</span><span class="n">objtype</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">arrdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">parttype</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">map_group_operation</span><span class="p">(</span>
            <span class="n">func</span><span class="p">,</span>
            <span class="n">offsets</span><span class="p">,</span>
            <span class="n">lengths</span><span class="p">,</span>
            <span class="n">arrdict</span><span class="p">,</span>
            <span class="n">cpucost_halo</span><span class="o">=</span><span class="n">cpucost_halo</span><span class="p">,</span>
            <span class="n">nchunks_min</span><span class="o">=</span><span class="n">nchunks_min</span><span class="p">,</span>
            <span class="n">chunksize_bytes</span><span class="o">=</span><span class="n">chunksize_bytes</span><span class="p">,</span>
            <span class="n">entry_nbytes_in</span><span class="o">=</span><span class="n">entry_nbytes_in</span><span class="p">,</span>
            <span class="n">nmax</span><span class="o">=</span><span class="n">nmax</span><span class="p">,</span>
            <span class="n">idxlist</span><span class="o">=</span><span class="n">idxlist</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_groupquantity_to_particles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">parttype</span><span class="o">=</span><span class="s2">"PartType0"</span><span class="p">):</span>
        <span class="n">pdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">parttype</span><span class="p">]</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pdata</span>
        <span class="p">)</span>  <span class="c1"># we simply map the name from Group to Particle for now. Should work (?)</span>
        <span class="n">glen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"Group"</span><span class="p">][</span><span class="s2">"GroupLenType"</span><span class="p">]</span>
        <span class="n">da_halocelloffsets</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span> <span class="n">da</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">glen</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="s2">"GroupOffsetsType"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"Group"</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"Group"</span><span class="p">][</span><span class="s2">"GroupOffsetsType"</span><span class="p">]</span> <span class="o">=</span> <span class="n">da_halocelloffsets</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rechunk</span><span class="p">(</span>
                <span class="n">glen</span><span class="o">.</span><span class="n">chunks</span>
            <span class="p">)</span>  <span class="c1"># remove last entry to match shape</span>
        <span class="n">halocelloffsets</span> <span class="o">=</span> <span class="n">da_halocelloffsets</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

        <span class="n">gidx</span> <span class="o">=</span> <span class="n">pdata</span><span class="p">[</span><span class="s2">"uid"</span><span class="p">]</span>
        <span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parttype</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">hquantity</span> <span class="o">=</span> <span class="n">compute_haloquantity</span><span class="p">(</span>
            <span class="n">gidx</span><span class="p">,</span> <span class="n">halocelloffsets</span><span class="p">[:,</span> <span class="n">num</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"Group"</span><span class="p">][</span><span class="n">name</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">pdata</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">hquantity</span>

    <span class="k">def</span> <span class="nf">get_grouplengths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parttype</span><span class="o">=</span><span class="s2">"PartType0"</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Get the total number of particles of a given type in all halos."""</span>
        <span class="n">pnum</span> <span class="o">=</span> <span class="n">part_type_num</span><span class="p">(</span><span class="n">parttype</span><span class="p">)</span>
        <span class="n">ptype</span> <span class="o">=</span> <span class="s2">"PartType</span><span class="si">%i</span><span class="s2">"</span> <span class="o">%</span> <span class="n">pnum</span>
        <span class="k">if</span> <span class="n">ptype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grouplengths</span><span class="p">:</span>
            <span class="n">lengths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"Group"</span><span class="p">][</span><span class="s2">"GroupLenType"</span><span class="p">][:,</span> <span class="n">pnum</span><span class="p">]</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lengths</span><span class="p">,</span> <span class="n">pint</span><span class="o">.</span><span class="n">Quantity</span><span class="p">):</span>
                <span class="n">lengths</span> <span class="o">=</span> <span class="n">lengths</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_grouplengths</span><span class="p">[</span><span class="n">ptype</span><span class="p">]</span> <span class="o">=</span> <span class="n">lengths</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grouplengths</span><span class="p">[</span><span class="n">ptype</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_groupoffsets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parttype</span><span class="o">=</span><span class="s2">"PartType0"</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">parttype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grouplengths</span><span class="p">:</span>
            <span class="c1"># need to calculate group lengths first</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_grouplengths</span><span class="p">(</span><span class="n">parttype</span><span class="o">=</span><span class="n">parttype</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_groupoffsets</span><span class="p">[</span><span class="n">parttype</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_groupoffsets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lengths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grouplengths</span>
        <span class="n">offsets</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">v</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">lengths</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">offsets</span>

    <span class="k">def</span> <span class="nf">get_subhalolengths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parttype</span><span class="o">=</span><span class="s2">"PartType0"</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Get the total number of particles of a given type in all halos."""</span>
        <span class="n">pnum</span> <span class="o">=</span> <span class="n">part_type_num</span><span class="p">(</span><span class="n">parttype</span><span class="p">)</span>
        <span class="n">ptype</span> <span class="o">=</span> <span class="s2">"PartType</span><span class="si">%i</span><span class="s2">"</span> <span class="o">%</span> <span class="n">pnum</span>
        <span class="k">if</span> <span class="n">ptype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subhalolengths</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subhalolengths</span><span class="p">[</span><span class="n">ptype</span><span class="p">]</span>
        <span class="n">lengths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"Subhalo"</span><span class="p">][</span><span class="s2">"SubhaloLenType"</span><span class="p">][:,</span> <span class="n">pnum</span><span class="p">]</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lengths</span><span class="p">,</span> <span class="n">pint</span><span class="o">.</span><span class="n">Quantity</span><span class="p">):</span>
            <span class="n">lengths</span> <span class="o">=</span> <span class="n">lengths</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subhalolengths</span><span class="p">[</span><span class="n">ptype</span><span class="p">]</span> <span class="o">=</span> <span class="n">lengths</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subhalolengths</span><span class="p">[</span><span class="n">ptype</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_subhalooffsets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parttype</span><span class="o">=</span><span class="s2">"PartType0"</span><span class="p">):</span>
        <span class="n">pnum</span> <span class="o">=</span> <span class="n">part_type_num</span><span class="p">(</span><span class="n">parttype</span><span class="p">)</span>
        <span class="n">ptype</span> <span class="o">=</span> <span class="s2">"PartType</span><span class="si">%i</span><span class="s2">"</span> <span class="o">%</span> <span class="n">pnum</span>
        <span class="k">if</span> <span class="n">ptype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subhalooffsets</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subhalooffsets</span><span class="p">[</span><span class="n">ptype</span><span class="p">]</span>  <span class="c1"># use cached result</span>
        <span class="n">goffsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_groupoffsets</span><span class="p">(</span><span class="n">ptype</span><span class="p">)</span>
        <span class="n">shgrnr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"Subhalo"</span><span class="p">][</span><span class="s2">"SubhaloGrNr"</span><span class="p">]</span>
        <span class="c1"># calculate the index of the first particle for the central subhalo of each subhalos's parent halo</span>
        <span class="n">shoffset_central</span> <span class="o">=</span> <span class="n">goffsets</span><span class="p">[</span><span class="n">shgrnr</span><span class="p">]</span>

        <span class="n">grpfirstsub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"Group"</span><span class="p">][</span><span class="s2">"GroupFirstSub"</span><span class="p">]</span>
        <span class="n">shlens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subhalolengths</span><span class="p">(</span><span class="n">ptype</span><span class="p">)</span>
        <span class="n">shoffsets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">shlens</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>

        <span class="c1"># particle offset for the first subhalo of each group that a subhalo belongs to</span>
        <span class="n">shfirstshoffset</span> <span class="o">=</span> <span class="n">shoffsets</span><span class="p">[</span><span class="n">grpfirstsub</span><span class="p">[</span><span class="n">shgrnr</span><span class="p">]]</span>

        <span class="c1"># "LocalSubhaloOffset": particle offset of each subhalo in the parent group</span>
        <span class="n">shoffset_local</span> <span class="o">=</span> <span class="n">shoffsets</span> <span class="o">-</span> <span class="n">shfirstshoffset</span>

        <span class="c1"># "SubhaloOffset": particle offset of each subhalo in the simulation</span>
        <span class="n">offsets</span> <span class="o">=</span> <span class="n">shoffset_central</span> <span class="o">+</span> <span class="n">shoffset_local</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_subhalooffsets</span><span class="p">[</span><span class="n">ptype</span><span class="p">]</span> <span class="o">=</span> <span class="n">offsets</span>

        <span class="k">return</span> <span class="n">offsets</span>

    <span class="k">def</span> <span class="nf">grouped</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">fields</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">da</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">da</span><span class="o">.</span><span class="n">Array</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">""</span><span class="p">,</span>
        <span class="n">parttype</span><span class="o">=</span><span class="s2">"PartType0"</span><span class="p">,</span>
        <span class="n">objtype</span><span class="o">=</span><span class="s2">"halo"</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">inputfields</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">fields</span> <span class="o">==</span> <span class="s2">""</span><span class="p">:</span>  <span class="c1"># if nothing is specified, we pass all we have.</span>
                <span class="n">arrdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">parttype</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">arrdict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">parttype</span><span class="p">][</span><span class="n">fields</span><span class="p">])</span>
                <span class="n">inputfields</span> <span class="o">=</span> <span class="p">[</span><span class="n">fields</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">da</span><span class="o">.</span><span class="n">Array</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">pint</span><span class="o">.</span><span class="n">Quantity</span><span class="p">):</span>
            <span class="n">arrdict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">daskarr</span><span class="o">=</span><span class="n">fields</span><span class="p">)</span>
            <span class="n">inputfields</span> <span class="o">=</span> <span class="p">[</span><span class="n">fields</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">arrdict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">parttype</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">}</span>
            <span class="n">inputfields</span> <span class="o">=</span> <span class="n">fields</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">arrdict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">arrdict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">fields</span><span class="p">)</span>
            <span class="n">inputfields</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">arrdict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Unknown input type '</span><span class="si">%s</span><span class="s2">'."</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">fields</span><span class="p">))</span>
        <span class="n">objtype</span> <span class="o">=</span> <span class="n">grp_type_str</span><span class="p">(</span><span class="n">objtype</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">objtype</span> <span class="o">==</span> <span class="s2">"halo"</span><span class="p">:</span>
            <span class="n">offsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_groupoffsets</span><span class="p">(</span><span class="n">parttype</span><span class="o">=</span><span class="n">parttype</span><span class="p">)</span>
            <span class="n">lengths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_grouplengths</span><span class="p">(</span><span class="n">parttype</span><span class="o">=</span><span class="n">parttype</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">objtype</span> <span class="o">==</span> <span class="s2">"subhalo"</span><span class="p">:</span>
            <span class="n">offsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subhalooffsets</span><span class="p">(</span><span class="n">parttype</span><span class="o">=</span><span class="n">parttype</span><span class="p">)</span>
            <span class="n">lengths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subhalolengths</span><span class="p">(</span><span class="n">parttype</span><span class="o">=</span><span class="n">parttype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Unknown object type '</span><span class="si">%s</span><span class="s2">'."</span> <span class="o">%</span> <span class="n">objtype</span><span class="p">)</span>

        <span class="n">gop</span> <span class="o">=</span> <span class="n">GroupAwareOperation</span><span class="p">(</span>
            <span class="n">offsets</span><span class="p">,</span>
            <span class="n">lengths</span><span class="p">,</span>
            <span class="n">arrdict</span><span class="p">,</span>
            <span class="n">inputfields</span><span class="o">=</span><span class="n">inputfields</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">gop</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h6 id="scida.customs.arepo.dataset.ArepoSnapshot.add_catalogIDs" class="doc doc-heading">
<code class="highlight language-python"><span class="n">add_catalogIDs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span></code>


</h6>

    <div class="doc doc-contents ">

      <p>Add field for halo and subgroup IDs for all particle types.
Returns</p>
<hr>

        <details class="quote">
          <summary>Source code in <code>scida/customs/arepo/dataset.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">add_catalogIDs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Add field for halo and subgroup IDs for all particle types.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    """</span>
    <span class="c1"># TODO: make these delayed objects and properly pass into (delayed?) numba functions:</span>
    <span class="c1"># https://docs.dask.org/en/stable/delayed-best-practices.html#avoid-repeatedly-putting-large-inputs-into-delayed-calls</span>

    <span class="n">maxint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">max</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">misc</span><span class="p">[</span><span class="s2">"unboundID"</span><span class="p">]</span> <span class="o">=</span> <span class="n">maxint</span>

    <span class="c1"># Group ID</span>
    <span class="k">if</span> <span class="s2">"Group"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>  <span class="c1"># can happen for empty catalogs</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"PartType"</span><span class="p">)):</span>
                <span class="k">continue</span>
            <span class="n">uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">"uid"</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">"GroupID"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">misc</span><span class="p">[</span><span class="s2">"unboundID"</span><span class="p">]</span> <span class="o">*</span> <span class="n">da</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span>
                <span class="n">uid</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">"SubhaloID"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">misc</span><span class="p">[</span><span class="s2">"unboundID"</span><span class="p">]</span> <span class="o">*</span> <span class="n">da</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span>
                <span class="n">uid</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span>
            <span class="p">)</span>
        <span class="k">return</span>

    <span class="n">glen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"Group"</span><span class="p">][</span><span class="s2">"GroupLenType"</span><span class="p">]</span>
    <span class="n">ngrp</span> <span class="o">=</span> <span class="n">glen</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">da_halocelloffsets</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
            <span class="n">da</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">glen</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="c1"># remove last entry to match shapematch shape</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"Group"</span><span class="p">][</span><span class="s2">"GroupOffsetsType"</span><span class="p">]</span> <span class="o">=</span> <span class="n">da_halocelloffsets</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rechunk</span><span class="p">(</span>
        <span class="n">glen</span><span class="o">.</span><span class="n">chunks</span>
    <span class="p">)</span>
    <span class="n">halocelloffsets</span> <span class="o">=</span> <span class="n">da_halocelloffsets</span><span class="o">.</span><span class="n">rechunk</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">index_unbound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">misc</span><span class="p">[</span><span class="s2">"unboundID"</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"PartType"</span><span class="p">)):</span>
            <span class="k">continue</span>
        <span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">"uid"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
            <span class="k">continue</span>  <span class="c1"># can happen for empty containers</span>
        <span class="n">gidx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">"uid"</span><span class="p">]</span>
        <span class="n">hidx</span> <span class="o">=</span> <span class="n">compute_haloindex</span><span class="p">(</span>
            <span class="n">gidx</span><span class="p">,</span> <span class="n">halocelloffsets</span><span class="p">[:,</span> <span class="n">num</span><span class="p">],</span> <span class="n">index_unbound</span><span class="o">=</span><span class="n">index_unbound</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">"GroupID"</span><span class="p">]</span> <span class="o">=</span> <span class="n">hidx</span>

    <span class="c1"># Subhalo ID</span>
    <span class="k">if</span> <span class="s2">"Subhalo"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>  <span class="c1"># can happen for empty catalogs</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"PartType"</span><span class="p">)):</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">"SubhaloID"</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">da</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span>
                <span class="n">da</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">"uid"</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span>
            <span class="p">)</span>
        <span class="k">return</span>

    <span class="n">shnr_attr</span> <span class="o">=</span> <span class="s2">"SubhaloGrNr"</span>
    <span class="k">if</span> <span class="n">shnr_attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"Subhalo"</span><span class="p">]:</span>
        <span class="n">shnr_attr</span> <span class="o">=</span> <span class="s2">"SubhaloGroupNr"</span>  <span class="c1"># what MTNG does</span>
    <span class="k">if</span> <span class="n">shnr_attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"Subhalo"</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">"Could not find 'SubhaloGrNr' or 'SubhaloGroupNr' in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="si">}</span><span class="s2">"</span>
        <span class="p">)</span>

    <span class="n">subhalogrnr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"Subhalo"</span><span class="p">][</span><span class="n">shnr_attr</span><span class="p">]</span>
    <span class="n">subhalocellcounts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"Subhalo"</span><span class="p">][</span><span class="s2">"SubhaloLenType"</span><span class="p">]</span>

    <span class="c1"># remove "units" for numba funcs</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">subhalogrnr</span><span class="p">,</span> <span class="s2">"magnitude"</span><span class="p">):</span>
        <span class="n">subhalogrnr</span> <span class="o">=</span> <span class="n">subhalogrnr</span><span class="o">.</span><span class="n">magnitude</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">subhalocellcounts</span><span class="p">,</span> <span class="s2">"magnitude"</span><span class="p">):</span>
        <span class="n">subhalocellcounts</span> <span class="o">=</span> <span class="n">subhalocellcounts</span><span class="o">.</span><span class="n">magnitude</span>

    <span class="n">grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"Group"</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">"GroupFirstSub"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">grp</span> <span class="ow">or</span> <span class="s2">"GroupNsubs"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">grp</span><span class="p">:</span>
        <span class="c1"># if not provided, we calculate:</span>
        <span class="c1"># "GroupFirstSub": First subhalo index for each halo</span>
        <span class="c1"># "GroupNsubs": Number of subhalos for each halo</span>
        <span class="n">dlyd</span> <span class="o">=</span> <span class="n">delayed</span><span class="p">(</span><span class="n">get_shcounts_shcells</span><span class="p">)(</span><span class="n">subhalogrnr</span><span class="p">,</span> <span class="n">ngrp</span><span class="p">)</span>
        <span class="n">grp</span><span class="p">[</span><span class="s2">"GroupFirstSub"</span><span class="p">]</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">dlyd</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">grp</span><span class="p">[</span><span class="s2">"GroupNsubs"</span><span class="p">]</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">dlyd</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># remove "units" for numba funcs</span>
    <span class="n">grpfirstsub</span> <span class="o">=</span> <span class="n">grp</span><span class="p">[</span><span class="s2">"GroupFirstSub"</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">grpfirstsub</span><span class="p">,</span> <span class="s2">"magnitude"</span><span class="p">):</span>
        <span class="n">grpfirstsub</span> <span class="o">=</span> <span class="n">grpfirstsub</span><span class="o">.</span><span class="n">magnitude</span>
    <span class="n">grpnsubs</span> <span class="o">=</span> <span class="n">grp</span><span class="p">[</span><span class="s2">"GroupNsubs"</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">grpnsubs</span><span class="p">,</span> <span class="s2">"magnitude"</span><span class="p">):</span>
        <span class="n">grpnsubs</span> <span class="o">=</span> <span class="n">grpnsubs</span><span class="o">.</span><span class="n">magnitude</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"PartType"</span><span class="p">)):</span>
            <span class="k">continue</span>
        <span class="n">num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">pdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">"uid"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
            <span class="k">continue</span>  <span class="c1"># can happen for empty containers</span>
        <span class="n">gidx</span> <span class="o">=</span> <span class="n">pdata</span><span class="p">[</span><span class="s2">"uid"</span><span class="p">]</span>

        <span class="c1"># we need to make other dask arrays delayed,</span>
        <span class="c1"># map_block does not incorrectly infer output shape from these</span>
        <span class="n">halocelloffsets_dlyd</span> <span class="o">=</span> <span class="n">delayed</span><span class="p">(</span><span class="n">halocelloffsets</span><span class="p">[:,</span> <span class="n">num</span><span class="p">])</span>
        <span class="n">grpfirstsub_dlyd</span> <span class="o">=</span> <span class="n">delayed</span><span class="p">(</span><span class="n">grpfirstsub</span><span class="p">)</span>
        <span class="n">grpnsubs_dlyd</span> <span class="o">=</span> <span class="n">delayed</span><span class="p">(</span><span class="n">grpnsubs</span><span class="p">)</span>
        <span class="n">subhalocellcounts_dlyd</span> <span class="o">=</span> <span class="n">delayed</span><span class="p">(</span><span class="n">subhalocellcounts</span><span class="p">[:,</span> <span class="n">num</span><span class="p">])</span>

        <span class="n">sidx</span> <span class="o">=</span> <span class="n">compute_localsubhaloindex</span><span class="p">(</span>
            <span class="n">gidx</span><span class="p">,</span>
            <span class="n">halocelloffsets_dlyd</span><span class="p">,</span>
            <span class="n">grpfirstsub_dlyd</span><span class="p">,</span>
            <span class="n">grpnsubs_dlyd</span><span class="p">,</span>
            <span class="n">subhalocellcounts_dlyd</span><span class="p">,</span>
            <span class="n">index_unbound</span><span class="o">=</span><span class="n">index_unbound</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">pdata</span><span class="p">[</span><span class="s2">"LocalSubhaloID"</span><span class="p">]</span> <span class="o">=</span> <span class="n">sidx</span>

        <span class="c1"># reconstruct SubhaloID from Group's GroupFirstSub and LocalSubhaloID</span>
        <span class="c1"># should be easier to do it directly, but quicker to write down like this:</span>

        <span class="c1"># calculate first subhalo of each halo that a particle belongs to</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_groupquantity_to_particles</span><span class="p">(</span><span class="s2">"GroupFirstSub"</span><span class="p">,</span> <span class="n">parttype</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
        <span class="n">pdata</span><span class="p">[</span><span class="s2">"SubhaloID"</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdata</span><span class="p">[</span><span class="s2">"GroupFirstSub"</span><span class="p">]</span> <span class="o">+</span> <span class="n">pdata</span><span class="p">[</span><span class="s2">"LocalSubhaloID"</span><span class="p">]</span>
        <span class="n">pdata</span><span class="p">[</span><span class="s2">"SubhaloID"</span><span class="p">]</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">pdata</span><span class="p">[</span><span class="s2">"SubhaloID"</span><span class="p">]</span> <span class="o">==</span> <span class="n">index_unbound</span><span class="p">,</span> <span class="n">index_unbound</span><span class="p">,</span> <span class="n">pdata</span><span class="p">[</span><span class="s2">"SubhaloID"</span><span class="p">]</span>
        <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>




  <div class="doc doc-object doc-method">



<h6 id="scida.customs.arepo.dataset.ArepoSnapshot.discover_catalog" class="doc doc-heading">
<code class="highlight language-python"><span class="n">discover_catalog</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h6>

    <div class="doc doc-contents ">

      <p>Discover the group catalog given the current path
Returns</p>
<hr>

        <details class="quote">
          <summary>Source code in <code>scida/customs/arepo/dataset.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">discover_catalog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Discover the group catalog given the current path</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    """</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
    <span class="c1"># order of candidates matters. For Illustris "groups" must precede "fof_subhalo_tab"</span>
    <span class="n">candidates</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">p</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"snapshot"</span><span class="p">,</span> <span class="s2">"group"</span><span class="p">),</span>
        <span class="n">p</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"snapshot"</span><span class="p">,</span> <span class="s2">"groups"</span><span class="p">),</span>
        <span class="n">p</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"snapdir"</span><span class="p">,</span> <span class="s2">"groups"</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"snap"</span><span class="p">,</span> <span class="s2">"groups"</span><span class="p">),</span>
        <span class="n">p</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"snapdir"</span><span class="p">,</span> <span class="s2">"groups"</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"snap"</span><span class="p">,</span> <span class="s2">"fof_subhalo_tab"</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">candidate</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">candidate</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span> <span class="o">=</span> <span class="n">candidate</span>
        <span class="k">break</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h6 id="scida.customs.arepo.dataset.ArepoSnapshot.get_grouplengths" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_grouplengths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parttype</span> <span class="o">=</span> <span class="s1">'PartType0'</span><span class="p">)</span></code>


</h6>

    <div class="doc doc-contents ">

      <p>Get the total number of particles of a given type in all halos.</p>

        <details class="quote">
          <summary>Source code in <code>scida/customs/arepo/dataset.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_grouplengths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parttype</span><span class="o">=</span><span class="s2">"PartType0"</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Get the total number of particles of a given type in all halos."""</span>
    <span class="n">pnum</span> <span class="o">=</span> <span class="n">part_type_num</span><span class="p">(</span><span class="n">parttype</span><span class="p">)</span>
    <span class="n">ptype</span> <span class="o">=</span> <span class="s2">"PartType</span><span class="si">%i</span><span class="s2">"</span> <span class="o">%</span> <span class="n">pnum</span>
    <span class="k">if</span> <span class="n">ptype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grouplengths</span><span class="p">:</span>
        <span class="n">lengths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"Group"</span><span class="p">][</span><span class="s2">"GroupLenType"</span><span class="p">][:,</span> <span class="n">pnum</span><span class="p">]</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lengths</span><span class="p">,</span> <span class="n">pint</span><span class="o">.</span><span class="n">Quantity</span><span class="p">):</span>
            <span class="n">lengths</span> <span class="o">=</span> <span class="n">lengths</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_grouplengths</span><span class="p">[</span><span class="n">ptype</span><span class="p">]</span> <span class="o">=</span> <span class="n">lengths</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grouplengths</span><span class="p">[</span><span class="n">ptype</span><span class="p">]</span>
</code></pre></div>
        </details>
    </div>

  </div>




  <div class="doc doc-object doc-method">



<h6 id="scida.customs.arepo.dataset.ArepoSnapshot.get_subhalolengths" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_subhalolengths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parttype</span> <span class="o">=</span> <span class="s1">'PartType0'</span><span class="p">)</span></code>


</h6>

    <div class="doc doc-contents ">

      <p>Get the total number of particles of a given type in all halos.</p>

        <details class="quote">
          <summary>Source code in <code>scida/customs/arepo/dataset.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_subhalolengths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parttype</span><span class="o">=</span><span class="s2">"PartType0"</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Get the total number of particles of a given type in all halos."""</span>
    <span class="n">pnum</span> <span class="o">=</span> <span class="n">part_type_num</span><span class="p">(</span><span class="n">parttype</span><span class="p">)</span>
    <span class="n">ptype</span> <span class="o">=</span> <span class="s2">"PartType</span><span class="si">%i</span><span class="s2">"</span> <span class="o">%</span> <span class="n">pnum</span>
    <span class="k">if</span> <span class="n">ptype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subhalolengths</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subhalolengths</span><span class="p">[</span><span class="n">ptype</span><span class="p">]</span>
    <span class="n">lengths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">"Subhalo"</span><span class="p">][</span><span class="s2">"SubhaloLenType"</span><span class="p">][:,</span> <span class="n">pnum</span><span class="p">]</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lengths</span><span class="p">,</span> <span class="n">pint</span><span class="o">.</span><span class="n">Quantity</span><span class="p">):</span>
        <span class="n">lengths</span> <span class="o">=</span> <span class="n">lengths</span><span class="o">.</span><span class="n">magnitude</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_subhalolengths</span><span class="p">[</span><span class="n">ptype</span><span class="p">]</span> <span class="o">=</span> <span class="n">lengths</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subhalolengths</span><span class="p">[</span><span class="n">ptype</span><span class="p">]</span>
</code></pre></div>
        </details>
    </div>

  </div>







  <div class="doc doc-object doc-method">



<h6 id="scida.customs.arepo.dataset.ArepoSnapshot.register_field" class="doc doc-heading">
<code class="highlight language-python"><span class="n">register_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parttype</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">construct</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span></code>


</h6>

    <div class="doc doc-contents ">

      <p>Register a field.
Parameters</p>
<hr>
<div class="admonition parttype">
<p class="admonition-title">str</p>
<p>name of particle type</p>
</div>
<div class="admonition name">
<p class="admonition-title">str</p>
<p>name of field</p>
</div>
<div class="admonition construct">
<p class="admonition-title">bool</p>
<p>construct field immediately</p>
</div>
<h6 id="scida.customs.arepo.dataset.ArepoSnapshot.register_field--returns">Returns</h6>

        <details class="quote">
          <summary>Source code in <code>scida/customs/arepo/dataset.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">register_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parttype</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">construct</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Register a field.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    parttype: str</span>
<span class="sd">        name of particle type</span>
<span class="sd">    name: str</span>
<span class="sd">        name of field</span>
<span class="sd">    construct: bool</span>
<span class="sd">        construct field immediately</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    """</span>
    <span class="n">num</span> <span class="o">=</span> <span class="n">part_type_num</span><span class="p">(</span><span class="n">parttype</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">construct</span><span class="p">:</span>  <span class="c1"># TODO: introduce (immediate) construct option later</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
    <span class="k">if</span> <span class="n">num</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>  <span class="c1"># TODO: all particle species</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s2">"all"</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s2">"PartType"</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">parttype</span>
    <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">register_field</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>




  <div class="doc doc-object doc-method">



<h6 id="scida.customs.arepo.dataset.ArepoSnapshot.validate_path" class="doc doc-heading">
<code class="highlight language-python"><span class="n">validate_path</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CandidateStatus</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-classmethod"><code>classmethod</code></small>
  </span>

</h6>

    <div class="doc doc-contents ">

      <p>Check if path is valid for this interface.
Parameters</p>
<hr>
<div class="admonition path">
<p class="admonition-title">str, os.PathLike</p>
<p>path to check</p>
</div>
<p>args
kwargs</p>
<h6 id="scida.customs.arepo.dataset.ArepoSnapshot.validate_path--returns">Returns</h6>
<p>bool</p>

        <details class="quote">
          <summary>Source code in <code>scida/customs/arepo/dataset.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">validate_path</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CandidateStatus</span><span class="p">:</span>
    <span class="n">valid</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">validate_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">valid</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">MAYBE</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">MAYBE</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">valid</span>
    <span class="c1"># Arepo has no dedicated attribute to identify such runs.</span>
    <span class="c1"># lets just query a bunch of attributes that are present for arepo runs</span>
    <span class="n">metadata_raw</span> <span class="o">=</span> <span class="n">load_metadata</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">matchingattrs</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">matchingattrs</span> <span class="o">&amp;=</span> <span class="s2">"Git_commit"</span> <span class="ow">in</span> <span class="n">metadata_raw</span><span class="p">[</span><span class="s2">"/Header"</span><span class="p">]</span>
    <span class="c1"># not existent for any arepo run?</span>
    <span class="n">matchingattrs</span> <span class="o">&amp;=</span> <span class="s2">"Compactify_Version"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metadata_raw</span><span class="p">[</span><span class="s2">"/Header"</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">matchingattrs</span><span class="p">:</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">MAYBE</span>

    <span class="k">return</span> <span class="n">valid</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>






  <div class="doc doc-object doc-function">



<h5 id="scida.customs.arepo.dataset.Temperature" class="doc doc-heading">
<code class="highlight language-python"><span class="n">Temperature</span><span class="p">(</span><span class="n">arrs</span><span class="p">,</span> <span class="n">ureg</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">

      <p>Compute gas temperature given (ElectronAbundance,InternalEnergy) in [K].</p>

        <details class="quote">
          <summary>Source code in <code>scida/customs/arepo/dataset.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@fielddefs</span><span class="o">.</span><span class="n">register_field</span><span class="p">(</span><span class="s2">"PartType0"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">Temperature</span><span class="p">(</span><span class="n">arrs</span><span class="p">,</span> <span class="n">ureg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Compute gas temperature given (ElectronAbundance,InternalEnergy) in [K]."""</span>
    <span class="n">xh</span> <span class="o">=</span> <span class="mf">0.76</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="mf">5.0</span> <span class="o">/</span> <span class="mf">3.0</span>

    <span class="n">m_p</span> <span class="o">=</span> <span class="mf">1.672622e-24</span>  <span class="c1"># proton mass [g]</span>
    <span class="n">k_B</span> <span class="o">=</span> <span class="mf">1.380650e-16</span>  <span class="c1"># boltzmann constant [erg/K]</span>

    <span class="n">UnitEnergy_over_UnitMass</span> <span class="o">=</span> <span class="p">(</span>
        <span class="mf">1e10</span>  <span class="c1"># standard unit system (TODO: can obtain from snapshot)</span>
    <span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">UnitEnergy_over_UnitMass</span>
    <span class="k">if</span> <span class="n">ureg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">m_p</span> <span class="o">=</span> <span class="n">m_p</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">g</span>
        <span class="n">k_B</span> <span class="o">=</span> <span class="n">k_B</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">erg</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">K</span>

    <span class="n">xe</span> <span class="o">=</span> <span class="n">arrs</span><span class="p">[</span><span class="s2">"ElectronAbundance"</span><span class="p">]</span>
    <span class="n">u_internal</span> <span class="o">=</span> <span class="n">arrs</span><span class="p">[</span><span class="s2">"InternalEnergy"</span><span class="p">]</span>

    <span class="n">mu</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">xh</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">xh</span> <span class="o">*</span> <span class="n">xe</span><span class="p">)</span> <span class="o">*</span> <span class="n">m_p</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">f</span> <span class="o">*</span> <span class="p">(</span><span class="n">gamma</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">u_internal</span> <span class="o">/</span> <span class="n">k_B</span> <span class="o">*</span> <span class="n">mu</span>

    <span class="k">return</span> <span class="n">temp</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h5 id="scida.customs.arepo.dataset.compute_haloindex" class="doc doc-heading">
<code class="highlight language-python"><span class="n">compute_haloindex</span><span class="p">(</span><span class="n">gidx</span><span class="p">,</span> <span class="n">halocelloffsets</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">index_unbound</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">

      <p>Computes the halo index for each particle with dask.</p>

        <details class="quote">
          <summary>Source code in <code>scida/customs/arepo/dataset.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">compute_haloindex</span><span class="p">(</span><span class="n">gidx</span><span class="p">,</span> <span class="n">halocelloffsets</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">index_unbound</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Computes the halo index for each particle with dask."""</span>
    <span class="k">return</span> <span class="n">da</span><span class="o">.</span><span class="n">map_blocks</span><span class="p">(</span>
        <span class="n">get_hidx_daskwrap</span><span class="p">,</span>
        <span class="n">gidx</span><span class="p">,</span>
        <span class="n">halocelloffsets</span><span class="p">,</span>
        <span class="n">index_unbound</span><span class="o">=</span><span class="n">index_unbound</span><span class="p">,</span>
        <span class="n">meta</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h5 id="scida.customs.arepo.dataset.compute_haloquantity" class="doc doc-heading">
<code class="highlight language-python"><span class="n">compute_haloquantity</span><span class="p">(</span><span class="n">gidx</span><span class="p">,</span> <span class="n">halocelloffsets</span><span class="p">,</span> <span class="n">hvals</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">

      <p>Computes a halo quantity for each particle with dask.</p>

        <details class="quote">
          <summary>Source code in <code>scida/customs/arepo/dataset.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">compute_haloquantity</span><span class="p">(</span><span class="n">gidx</span><span class="p">,</span> <span class="n">halocelloffsets</span><span class="p">,</span> <span class="n">hvals</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Computes a halo quantity for each particle with dask."""</span>
    <span class="n">units</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">hvals</span><span class="p">,</span> <span class="s2">"units"</span><span class="p">):</span>
        <span class="n">units</span> <span class="o">=</span> <span class="n">hvals</span><span class="o">.</span><span class="n">units</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">map_blocks</span><span class="p">(</span>
        <span class="n">get_haloquantity_daskwrap</span><span class="p">,</span>
        <span class="n">gidx</span><span class="p">,</span>
        <span class="n">halocelloffsets</span><span class="p">,</span>
        <span class="n">hvals</span><span class="p">,</span>
        <span class="n">meta</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">hvals</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
        <span class="n">output_units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span>
</code></pre></div>
        </details>
    </div>

  </div>





  <div class="doc doc-object doc-function">



<h5 id="scida.customs.arepo.dataset.get_hidx" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_hidx</span><span class="p">(</span><span class="n">gidx_start</span><span class="p">,</span> <span class="n">gidx_count</span><span class="p">,</span> <span class="n">celloffsets</span><span class="p">,</span> <span class="n">index_unbound</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">

      <p>Get halo index of a given cell</p>
<h6 id="scida.customs.arepo.dataset.get_hidx--parameters">Parameters</h6>
<div class="admonition gidx_start">
<p class="admonition-title">integer</p>
<p>The first unique integer ID for the first particle</p>
</div>
<div class="admonition gidx_count">
<p class="admonition-title">integer</p>
<p>The amount of halo indices we are querying after "gidx_start"</p>
</div>
<p>celloffsets : array
    An array holding the starting cell offset for each halo. Needs to include the
    offset after the last halo. The required shape is thus (Nhalo+1,).
index_unbound : integer, optional
    The index to use for unbound particles. If None, the maximum integer value
    of the dtype is used.</p>

        <details class="quote">
          <summary>Source code in <code>scida/customs/arepo/dataset.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_hidx</span><span class="p">(</span><span class="n">gidx_start</span><span class="p">,</span> <span class="n">gidx_count</span><span class="p">,</span> <span class="n">celloffsets</span><span class="p">,</span> <span class="n">index_unbound</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Get halo index of a given cell</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    gidx_start: integer</span>
<span class="sd">        The first unique integer ID for the first particle</span>
<span class="sd">    gidx_count: integer</span>
<span class="sd">        The amount of halo indices we are querying after "gidx_start"</span>
<span class="sd">    celloffsets : array</span>
<span class="sd">        An array holding the starting cell offset for each halo. Needs to include the</span>
<span class="sd">        offset after the last halo. The required shape is thus (Nhalo+1,).</span>
<span class="sd">    index_unbound : integer, optional</span>
<span class="sd">        The index to use for unbound particles. If None, the maximum integer value</span>
<span class="sd">        of the dtype is used.</span>
<span class="sd">    """</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span>
    <span class="k">if</span> <span class="n">index_unbound</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">index_unbound</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">max</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">index_unbound</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">gidx_count</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="c1"># find initial celloffset</span>
    <span class="n">hidx_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">celloffsets</span><span class="p">,</span> <span class="n">gidx_start</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s2">"right"</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">hidx_idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">celloffsets</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="c1"># we are done. Already out of scope of lookup =&gt; all unbound gas.</span>
        <span class="k">return</span> <span class="n">res</span>
    <span class="n">celloffset</span> <span class="o">=</span> <span class="n">celloffsets</span><span class="p">[</span><span class="n">hidx_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">endid</span> <span class="o">=</span> <span class="n">celloffset</span> <span class="o">-</span> <span class="n">gidx_start</span>
    <span class="n">startid</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Now iterate through list.</span>
    <span class="k">while</span> <span class="n">startid</span> <span class="o">&lt;</span> <span class="n">gidx_count</span><span class="p">:</span>
        <span class="n">res</span><span class="p">[</span><span class="n">startid</span><span class="p">:</span><span class="n">endid</span><span class="p">]</span> <span class="o">=</span> <span class="n">hidx_idx</span>
        <span class="n">hidx_idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">startid</span> <span class="o">=</span> <span class="n">endid</span>
        <span class="k">if</span> <span class="n">hidx_idx</span> <span class="o">&gt;=</span> <span class="n">celloffsets</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">celloffsets</span><span class="p">[</span><span class="n">hidx_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">celloffsets</span><span class="p">[</span><span class="n">hidx_idx</span><span class="p">]</span>
        <span class="n">endid</span> <span class="o">=</span> <span class="n">startid</span> <span class="o">+</span> <span class="n">count</span>
    <span class="k">return</span> <span class="n">res</span>
</code></pre></div>
        </details>
    </div>

  </div>





  <div class="doc doc-object doc-function">



<h5 id="scida.customs.arepo.dataset.get_localshidx" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_localshidx</span><span class="p">(</span><span class="n">gidx_start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">gidx_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">celloffsets</span><span class="p">:</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">shnumber</span><span class="p">,</span> <span class="n">shcounts</span><span class="p">,</span> <span class="n">shcellcounts</span><span class="p">,</span> <span class="n">index_unbound</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">

      <p>Get the local subhalo index for each particle. This is the subhalo index within each
halo group. Particles belonging to the central galaxies will have index 0, particles
belonging to the first satellite will have index 1, etc.
Parameters</p>
<hr>
<p>gidx_start
gidx_count
celloffsets
shnumber
shcounts
shcellcounts</p>
<div class="admonition index_unbound">
<p class="admonition-title">integer, optional</p>
<p>The index to use for unbound particles. If None, the maximum integer value
of the dtype is used.</p>
</div>
<h6 id="scida.customs.arepo.dataset.get_localshidx--returns">Returns</h6>

        <details class="quote">
          <summary>Source code in <code>scida/customs/arepo/dataset.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_localshidx</span><span class="p">(</span>
    <span class="n">gidx_start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">gidx_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">celloffsets</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">],</span>
    <span class="n">shnumber</span><span class="p">,</span>
    <span class="n">shcounts</span><span class="p">,</span>
    <span class="n">shcellcounts</span><span class="p">,</span>
    <span class="n">index_unbound</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Get the local subhalo index for each particle. This is the subhalo index within each</span>
<span class="sd">    halo group. Particles belonging to the central galaxies will have index 0, particles</span>
<span class="sd">    belonging to the first satellite will have index 1, etc.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    gidx_start</span>
<span class="sd">    gidx_count</span>
<span class="sd">    celloffsets</span>
<span class="sd">    shnumber</span>
<span class="sd">    shcounts</span>
<span class="sd">    shcellcounts</span>
<span class="sd">    index_unbound: integer, optional</span>
<span class="sd">        The index to use for unbound particles. If None, the maximum integer value</span>
<span class="sd">        of the dtype is used.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    """</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span>
    <span class="k">if</span> <span class="n">index_unbound</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">index_unbound</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">max</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">index_unbound</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">gidx_count</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>  <span class="c1"># fuzz has negative index.</span>

    <span class="c1"># find initial Group we are in</span>
    <span class="n">hidx_start_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">celloffsets</span><span class="p">,</span> <span class="n">gidx_start</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s2">"right"</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">hidx_start_idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">celloffsets</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="c1"># we are done. Already out of scope of lookup =&gt; all unbound gas.</span>
        <span class="k">return</span> <span class="n">res</span>
    <span class="n">celloffset</span> <span class="o">=</span> <span class="n">celloffsets</span><span class="p">[</span><span class="n">hidx_start_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">endid</span> <span class="o">=</span> <span class="n">celloffset</span> <span class="o">-</span> <span class="n">gidx_start</span>
    <span class="n">startid</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># find initial subhalo we are in</span>
    <span class="n">hidx</span> <span class="o">=</span> <span class="n">hidx_start_idx</span>
    <span class="n">shcumsum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shcounts</span><span class="p">[</span><span class="n">hidx</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">shcumsum</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span>
        <span class="n">shcellcounts</span><span class="p">[</span><span class="n">shnumber</span><span class="p">[</span><span class="n">hidx</span><span class="p">]</span> <span class="p">:</span> <span class="n">shnumber</span><span class="p">[</span><span class="n">hidx</span><span class="p">]</span> <span class="o">+</span> <span class="n">shcounts</span><span class="p">[</span><span class="n">hidx</span><span class="p">]]</span>
    <span class="p">)</span>  <span class="c1"># collect halo's subhalo offsets</span>
    <span class="n">shcumsum</span> <span class="o">+=</span> <span class="n">celloffsets</span><span class="p">[</span><span class="n">hidx_start_idx</span><span class="p">]</span>
    <span class="n">sidx_start_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">shcumsum</span><span class="p">,</span> <span class="n">gidx_start</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s2">"right"</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sidx_start_idx</span> <span class="o">&lt;</span> <span class="n">shcounts</span><span class="p">[</span><span class="n">hidx</span><span class="p">]:</span>
        <span class="n">endid</span> <span class="o">=</span> <span class="n">shcumsum</span><span class="p">[</span><span class="n">sidx_start_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">gidx_start</span>

    <span class="c1"># Now iterate through list.</span>
    <span class="n">cont</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">while</span> <span class="n">cont</span> <span class="ow">and</span> <span class="p">(</span><span class="n">startid</span> <span class="o">&lt;</span> <span class="n">gidx_count</span><span class="p">):</span>
        <span class="n">res</span><span class="p">[</span><span class="n">startid</span><span class="p">:</span><span class="n">endid</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">sidx_start_idx</span> <span class="k">if</span> <span class="n">sidx_start_idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">shcumsum</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
        <span class="p">)</span>
        <span class="n">sidx_start_idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">sidx_start_idx</span> <span class="o">&lt;</span> <span class="n">shcounts</span><span class="p">[</span><span class="n">hidx_start_idx</span><span class="p">]:</span>
            <span class="c1"># we prepare to fill the next available subhalo for current halo</span>
            <span class="n">count</span> <span class="o">=</span> <span class="n">shcumsum</span><span class="p">[</span><span class="n">sidx_start_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">shcumsum</span><span class="p">[</span><span class="n">sidx_start_idx</span><span class="p">]</span>
            <span class="n">startid</span> <span class="o">=</span> <span class="n">endid</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># we need to find the next halo to start filling its subhalos</span>
            <span class="n">dbgcount</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">dbgcount</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>  <span class="c1"># find next halo with &gt;0 subhalos</span>
                <span class="n">hidx_start_idx</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">hidx_start_idx</span> <span class="o">&gt;=</span> <span class="n">shcounts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">cont</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">shcounts</span><span class="p">[</span><span class="n">hidx_start_idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">dbgcount</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">hidx</span> <span class="o">=</span> <span class="n">hidx_start_idx</span>
            <span class="k">if</span> <span class="n">hidx_start_idx</span> <span class="o">&gt;=</span> <span class="n">celloffsets</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">startid</span> <span class="o">=</span> <span class="n">gidx_count</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">=</span> <span class="n">celloffsets</span><span class="p">[</span><span class="n">hidx_start_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">celloffsets</span><span class="p">[</span><span class="n">hidx_start_idx</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">hidx</span> <span class="o">&lt;</span> <span class="n">shcounts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">shcumsum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shcounts</span><span class="p">[</span><span class="n">hidx</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
                    <span class="n">shcumsum</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span>
                        <span class="n">shcellcounts</span><span class="p">[</span><span class="n">shnumber</span><span class="p">[</span><span class="n">hidx</span><span class="p">]</span> <span class="p">:</span> <span class="n">shnumber</span><span class="p">[</span><span class="n">hidx</span><span class="p">]</span> <span class="o">+</span> <span class="n">shcounts</span><span class="p">[</span><span class="n">hidx</span><span class="p">]]</span>
                    <span class="p">)</span>
                    <span class="n">shcumsum</span> <span class="o">+=</span> <span class="n">celloffsets</span><span class="p">[</span><span class="n">hidx_start_idx</span><span class="p">]</span>
                    <span class="n">sidx_start_idx</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="n">sidx_start_idx</span> <span class="o">&lt;</span> <span class="n">shcounts</span><span class="p">[</span><span class="n">hidx</span><span class="p">]:</span>
                        <span class="n">count</span> <span class="o">=</span> <span class="n">shcumsum</span><span class="p">[</span><span class="n">sidx_start_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">shcumsum</span><span class="p">[</span><span class="n">sidx_start_idx</span><span class="p">]</span>
                    <span class="n">startid</span> <span class="o">=</span> <span class="n">celloffsets</span><span class="p">[</span><span class="n">hidx_start_idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">gidx_start</span>
        <span class="n">endid</span> <span class="o">=</span> <span class="n">startid</span> <span class="o">+</span> <span class="n">count</span>
    <span class="k">return</span> <span class="n">res</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h5 id="scida.customs.arepo.dataset.get_shcounts_shcells" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_shcounts_shcells</span><span class="p">(</span><span class="n">SubhaloGrNr</span><span class="p">,</span> <span class="n">hlength</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">

      <p>Returns the id of the first subhalo and count of subhalos per halo.
Parameters</p>
<hr>
<p>SubhaloGrNr: np.ndarray
The group identifier that each subhalo belongs to respectively
hlength: int
The number of halos in the snapshot</p>
<h6 id="scida.customs.arepo.dataset.get_shcounts_shcells--returns">Returns</h6>

        <details class="quote">
          <summary>Source code in <code>scida/customs/arepo/dataset.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_shcounts_shcells</span><span class="p">(</span><span class="n">SubhaloGrNr</span><span class="p">,</span> <span class="n">hlength</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Returns the id of the first subhalo and count of subhalos per halo.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    SubhaloGrNr: np.ndarray</span>
<span class="sd">    The group identifier that each subhalo belongs to respectively</span>
<span class="sd">    hlength: int</span>
<span class="sd">    The number of halos in the snapshot</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    """</span>
    <span class="n">shcounts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">hlength</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>  <span class="c1"># number of subhalos per halo</span>
    <span class="n">shnumber</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">hlength</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>  <span class="c1"># index of first subhalo per halo</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">hid_old</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SubhaloGrNr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">hid</span> <span class="o">=</span> <span class="n">SubhaloGrNr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">hid</span> <span class="o">==</span> <span class="n">hid_old</span><span class="p">:</span>
            <span class="n">shcounts</span><span class="p">[</span><span class="n">hid</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shnumber</span><span class="p">[</span><span class="n">hid</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">shcounts</span><span class="p">[</span><span class="n">hid</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">hid_old</span> <span class="o">=</span> <span class="n">hid</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">shcounts</span><span class="p">,</span> <span class="n">shnumber</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h5 id="scida.customs.arepo.dataset.map_group_operation" class="doc doc-heading">
<code class="highlight language-python"><span class="n">map_group_operation</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">offsets</span><span class="p">,</span> <span class="n">lengths</span><span class="p">,</span> <span class="n">arrdict</span><span class="p">,</span> <span class="n">cpucost_halo</span> <span class="o">=</span> <span class="mf">10000.0</span><span class="p">,</span> <span class="n">nchunks_min</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">chunksize_bytes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">entry_nbytes_in</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">fieldnames</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">nmax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">idxlist</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span></code>


</h5>

    <div class="doc doc-contents ">

      <p>Map a function to all halos in a halo catalog.
Parameters</p>
<hr>
<div class="admonition idxlist">
<p class="admonition-title">Optional[np.ndarray]</p>
<p>Only process the halos with these indices.</p>
</div>
<div class="admonition nmax">
<p class="admonition-title">Optional[int]</p>
<p>Only process the first nmax halos.</p>
</div>
<p>func</p>
<div class="admonition offsets">
<p class="admonition-title">np.ndarray</p>
<p>Offset of each group in the particle catalog.</p>
</div>
<div class="admonition lengths">
<p class="admonition-title">np.ndarray</p>
<p>Number of particles per halo.</p>
</div>
<p>arrdict
cpucost_halo</p>
<div class="admonition nchunks_min">
<p class="admonition-title">Optional[int]</p>
<p>Lower bound on the number of halos per chunk.</p>
</div>
<p>chunksize_bytes
entry_nbytes_in
fieldnames</p>
<h6 id="scida.customs.arepo.dataset.map_group_operation--returns">Returns</h6>

        <details class="quote">
          <summary>Source code in <code>scida/customs/arepo/dataset.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">map_group_operation</span><span class="p">(</span>
    <span class="n">func</span><span class="p">,</span>
    <span class="n">offsets</span><span class="p">,</span>
    <span class="n">lengths</span><span class="p">,</span>
    <span class="n">arrdict</span><span class="p">,</span>
    <span class="n">cpucost_halo</span><span class="o">=</span><span class="mf">1e4</span><span class="p">,</span>
    <span class="n">nchunks_min</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">chunksize_bytes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">entry_nbytes_in</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="n">fieldnames</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">nmax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">idxlist</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">da</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Map a function to all halos in a halo catalog.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    idxlist: Optional[np.ndarray]</span>
<span class="sd">        Only process the halos with these indices.</span>
<span class="sd">    nmax: Optional[int]</span>
<span class="sd">        Only process the first nmax halos.</span>
<span class="sd">    func</span>
<span class="sd">    offsets: np.ndarray</span>
<span class="sd">        Offset of each group in the particle catalog.</span>
<span class="sd">    lengths: np.ndarray</span>
<span class="sd">        Number of particles per halo.</span>
<span class="sd">    arrdict</span>
<span class="sd">    cpucost_halo</span>
<span class="sd">    nchunks_min: Optional[int]</span>
<span class="sd">        Lower bound on the number of halos per chunk.</span>
<span class="sd">    chunksize_bytes</span>
<span class="sd">    entry_nbytes_in</span>
<span class="sd">    fieldnames</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    """</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">ChainOps</span><span class="p">):</span>
        <span class="n">dfltkwargs</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">kwargs</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dfltkwargs</span> <span class="o">=</span> <span class="n">get_kwargs</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fieldnames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fieldnames</span> <span class="o">=</span> <span class="n">dfltkwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"fieldnames"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fieldnames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fieldnames</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="n">units</span> <span class="o">=</span> <span class="n">dfltkwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"units"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">dfltkwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"shape"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">dfltkwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"dtype"</span><span class="p">,</span> <span class="s2">"float64"</span><span class="p">)</span>
    <span class="n">fill_value</span> <span class="o">=</span> <span class="n">dfltkwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"fill_value"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">idxlist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">nmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Cannot specify both idxlist and nmax."</span><span class="p">)</span>

    <span class="n">lengths_all</span> <span class="o">=</span> <span class="n">lengths</span>
    <span class="n">offsets_all</span> <span class="o">=</span> <span class="n">offsets</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">offsets</span><span class="p">):</span>
        <span class="c1"># the offsets array here is one longer here, holding the total number of particles in the last halo.</span>
        <span class="n">offsets_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">offsets_all</span><span class="p">,</span> <span class="p">[</span><span class="n">offsets_all</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">lengths</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]])</span>

    <span class="k">if</span> <span class="n">nmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lengths</span> <span class="o">=</span> <span class="n">lengths</span><span class="p">[:</span><span class="n">nmax</span><span class="p">]</span>
        <span class="n">offsets</span> <span class="o">=</span> <span class="n">offsets</span><span class="p">[:</span><span class="n">nmax</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">idxlist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># make sure idxlist is sorted and unique</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">idxlist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"idxlist must be sorted and unique."</span><span class="p">)</span>
        <span class="c1"># make sure idxlist is within range</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">idxlist</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">idxlist</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">lengths</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">"idxlist elements must be in [</span><span class="si">%i</span><span class="s2">, </span><span class="si">%i</span><span class="s2">), but covers range [</span><span class="si">%i</span><span class="s2">, </span><span class="si">%i</span><span class="s2">]."</span>
                <span class="o">%</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lengths</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">idxlist</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">idxlist</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="n">offsets</span> <span class="o">=</span> <span class="n">offsets</span><span class="p">[</span><span class="n">idxlist</span><span class="p">]</span>
        <span class="n">lengths</span> <span class="o">=</span> <span class="n">lengths</span><span class="p">[</span><span class="n">idxlist</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">offsets</span><span class="p">):</span>
        <span class="c1"># the offsets array here is one longer here, holding the total number of particles in the last halo.</span>
        <span class="n">offsets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">offsets</span><span class="p">,</span> <span class="p">[</span><span class="n">offsets</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">lengths</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]])</span>

    <span class="c1"># shape/units inference</span>
    <span class="n">infer_shape</span> <span class="o">=</span> <span class="n">shape</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">shape</span> <span class="o">==</span> <span class="s2">"auto"</span><span class="p">)</span>
    <span class="n">infer_units</span> <span class="o">=</span> <span class="n">units</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="n">infer</span> <span class="o">=</span> <span class="n">infer_shape</span> <span class="ow">or</span> <span class="n">infer_units</span>
    <span class="k">if</span> <span class="n">infer</span><span class="p">:</span>
        <span class="c1"># attempt to determine shape.</span>
        <span class="k">if</span> <span class="n">infer_shape</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">"No shape specified. Attempting to determine shape of func output."</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">infer_units</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">"No units specified. Attempting to determine units of func output."</span>
            <span class="p">)</span>
        <span class="n">arrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">arrdict</span><span class="p">[</span><span class="n">f</span><span class="p">][:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fieldnames</span><span class="p">]</span>
        <span class="c1"># remove units if present</span>
        <span class="c1"># arrs = [arr.magnitude if hasattr(arr, "magnitude") else arr for arr in arrs]</span>
        <span class="c1"># arrs = [arr.magnitude for arr in arrs]</span>
        <span class="n">dummyres</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dummyres</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">arrs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># noqa</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">"Exception during shape/unit inference: </span><span class="si">%s</span><span class="s2">."</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">dummyres</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">infer_units</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dummyres</span><span class="p">,</span> <span class="s2">"units"</span><span class="p">):</span>
                <span class="n">units</span> <span class="o">=</span> <span class="n">dummyres</span><span class="o">.</span><span class="n">units</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">"Shape inference: </span><span class="si">%s</span><span class="s2">."</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">infer_units</span> <span class="ow">and</span> <span class="n">dummyres</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">units_present</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="s2">"units"</span><span class="p">)</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">arrs</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">units_present</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">"Exception during unit inference. Assuming no units."</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dummyres</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">infer_shape</span><span class="p">:</span>
            <span class="c1"># due to https://github.com/hgrecco/pint/issues/1037 innocent np.array operations on unit scalars can fail.</span>
            <span class="c1"># we can still attempt to infer shape by removing units prior to calling func.</span>
            <span class="n">arrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">arr</span><span class="o">.</span><span class="n">magnitude</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="s2">"magnitude"</span><span class="p">)</span> <span class="k">else</span> <span class="n">arr</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">arrs</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dummyres</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">arrs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># noqa</span>
                <span class="c1"># no more logging needed here</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="n">dummyres</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">infer_shape</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">dummyres</span><span class="p">):</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="n">dummyres</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">infer_shape</span> <span class="ow">and</span> <span class="n">dummyres</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">"Exception during shape inference. Using shape (1,)."</span><span class="p">)</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="p">()</span>
    <span class="c1"># unit inference</span>

    <span class="c1"># Determine chunkedges automatically</span>
    <span class="c1"># TODO: very messy and inefficient routine. improve some time.</span>
    <span class="c1"># TODO: Set entry_bytes_out</span>
    <span class="n">nbytes_dtype_out</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># TODO: hardcode 4 byte output dtype as estimate for now</span>
    <span class="n">entry_nbytes_out</span> <span class="o">=</span> <span class="n">nbytes_dtype_out</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>

    <span class="c1"># list_chunkedges refers to bounds of index intervals to be processed together</span>
    <span class="c1"># if idxlist is specified, then these indices do not have to refer to group indices.</span>
    <span class="c1"># if idxlist is given, we enforce that particle data is contiguous</span>
    <span class="c1"># by putting each idx from idxlist into its own chunk.</span>
    <span class="c1"># in the future, we should optimize this</span>
    <span class="k">if</span> <span class="n">idxlist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">list_chunkedges</span> <span class="o">=</span> <span class="p">[[</span><span class="n">idx</span><span class="p">,</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idxlist</span><span class="p">))]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">list_chunkedges</span> <span class="o">=</span> <span class="n">map_group_operation_get_chunkedges</span><span class="p">(</span>
            <span class="n">lengths</span><span class="p">,</span>
            <span class="n">entry_nbytes_in</span><span class="p">,</span>
            <span class="n">entry_nbytes_out</span><span class="p">,</span>
            <span class="n">cpucost_halo</span><span class="o">=</span><span class="n">cpucost_halo</span><span class="p">,</span>
            <span class="n">nchunks_min</span><span class="o">=</span><span class="n">nchunks_min</span><span class="p">,</span>
            <span class="n">chunksize_bytes</span><span class="o">=</span><span class="n">chunksize_bytes</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">minentry</span> <span class="o">=</span> <span class="n">offsets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">maxentry</span> <span class="o">=</span> <span class="n">offsets</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># the last particle that needs to be processed</span>

    <span class="c1"># chunks specify the number of groups in each chunk</span>
    <span class="n">chunks</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">list_chunkedges</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">())]</span>
    <span class="c1"># need to add chunk information for additional output axes if needed</span>
    <span class="n">new_axis</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,):</span>
        <span class="n">chunks</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">s</span><span class="p">,)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">shape</span><span class="p">]</span>
        <span class="n">new_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="c1"># slcoffsets = [offsets[chunkedge[0]] for chunkedge in list_chunkedges]</span>
    <span class="c1"># the actual length of relevant data in each chunk</span>
    <span class="n">slclengths</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">offsets</span><span class="p">[</span><span class="n">chunkedge</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">-</span> <span class="n">offsets</span><span class="p">[</span><span class="n">chunkedge</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">for</span> <span class="n">chunkedge</span> <span class="ow">in</span> <span class="n">list_chunkedges</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="n">idxlist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># the chunk length to be fed into map_blocks</span>
        <span class="n">tmplist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">idxlist</span><span class="p">,</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">lengths_all</span><span class="p">)]])</span>
        <span class="n">slclengths_map</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">offsets_all</span><span class="p">[</span><span class="n">tmplist</span><span class="p">[</span><span class="n">chunkedge</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span> <span class="o">-</span> <span class="n">offsets_all</span><span class="p">[</span><span class="n">tmplist</span><span class="p">[</span><span class="n">chunkedge</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>
            <span class="k">for</span> <span class="n">chunkedge</span> <span class="ow">in</span> <span class="n">list_chunkedges</span>
        <span class="p">]</span>
        <span class="n">slcoffsets_map</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">offsets_all</span><span class="p">[</span><span class="n">tmplist</span><span class="p">[</span><span class="n">chunkedge</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span> <span class="k">for</span> <span class="n">chunkedge</span> <span class="ow">in</span> <span class="n">list_chunkedges</span>
        <span class="p">]</span>
        <span class="n">slclengths_map</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">slcoffsets_map</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">slcoffsets_map</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">slclengths_map</span> <span class="o">=</span> <span class="n">slclengths</span>

    <span class="n">slcs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="n">chunkedge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">chunkedge</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">chunkedge</span> <span class="ow">in</span> <span class="n">list_chunkedges</span><span class="p">]</span>
    <span class="n">offsets_in_chunks</span> <span class="o">=</span> <span class="p">[</span><span class="n">offsets</span><span class="p">[</span><span class="n">slc</span><span class="p">]</span> <span class="o">-</span> <span class="n">offsets</span><span class="p">[</span><span class="n">slc</span><span class="o">.</span><span class="n">start</span><span class="p">]</span> <span class="k">for</span> <span class="n">slc</span> <span class="ow">in</span> <span class="n">slcs</span><span class="p">]</span>
    <span class="n">lengths_in_chunks</span> <span class="o">=</span> <span class="p">[</span><span class="n">lengths</span><span class="p">[</span><span class="n">slc</span><span class="p">]</span> <span class="k">for</span> <span class="n">slc</span> <span class="ow">in</span> <span class="n">slcs</span><span class="p">]</span>
    <span class="n">d_oic</span> <span class="o">=</span> <span class="n">delayed</span><span class="p">(</span><span class="n">offsets_in_chunks</span><span class="p">)</span>
    <span class="n">d_hic</span> <span class="o">=</span> <span class="n">delayed</span><span class="p">(</span><span class="n">lengths_in_chunks</span><span class="p">)</span>

    <span class="n">arrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">arrdict</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">minentry</span><span class="p">:</span><span class="n">maxentry</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fieldnames</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">arr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">arrs</span><span class="p">):</span>
        <span class="n">arrchunks</span> <span class="o">=</span> <span class="p">((</span><span class="nb">tuple</span><span class="p">(</span><span class="n">slclengths</span><span class="p">)),)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">arrchunks</span> <span class="o">=</span> <span class="n">arrchunks</span> <span class="o">+</span> <span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:],)</span>
        <span class="n">arrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">rechunk</span><span class="p">(</span><span class="n">chunks</span><span class="o">=</span><span class="n">arrchunks</span><span class="p">)</span>
    <span class="n">arrdims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">arrs</span><span class="p">])</span>

    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">arrdims</span> <span class="o">==</span> <span class="n">arrdims</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># Cannot handle different input dims for now</span>

    <span class="n">drop_axis</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">arrdims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">drop_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">arrdims</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">"dtype must be specified, dask will not be able to automatically determine this here."</span>
        <span class="p">)</span>

    <span class="n">calc</span> <span class="o">=</span> <span class="n">map_blocks</span><span class="p">(</span>
        <span class="n">wrap_func_scalar</span><span class="p">,</span>
        <span class="n">func</span><span class="p">,</span>
        <span class="n">d_oic</span><span class="p">,</span>
        <span class="n">d_hic</span><span class="p">,</span>
        <span class="o">*</span><span class="n">arrs</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
        <span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">,</span>
        <span class="n">new_axis</span><span class="o">=</span><span class="n">new_axis</span><span class="p">,</span>
        <span class="n">drop_axis</span><span class="o">=</span><span class="n">drop_axis</span><span class="p">,</span>
        <span class="n">func_output_shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>
        <span class="n">func_output_dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
        <span class="n">fill_value</span><span class="o">=</span><span class="n">fill_value</span><span class="p">,</span>
        <span class="n">output_units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">calc</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h5 id="scida.customs.arepo.dataset.map_group_operation_get_chunkedges" class="doc doc-heading">
<code class="highlight language-python"><span class="n">map_group_operation_get_chunkedges</span><span class="p">(</span><span class="n">lengths</span><span class="p">,</span> <span class="n">entry_nbytes_in</span><span class="p">,</span> <span class="n">entry_nbytes_out</span><span class="p">,</span> <span class="n">cpucost_halo</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">nchunks_min</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">chunksize_bytes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">

      <p>Compute the chunking of a halo operation.</p>
<h6 id="scida.customs.arepo.dataset.map_group_operation_get_chunkedges--parameters">Parameters</h6>
<div class="admonition lengths">
<p class="admonition-title">np.ndarray</p>
<p>The number of particles per halo.</p>
</div>
<p>entry_nbytes_in
entry_nbytes_out
cpucost_halo
nchunks_min
chunksize_bytes</p>
<h6 id="scida.customs.arepo.dataset.map_group_operation_get_chunkedges--returns">Returns</h6>

        <details class="quote">
          <summary>Source code in <code>scida/customs/arepo/dataset.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">map_group_operation_get_chunkedges</span><span class="p">(</span>
    <span class="n">lengths</span><span class="p">,</span>
    <span class="n">entry_nbytes_in</span><span class="p">,</span>
    <span class="n">entry_nbytes_out</span><span class="p">,</span>
    <span class="n">cpucost_halo</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">nchunks_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">chunksize_bytes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Compute the chunking of a halo operation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lengths: np.ndarray</span>
<span class="sd">        The number of particles per halo.</span>
<span class="sd">    entry_nbytes_in</span>
<span class="sd">    entry_nbytes_out</span>
<span class="sd">    cpucost_halo</span>
<span class="sd">    nchunks_min</span>
<span class="sd">    chunksize_bytes</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    """</span>
    <span class="n">cpucost_particle</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># we only care about ratio, so keep particle cost fixed.</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="n">cpucost_particle</span> <span class="o">*</span> <span class="n">lengths</span> <span class="o">+</span> <span class="n">cpucost_halo</span>
    <span class="n">sumcost</span> <span class="o">=</span> <span class="n">cost</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>

    <span class="c1"># let's allow a maximal chunksize of 16 times the dask default setting for an individual array [here: multiple]</span>
    <span class="k">if</span> <span class="n">chunksize_bytes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">chunksize_bytes</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">parse_humansize</span><span class="p">(</span><span class="n">dask</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"array.chunk-size"</span><span class="p">))</span>
    <span class="n">cost_memory</span> <span class="o">=</span> <span class="n">entry_nbytes_in</span> <span class="o">*</span> <span class="n">lengths</span> <span class="o">+</span> <span class="n">entry_nbytes_out</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cost_memory</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">chunksize_bytes</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">"Some halo requires more memory than allowed (</span><span class="si">%i</span><span class="s2"> allowed, </span><span class="si">%i</span><span class="s2"> requested). Consider overriding "</span>
            <span class="s2">"chunksize_bytes."</span> <span class="o">%</span> <span class="p">(</span><span class="n">chunksize_bytes</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cost_memory</span><span class="p">))</span>
        <span class="p">)</span>

    <span class="n">nchunks</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cost_memory</span><span class="p">)</span> <span class="o">/</span> <span class="n">chunksize_bytes</span><span class="p">))</span>
    <span class="n">nchunks</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mf">1.3</span> <span class="o">*</span> <span class="n">nchunks</span><span class="p">))</span>  <span class="c1"># fudge factor</span>
    <span class="k">if</span> <span class="n">nchunks_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nchunks</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">nchunks_min</span><span class="p">,</span> <span class="n">nchunks</span><span class="p">)</span>
    <span class="n">targetcost</span> <span class="o">=</span> <span class="n">sumcost</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">nchunks</span>  <span class="c1"># chunk target cost = total cost / nchunks</span>

    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">sumcost</span> <span class="o">%</span> <span class="n">targetcost</span><span class="p">)</span>  <span class="c1"># find whenever exceeding modulo target cost</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">arr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">idx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">sumcost</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sumcost</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">list_chunkedges</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">list_chunkedges</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">idx</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">idx</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]])</span>

    <span class="n">list_chunkedges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span>
        <span class="n">memorycost_limiter</span><span class="p">(</span><span class="n">cost_memory</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">list_chunkedges</span><span class="p">,</span> <span class="n">chunksize_bytes</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># make sure we did not lose any halos.</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span>
        <span class="o">~</span><span class="p">(</span><span class="n">list_chunkedges</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">list_chunkedges</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
            <span class="nb">bool</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">list_chunkedges</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h5 id="scida.customs.arepo.dataset.memorycost_limiter" class="doc doc-heading">
<code class="highlight language-python"><span class="n">memorycost_limiter</span><span class="p">(</span><span class="n">cost_memory</span><span class="p">,</span> <span class="n">cost_cpu</span><span class="p">,</span> <span class="n">list_chunkedges</span><span class="p">,</span> <span class="n">cost_memory_max</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">

      <p>If a chunk too memory expensive, split into equal cpu expense operations.</p>

        <details class="quote">
          <summary>Source code in <code>scida/customs/arepo/dataset.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">memorycost_limiter</span><span class="p">(</span><span class="n">cost_memory</span><span class="p">,</span> <span class="n">cost_cpu</span><span class="p">,</span> <span class="n">list_chunkedges</span><span class="p">,</span> <span class="n">cost_memory_max</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""If a chunk too memory expensive, split into equal cpu expense operations."""</span>
    <span class="n">list_chunkedges_new</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">chunkedges</span> <span class="ow">in</span> <span class="n">list_chunkedges</span><span class="p">:</span>
        <span class="n">slc</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">chunkedges</span><span class="p">)</span>
        <span class="n">totcost_mem</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cost_memory</span><span class="p">[</span><span class="n">slc</span><span class="p">])</span>
        <span class="n">list_chunkedges_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chunkedges</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">totcost_mem</span> <span class="o">&gt;</span> <span class="n">cost_memory_max</span><span class="p">:</span>
            <span class="n">sumcost</span> <span class="o">=</span> <span class="n">cost_cpu</span><span class="p">[</span><span class="n">slc</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
            <span class="n">sumcost</span> <span class="o">/=</span> <span class="n">sumcost</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">slc</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sumcost</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="n">chunkedges</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">idx</span> <span class="o">==</span> <span class="n">chunkedges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">idx</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">chunkedges1</span> <span class="o">=</span> <span class="p">[</span><span class="n">chunkedges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">idx</span><span class="p">]</span>
            <span class="n">chunkedges2</span> <span class="o">=</span> <span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">chunkedges</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="n">chunkedges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">idx</span> <span class="o">==</span> <span class="n">chunkedges</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"This should not happen."</span><span class="p">)</span>
            <span class="n">list_chunkedges_new</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">list_chunkedges_new</span> <span class="o">+=</span> <span class="n">memorycost_limiter</span><span class="p">(</span>
                <span class="n">cost_memory</span><span class="p">,</span> <span class="n">cost_cpu</span><span class="p">,</span> <span class="p">[</span><span class="n">chunkedges1</span><span class="p">],</span> <span class="n">cost_memory_max</span>
            <span class="p">)</span>
            <span class="n">list_chunkedges_new</span> <span class="o">+=</span> <span class="n">memorycost_limiter</span><span class="p">(</span>
                <span class="n">cost_memory</span><span class="p">,</span> <span class="n">cost_cpu</span><span class="p">,</span> <span class="p">[</span><span class="n">chunkedges2</span><span class="p">],</span> <span class="n">cost_memory_max</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">list_chunkedges_new</span>
</code></pre></div>
        </details>
    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h4 id="scida.customs.arepo.helpers" class="doc doc-heading">
        <code>helpers</code>



</h4>

    <div class="doc doc-contents ">




  <div class="doc doc-children">









  <div class="doc doc-object doc-function">



<h5 id="scida.customs.arepo.helpers.part_type_num" class="doc doc-heading">
<code class="highlight language-python"><span class="n">part_type_num</span><span class="p">(</span><span class="n">ptype</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">

      <p>Mapping between common names and numeric particle types.</p>

        <details class="quote">
          <summary>Source code in <code>scida/customs/arepo/helpers.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">part_type_num</span><span class="p">(</span><span class="n">ptype</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Mapping between common names and numeric particle types."""</span>
    <span class="n">ptype</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ptype</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"PartType"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ptype</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">ptype</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">ptype</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"gas"</span><span class="p">,</span> <span class="s2">"cells"</span><span class="p">]:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">ptype</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"dm"</span><span class="p">,</span> <span class="s2">"darkmatter"</span><span class="p">]:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">ptype</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"dmlowres"</span><span class="p">]:</span>
        <span class="k">return</span> <span class="mi">2</span>  <span class="c1"># only zoom simulations, not present in full periodic boxes</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">ptype</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"tracer"</span><span class="p">,</span> <span class="s2">"tracers"</span><span class="p">,</span> <span class="s2">"tracermc"</span><span class="p">,</span> <span class="s2">"trmc"</span><span class="p">]:</span>
        <span class="k">return</span> <span class="mi">3</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">ptype</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"star"</span><span class="p">,</span> <span class="s2">"stars"</span><span class="p">,</span> <span class="s2">"stellar"</span><span class="p">]:</span>
        <span class="k">return</span> <span class="mi">4</span>  <span class="c1"># only those with GFM_StellarFormationTime&gt;0</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">ptype</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"wind"</span><span class="p">]:</span>
        <span class="k">return</span> <span class="mi">4</span>  <span class="c1"># only those with GFM_StellarFormationTime&lt;0</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">ptype</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"bh"</span><span class="p">,</span> <span class="s2">"bhs"</span><span class="p">,</span> <span class="s2">"blackhole"</span><span class="p">,</span> <span class="s2">"blackholes"</span><span class="p">,</span> <span class="s2">"black"</span><span class="p">]:</span>
        <span class="k">return</span> <span class="mi">5</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">ptype</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"all"</span><span class="p">]:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>




  <div class="doc doc-object doc-module">



<h4 id="scida.customs.arepo.series" class="doc doc-heading">
        <code>series</code>



</h4>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h5 id="scida.customs.arepo.series.ArepoSimulation" class="doc doc-heading">
        <code>
ArepoSimulation            (<a class="autorefs autorefs-internal" title="scida.customs.gadgetstyle.series.GadgetStyleSimulation" href="#scida.customs.gadgetstyle.series.GadgetStyleSimulation">GadgetStyleSimulation</a>)
        </code>



</h5>

    <div class="doc doc-contents ">

      <p>A series representing an arepo simulation.</p>

        <details class="quote">
          <summary>Source code in <code>scida/customs/arepo/series.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ArepoSimulation</span><span class="p">(</span><span class="n">GadgetStyleSimulation</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""A series representing an arepo simulation."""</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">async_caching</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">interface_kwargs</span><span class="p">):</span>
        <span class="c1"># choose parent folder as path if we are passed "output" dir</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"output"</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
        <span class="n">prefix_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">paths</span><span class="o">=</span><span class="s2">"snapdir"</span><span class="p">,</span> <span class="n">gpaths</span><span class="o">=</span><span class="s2">"group"</span><span class="p">)</span>
        <span class="n">arg_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">gpaths</span><span class="o">=</span><span class="s2">"catalog"</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">path</span><span class="p">,</span>
            <span class="n">prefix_dict</span><span class="o">=</span><span class="n">prefix_dict</span><span class="p">,</span>
            <span class="n">arg_dict</span><span class="o">=</span><span class="n">arg_dict</span><span class="p">,</span>
            <span class="n">lazy</span><span class="o">=</span><span class="n">lazy</span><span class="p">,</span>
            <span class="n">async_caching</span><span class="o">=</span><span class="n">async_caching</span><span class="p">,</span>
            <span class="o">**</span><span class="n">interface_kwargs</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">validate_path</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CandidateStatus</span><span class="p">:</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">NO</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">NO</span>
        <span class="n">fns</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">"gizmo_parameters.txt"</span> <span class="ow">in</span> <span class="n">fns</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">NO</span>
        <span class="n">sprefixs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"snapdir"</span><span class="p">,</span> <span class="s2">"snapshot"</span><span class="p">]</span>
        <span class="n">opath</span> <span class="o">=</span> <span class="n">path</span>
        <span class="k">if</span> <span class="s2">"output"</span> <span class="ow">in</span> <span class="n">fns</span><span class="p">:</span>
            <span class="n">opath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">"output"</span><span class="p">)</span>
        <span class="n">folders</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">opath</span><span class="p">)</span>
        <span class="n">folders</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">folders</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">opath</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">folders</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">sprefixs</span><span class="p">]):</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">MAYBE</span>
        <span class="k">return</span> <span class="n">valid</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">













  </div>

    </div>

  </div>







  </div>

    </div>

  </div>




  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="scida.customs.gadgetstyle" class="doc doc-heading">
        <code>gadgetstyle</code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h3>

    <div class="doc doc-contents ">




  <div class="doc doc-children">










  <div class="doc doc-object doc-module">



<h4 id="scida.customs.gadgetstyle.dataset" class="doc doc-heading">
        <code>dataset</code>



</h4>

    <div class="doc doc-contents ">




  <div class="doc doc-children">








  <div class="doc doc-object doc-class">



<h5 id="scida.customs.gadgetstyle.dataset.GadgetStyleSnapshot" class="doc doc-heading">
        <code>
GadgetStyleSnapshot            (<a class="autorefs autorefs-internal" title="scida.interface.Dataset" href="#scida.interface.Dataset">Dataset</a>)
        </code>



</h5>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>scida/customs/gadgetstyle/dataset.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">GadgetStyleSnapshot</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="s2">"auto"</span><span class="p">,</span> <span class="n">virtualcache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""We define gadget-style snapshots as nbody/hydrodynamical simulation snapshots that follow</span>
<span class="sd">        the common /PartType0, /PartType1 grouping scheme."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boxsize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="n">chunksize</span><span class="p">,</span> <span class="n">virtualcache</span><span class="o">=</span><span class="n">virtualcache</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">defaultattributes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"config"</span><span class="p">,</span> <span class="s2">"header"</span><span class="p">,</span> <span class="s2">"parameters"</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_raw</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">defaultattributes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_raw</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="k">if</span> <span class="s2">"BoxSize"</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">boxsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">"BoxSize"</span><span class="p">]</span>
                <span class="k">elif</span> <span class="s2">"Boxsize"</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">boxsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">"Boxsize"</span><span class="p">]</span>

        <span class="n">sanity_check</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"sanity_check"</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">key_nparts</span> <span class="o">=</span> <span class="s2">"NumPart_Total"</span>
        <span class="n">key_nparts_hw</span> <span class="o">=</span> <span class="s2">"NumPart_Total_HighWord"</span>
        <span class="k">if</span> <span class="n">sanity_check</span> <span class="ow">and</span> <span class="n">key_nparts</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="ow">and</span> <span class="n">key_nparts_hw</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
            <span class="n">nparts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">key_nparts_hw</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="mi">32</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">key_nparts</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nparts</span><span class="p">):</span>
                <span class="n">pkey</span> <span class="o">=</span> <span class="s2">"PartType</span><span class="si">%i</span><span class="s2">"</span> <span class="o">%</span> <span class="n">i</span>
                <span class="k">if</span> <span class="n">pkey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                    <span class="n">pdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">pkey</span><span class="p">]</span>
                    <span class="n">fkey</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">pdata</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                    <span class="n">nparts_loaded</span> <span class="o">=</span> <span class="n">pdata</span><span class="p">[</span><span class="n">fkey</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">nparts_loaded</span> <span class="o">!=</span> <span class="n">n</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s2">"Number of particles in header (</span><span class="si">%i</span><span class="s2">) does not match number of particles loaded (</span><span class="si">%i</span><span class="s2">) "</span>
                            <span class="s2">"for particle type </span><span class="si">%i</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">nparts_loaded</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_get_fileprefix</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Get the fileprefix used to identify files belonging to given dataset.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path: str, os.PathLike</span>
<span class="sd">            path to check</span>
<span class="sd">        kwargs</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">""</span>  <span class="c1"># nothing to do, we have a single file, not a directory</span>
        <span class="c1"># order matters: groups will be taken before fof_subhalo, requires py&gt;3.7 for dict order</span>
        <span class="n">prfxs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"groups"</span><span class="p">,</span> <span class="s2">"fof_subhalo"</span><span class="p">,</span> <span class="s2">"snap"</span><span class="p">]</span>
        <span class="n">prfxs_prfx_sim</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">prfxs</span><span class="p">)</span>
        <span class="n">files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="n">prfxs_lst</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">"^(\w*)_(\d*)"</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">prfxs_lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">prfxs_lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">prfxs_prfx_sim</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prfxs_lst</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">s</span><span class="p">)]</span>
        <span class="n">prfxs</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">prfxs_lst</span><span class="p">)</span>
        <span class="n">prfxs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">prfxs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prfxs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">"We have more than one prefix avail: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">prfxs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">prfxs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">""</span>
        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">prfxs</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span><span class="s2">"groups"</span><span class="p">,</span> <span class="s2">"fof_subhalo_tab"</span><span class="p">}:</span>
            <span class="k">return</span> <span class="s2">"groups"</span>  <span class="c1"># "groups" over "fof_subhalo_tab"</span>
        <span class="k">return</span> <span class="n">prfxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">validate_path</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">expect_grp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CandidateStatus</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Check if path is valid for this interface.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path: str, os.PathLike</span>
<span class="sd">            path to check</span>
<span class="sd">        args</span>
<span class="sd">        kwargs</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">        """</span>
        <span class="n">path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">possibly_valid</span> <span class="o">=</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">NO</span>
        <span class="n">iszarr</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">".zarr"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">".hdf5"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">iszarr</span><span class="p">:</span>
            <span class="n">possibly_valid</span> <span class="o">=</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">MAYBE</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">sufxs</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"."</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">iszarr</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">sufxs</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">possibly_valid</span> <span class="o">=</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">NO</span>
            <span class="k">if</span> <span class="n">sufxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"hdf5"</span><span class="p">:</span>
                <span class="n">possibly_valid</span> <span class="o">=</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">MAYBE</span>
        <span class="k">if</span> <span class="n">possibly_valid</span> <span class="o">!=</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">NO</span><span class="p">:</span>
            <span class="n">metadata_raw</span> <span class="o">=</span> <span class="n">load_metadata</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="c1"># need some silly combination of attributes to be sure</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">k</span> <span class="ow">in</span> <span class="n">metadata_raw</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"/Header"</span><span class="p">]]):</span>
                <span class="c1"># identifying snapshot or group catalog</span>
                <span class="n">is_snap</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">k</span> <span class="ow">in</span> <span class="n">metadata_raw</span><span class="p">[</span><span class="s2">"/Header"</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"NumPart_ThisFile"</span><span class="p">,</span> <span class="s2">"NumPart_Total"</span><span class="p">]</span>
                    <span class="p">]</span>
                <span class="p">)</span>
                <span class="n">is_grp</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">k</span> <span class="ow">in</span> <span class="n">metadata_raw</span><span class="p">[</span><span class="s2">"/Header"</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"Ngroups_ThisFile"</span><span class="p">,</span> <span class="s2">"Ngroups_Total"</span><span class="p">]</span>
                    <span class="p">]</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">is_grp</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">MAYBE</span>
                <span class="k">if</span> <span class="n">is_snap</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">expect_grp</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">MAYBE</span>
        <span class="k">return</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">NO</span>

    <span class="k">def</span> <span class="nf">register_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parttype</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">""</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">register_field</span><span class="p">(</span><span class="n">parttype</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">merge_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">secondobj</span><span class="p">,</span> <span class="n">fieldname_suffix</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span> <span class="n">root_group</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
        <span class="k">if</span> <span class="n">root_group</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">root_group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">_containers</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">add_container</span><span class="p">(</span><span class="n">root_group</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">root_group</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">secondobj</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="n">fieldname_suffix</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">secondobj</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">"Not overwriting field '</span><span class="si">%s</span><span class="s2">' during merge_data."</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
            <span class="n">secondobj</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fieldrecipes_kwargs</span><span class="p">[</span><span class="s2">"snap"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">merge_hints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">secondobj</span><span class="p">):</span>
        <span class="c1"># merge hints from snap and catalog</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">secondobj</span><span class="o">.</span><span class="n">hints</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">h</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hints</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hints</span><span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="n">secondobj</span><span class="o">.</span><span class="n">hints</span><span class="p">[</span><span class="n">h</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hints</span><span class="p">[</span><span class="n">h</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="c1"># merge dicts</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">secondobj</span><span class="o">.</span><span class="n">hints</span><span class="p">[</span><span class="n">h</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hints</span><span class="p">[</span><span class="n">h</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">hints</span><span class="p">[</span><span class="n">h</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">secondobj</span><span class="o">.</span><span class="n">hints</span><span class="p">[</span><span class="n">h</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>  <span class="c1"># nothing to do; we do not overwrite with catalog props</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_clean_metadata_from_raw</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">rawmetadata</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Set metadata from raw metadata.</span>
<span class="sd">        """</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="s2">"/Header"</span> <span class="ow">in</span> <span class="n">rawmetadata</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">rawmetadata</span><span class="p">[</span><span class="s2">"/Header"</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">"Redshift"</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                <span class="n">metadata</span><span class="p">[</span><span class="s2">"redshift"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s2">"Redshift"</span><span class="p">])</span>
                <span class="n">metadata</span><span class="p">[</span><span class="s2">"z"</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">"redshift"</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">"BoxSize"</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                <span class="c1"># can be scalar or array</span>
                <span class="n">metadata</span><span class="p">[</span><span class="s2">"boxsize"</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s2">"BoxSize"</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">"Time"</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                <span class="n">metadata</span><span class="p">[</span><span class="s2">"time"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s2">"Time"</span><span class="p">])</span>
                <span class="n">metadata</span><span class="p">[</span><span class="s2">"t"</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">"time"</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">metadata</span>

    <span class="k">def</span> <span class="nf">_set_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Set metadata from header and config.</span>
<span class="sd">        """</span>
        <span class="n">md</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_metadata_from_raw</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata_raw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">md</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h6 id="scida.customs.gadgetstyle.dataset.GadgetStyleSnapshot.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">chunksize</span> <span class="o">=</span> <span class="s1">'auto'</span><span class="p">,</span> <span class="n">virtualcache</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h6>

    <div class="doc doc-contents ">

      <p>We define gadget-style snapshots as nbody/hydrodynamical simulation snapshots that follow
the common /PartType0, /PartType1 grouping scheme.</p>

        <details class="quote">
          <summary>Source code in <code>scida/customs/gadgetstyle/dataset.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="s2">"auto"</span><span class="p">,</span> <span class="n">virtualcache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""We define gadget-style snapshots as nbody/hydrodynamical simulation snapshots that follow</span>
<span class="sd">    the common /PartType0, /PartType1 grouping scheme."""</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">boxsize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="n">chunksize</span><span class="p">,</span> <span class="n">virtualcache</span><span class="o">=</span><span class="n">virtualcache</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">defaultattributes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"config"</span><span class="p">,</span> <span class="s2">"header"</span><span class="p">,</span> <span class="s2">"parameters"</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_raw</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">defaultattributes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_raw</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">"BoxSize"</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">boxsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">"BoxSize"</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s2">"Boxsize"</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">boxsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">"Boxsize"</span><span class="p">]</span>

    <span class="n">sanity_check</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"sanity_check"</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">key_nparts</span> <span class="o">=</span> <span class="s2">"NumPart_Total"</span>
    <span class="n">key_nparts_hw</span> <span class="o">=</span> <span class="s2">"NumPart_Total_HighWord"</span>
    <span class="k">if</span> <span class="n">sanity_check</span> <span class="ow">and</span> <span class="n">key_nparts</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="ow">and</span> <span class="n">key_nparts_hw</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
        <span class="n">nparts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">key_nparts_hw</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="mi">32</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">key_nparts</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nparts</span><span class="p">):</span>
            <span class="n">pkey</span> <span class="o">=</span> <span class="s2">"PartType</span><span class="si">%i</span><span class="s2">"</span> <span class="o">%</span> <span class="n">i</span>
            <span class="k">if</span> <span class="n">pkey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="n">pdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">pkey</span><span class="p">]</span>
                <span class="n">fkey</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">pdata</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                <span class="n">nparts_loaded</span> <span class="o">=</span> <span class="n">pdata</span><span class="p">[</span><span class="n">fkey</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">nparts_loaded</span> <span class="o">!=</span> <span class="n">n</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">"Number of particles in header (</span><span class="si">%i</span><span class="s2">) does not match number of particles loaded (</span><span class="si">%i</span><span class="s2">) "</span>
                        <span class="s2">"for particle type </span><span class="si">%i</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">nparts_loaded</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>






  <div class="doc doc-object doc-method">



<h6 id="scida.customs.gadgetstyle.dataset.GadgetStyleSnapshot.validate_path" class="doc doc-heading">
<code class="highlight language-python"><span class="n">validate_path</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">expect_grp</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CandidateStatus</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-classmethod"><code>classmethod</code></small>
  </span>

</h6>

    <div class="doc doc-contents ">

      <p>Check if path is valid for this interface.
Parameters</p>
<hr>
<div class="admonition path">
<p class="admonition-title">str, os.PathLike</p>
<p>path to check</p>
</div>
<p>args
kwargs</p>
<h6 id="scida.customs.gadgetstyle.dataset.GadgetStyleSnapshot.validate_path--returns">Returns</h6>
<p>bool</p>

        <details class="quote">
          <summary>Source code in <code>scida/customs/gadgetstyle/dataset.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">validate_path</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">expect_grp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CandidateStatus</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Check if path is valid for this interface.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path: str, os.PathLike</span>
<span class="sd">        path to check</span>
<span class="sd">    args</span>
<span class="sd">    kwargs</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">    """</span>
    <span class="n">path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">possibly_valid</span> <span class="o">=</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">NO</span>
    <span class="n">iszarr</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">".zarr"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">".hdf5"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">iszarr</span><span class="p">:</span>
        <span class="n">possibly_valid</span> <span class="o">=</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">MAYBE</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">sufxs</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"."</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">iszarr</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">sufxs</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">possibly_valid</span> <span class="o">=</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">NO</span>
        <span class="k">if</span> <span class="n">sufxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"hdf5"</span><span class="p">:</span>
            <span class="n">possibly_valid</span> <span class="o">=</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">MAYBE</span>
    <span class="k">if</span> <span class="n">possibly_valid</span> <span class="o">!=</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">NO</span><span class="p">:</span>
        <span class="n">metadata_raw</span> <span class="o">=</span> <span class="n">load_metadata</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># need some silly combination of attributes to be sure</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">k</span> <span class="ow">in</span> <span class="n">metadata_raw</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"/Header"</span><span class="p">]]):</span>
            <span class="c1"># identifying snapshot or group catalog</span>
            <span class="n">is_snap</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">k</span> <span class="ow">in</span> <span class="n">metadata_raw</span><span class="p">[</span><span class="s2">"/Header"</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"NumPart_ThisFile"</span><span class="p">,</span> <span class="s2">"NumPart_Total"</span><span class="p">]</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="n">is_grp</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">k</span> <span class="ow">in</span> <span class="n">metadata_raw</span><span class="p">[</span><span class="s2">"/Header"</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"Ngroups_ThisFile"</span><span class="p">,</span> <span class="s2">"Ngroups_Total"</span><span class="p">]</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">is_grp</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">MAYBE</span>
            <span class="k">if</span> <span class="n">is_snap</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">expect_grp</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">MAYBE</span>
    <span class="k">return</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">NO</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h4 id="scida.customs.gadgetstyle.series" class="doc doc-heading">
        <code>series</code>



</h4>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h5 id="scida.customs.gadgetstyle.series.GadgetStyleSimulation" class="doc doc-heading">
        <code>
GadgetStyleSimulation            (<a class="autorefs autorefs-internal" title="scida.series.DatasetSeries" href="#scida.series.DatasetSeries">DatasetSeries</a>)
        </code>



</h5>

    <div class="doc doc-contents ">

      <p>A series representing a gadgetstyle simulation.</p>

        <details class="quote">
          <summary>Source code in <code>scida/customs/gadgetstyle/series.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">GadgetStyleSimulation</span><span class="p">(</span><span class="n">DatasetSeries</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""A series representing a gadgetstyle simulation."""</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path</span><span class="p">,</span>
        <span class="n">prefix_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">subpath_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">arg_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">lazy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">async_caching</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">interface_kwargs</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prefix_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prefix_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">subpath_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">subpath_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">arg_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">arg_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">exists</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Specified path '</span><span class="si">%s</span><span class="s2">' does not exist."</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
        <span class="n">paths_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">[</span><span class="n">prefix_dict</span><span class="p">,</span> <span class="n">subpath_dict</span><span class="p">,</span> <span class="n">arg_dict</span><span class="p">]:</span>
            <span class="n">keys</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">subpath</span> <span class="o">=</span> <span class="n">subpath_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s2">"output"</span><span class="p">)</span>
            <span class="n">sp</span> <span class="o">=</span> <span class="n">p</span> <span class="o">/</span> <span class="n">subpath</span>

            <span class="n">prefix</span> <span class="o">=</span> <span class="n">_get_snapshotfolder_prefix</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">sp</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">"paths"</span><span class="p">:</span>
                    <span class="k">continue</span>  <span class="c1"># do not require optional sources</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Specified path '</span><span class="si">%s</span><span class="s2">' does not exist."</span> <span class="o">%</span> <span class="p">(</span><span class="n">p</span> <span class="o">/</span> <span class="n">subpath</span><span class="p">))</span>
            <span class="n">fns</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
            <span class="n">prfxs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"_"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fns</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">)])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prfxs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">"Could not find any files with prefix '</span><span class="si">%s</span><span class="s2">' in '</span><span class="si">%s</span><span class="s2">'."</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">sp</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">prfx</span> <span class="o">=</span> <span class="n">prfxs</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

            <span class="n">paths</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sp</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">prfx</span> <span class="o">+</span> <span class="s2">"_*"</span><span class="p">)])</span>
            <span class="c1"># sometimes there are backup folders with different suffix, exclude those.</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">p</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"_"</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">".hdf5"</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">paths_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">paths</span>

        <span class="c1"># make sure we have the same amount of paths respectively</span>
        <span class="n">length</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">paths_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="n">paths_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">length</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>

        <span class="n">paths</span> <span class="o">=</span> <span class="n">paths_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"paths"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">paths</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Could not find any snapshot paths."</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="n">_determine_type</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">mixins</span> <span class="o">=</span> <span class="n">_determine_mixins</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="n">create_MixinDataset</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">mixins</span><span class="p">)</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">arg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s2">"catalog"</span><span class="p">):</span> <span class="n">paths_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">paths_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">interface_kwargs</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">paths</span><span class="p">,</span> <span class="n">datasetclass</span><span class="o">=</span><span class="bp">cls</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="n">lazy</span><span class="p">,</span> <span class="n">async_caching</span><span class="o">=</span><span class="n">async_caching</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">












  </div>

    </div>

  </div>







  </div>

    </div>

  </div>




  </div>

    </div>

  </div>




  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="scida.discovertypes" class="doc doc-heading">
        <code>discovertypes</code>



</h2>

    <div class="doc doc-contents ">




  <div class="doc doc-children">








  <div class="doc doc-object doc-class">



<h3 id="scida.discovertypes.CandidateStatus" class="doc doc-heading">
        <code>
CandidateStatus            (<span title="enum.Enum">Enum</span>)
        </code>



</h3>

    <div class="doc doc-contents ">

      <p>An enumeration.</p>

        <details class="quote">
          <summary>Source code in <code>scida/discovertypes.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">CandidateStatus</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">NO</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># definitely not a candidate</span>
    <span class="n">MAYBE</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># not sure yet</span>
    <span class="n">YES</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># yes, this is a candidate</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">














  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="scida.fields" class="doc doc-heading">
        <code>fields</code>



</h2>

    <div class="doc doc-contents ">




  <div class="doc doc-children">








  <div class="doc doc-object doc-class">



<h3 id="scida.fields.FieldContainer" class="doc doc-heading">
        <code>
FieldContainer            (<span title="collections.abc.MutableMapping">MutableMapping</span>)
        </code>



</h3>

    <div class="doc doc-contents ">

      <p>A mutable collection of fields. Attempt to construct from derived fields recipes
if needed.</p>

        <details class="quote">
          <summary>Source code in <code>scida/fields.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">FieldContainer</span><span class="p">(</span><span class="n">MutableMapping</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""A mutable collection of fields. Attempt to construct from derived fields recipes</span>
<span class="sd">    if needed."""</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="n">fieldrecipes_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">containers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">aliases</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">withunits</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">ureg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FieldContainer</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">aliases</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">aliases</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">fieldrecipes_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fieldrecipes_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span> <span class="o">=</span> <span class="n">aliases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"name"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">da</span><span class="o">.</span><span class="n">Array</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fieldrecipes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fieldlength</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fieldrecipes_kwargs</span> <span class="o">=</span> <span class="n">fieldrecipes_kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">withunits</span> <span class="o">=</span> <span class="n">withunits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ureg</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pint</span><span class="o">.</span><span class="n">UnitRegistry</span><span class="p">]</span> <span class="o">=</span> <span class="n">ureg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_containers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span>
            <span class="nb">str</span><span class="p">,</span> <span class="n">FieldContainer</span>
        <span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># other containers as subgroups</span>
        <span class="k">if</span> <span class="n">containers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">containers</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_container</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">internals</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"uid"</span><span class="p">]</span>  <span class="c1"># names of internal fields/groups</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>

    <span class="k">def</span> <span class="nf">set_ureg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ureg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ureg</span> <span class="o">=</span> <span class="n">ureg</span>

    <span class="k">def</span> <span class="nf">get_ureg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">withgroups</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">withrecipes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">withinternal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="s2">"units"</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="n">pint</span><span class="o">.</span><span class="n">Unit</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ureg</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">_REGISTRY</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ureg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ureg</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">copy_skeleton</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FieldContainer</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">FieldContainer</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">cntr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_containers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">res</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">cntr</span><span class="o">.</span><span class="n">copy_skeleton</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">rep</span> <span class="o">=</span> <span class="s2">""</span>
        <span class="n">length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fieldlength</span>
        <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fieldcount</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">ncontainers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_containers</span><span class="p">)</span>
        <span class="n">statstrs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">statstrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"fields: </span><span class="si">%i</span><span class="s2">"</span> <span class="o">%</span> <span class="n">count</span><span class="p">)</span>
            <span class="n">statstrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"entries: </span><span class="si">%i</span><span class="s2">"</span> <span class="o">%</span> <span class="n">length</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ncontainers</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">statstrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"containers: </span><span class="si">%i</span><span class="s2">"</span> <span class="o">%</span> <span class="n">ncontainers</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">statstrs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">statstr</span> <span class="o">=</span> <span class="s2">", "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">statstrs</span><span class="p">)</span>
            <span class="n">rep</span> <span class="o">+=</span> <span class="n">sprint</span><span class="p">((</span><span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="s2">"+"</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="s2">"(</span><span class="si">%s</span><span class="s2">)"</span> <span class="o">%</span> <span class="n">statstr</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_containers</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_containers</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">rep</span> <span class="o">+=</span> <span class="n">v</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rep</span>

    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">FieldContainer</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"Can only merge FieldContainers."</span><span class="p">)</span>
        <span class="c1"># TODO: support nested containers</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">collection</span><span class="o">.</span><span class="n">_containers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_containers</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">overwrite</span><span class="p">:</span>
                <span class="n">c1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_containers</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">c2</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">_containers</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">c1</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">_containers</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">c2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_containers</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">c1</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">c2</span><span class="o">.</span><span class="n">_fields</span><span class="p">)</span>
            <span class="n">c1</span><span class="o">.</span><span class="n">_fieldrecipes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">c2</span><span class="o">.</span><span class="n">_fieldrecipes</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fieldcount</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rcps</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fieldrecipes</span><span class="p">)</span>
        <span class="n">flds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">internals</span><span class="p">])</span>
        <span class="n">ntot</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rcps</span> <span class="o">|</span> <span class="n">flds</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ntot</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fieldlength</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fieldlength</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fieldlength</span>
        <span class="n">fvals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="n">itr</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">fvals</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fvals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># can we infer from recipes?</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fieldrecipes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># get first recipe</span>
                <span class="n">name</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fieldrecipes</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                <span class="n">first</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getitem</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">evaluate_recipe</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">first</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">itr</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">first</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fieldlength</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fieldlength</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">withgroups</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">withrecipes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">withinternal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">withfields</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
        <span class="n">fieldkeys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">recipekeys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">withfields</span><span class="p">:</span>
            <span class="n">fieldkeys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">withinternal</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ikey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">internals</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ikey</span> <span class="ow">in</span> <span class="n">fieldkeys</span><span class="p">:</span>
                        <span class="n">fieldkeys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ikey</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">withrecipes</span><span class="p">:</span>
            <span class="n">recipekeys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fieldrecipes</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">fieldkeys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">fieldkeys</span><span class="p">)</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">recipekeys</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">withgroups</span><span class="p">:</span>
            <span class="n">groupkeys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_containers</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">fieldkeys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">fieldkeys</span><span class="p">)</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">groupkeys</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">fieldkeys</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">withrecipes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">withfields</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">evaluate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getitem</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">evaluate_recipe</span><span class="o">=</span><span class="n">evaluate</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">withrecipes</span><span class="o">=</span><span class="n">withrecipes</span><span class="p">,</span> <span class="n">withfields</span><span class="o">=</span><span class="n">withfields</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evaluate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getitem</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">evaluate_recipe</span><span class="o">=</span><span class="n">evaluate</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">register_field</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">containernames</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span>
        <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># we only construct field upon first call to it (default)</span>
        <span class="c1"># if to_containers, we register to the respective children containers</span>
        <span class="n">containers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">containernames</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">containers</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_containers</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">containernames</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">containernames</span> <span class="o">==</span> <span class="s2">"all"</span><span class="p">:</span>
            <span class="n">containers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_containers</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">containernames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">containers</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">containernames</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>  <span class="c1"># just a single container as a string?</span>
            <span class="n">containers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_containers</span><span class="p">[</span><span class="n">containernames</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Unknown type."</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="k">for</span> <span class="n">container</span> <span class="ow">in</span> <span class="n">containers</span><span class="p">:</span>
                <span class="n">drvfields</span> <span class="o">=</span> <span class="n">container</span><span class="o">.</span><span class="n">_fieldrecipes</span>
                <span class="n">drvfields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">DerivedFieldRecipe</span><span class="p">(</span>
                    <span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">func</span>

        <span class="k">return</span> <span class="n">decorator</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">FieldContainer</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_containers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">DerivedFieldRecipe</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fieldrecipes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getitem</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Return a string representation of the object.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">        """</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="s2">""</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s2">"FieldContainer[containers=</span><span class="si">%s</span><span class="s2">, fields=</span><span class="si">%s</span><span class="s2">]"</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_containers</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fieldcount</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">txt</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dataframe</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">dss</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">fields</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">idim</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="c1"># could still be an index two 2D dataset</span>
                <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">while</span> <span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span><span class="o">.</span><span class="n">isnumeric</span><span class="p">():</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Field '</span><span class="si">%s</span><span class="s2">' not found"</span> <span class="o">%</span> <span class="n">k</span><span class="p">)</span>
                <span class="n">idim</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">:])</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">:])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;=</span> <span class="mi">2</span>  <span class="c1"># cannot support more than 2 here...</span>
            <span class="k">if</span> <span class="n">idim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"No second dimensional index for </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">k</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">idim</span> <span class="o">&gt;=</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">"Second dimensional index </span><span class="si">%i</span><span class="s2"> not defined for </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">idim</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">idim</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">idim</span> <span class="o">==</span> <span class="n">i</span><span class="p">:</span>
                        <span class="n">dss</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dss</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="n">dfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">dd</span><span class="o">.</span><span class="n">from_dask_array</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dss</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="n">ddf</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ddf</span>

    <span class="k">def</span> <span class="nf">add_alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">add_container</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">tkwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">"name"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tkwargs</span><span class="p">:</span>
            <span class="n">tkwargs</span><span class="p">[</span><span class="s2">"name"</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_containers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">FieldContainer</span><span class="p">(</span>
            <span class="n">fieldrecipes_kwargs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fieldrecipes_kwargs</span><span class="p">,</span>
            <span class="n">withunits</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">withunits</span><span class="p">,</span>
            <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="o">**</span><span class="n">tkwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_containers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">set_ureg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_ureg</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_getitem</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">force_derived</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">update_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">evaluate_recipe</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_containers</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_containers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_derived</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fieldrecipes</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">evaluate_recipe</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fieldrecipes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instantiate_field</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">update_dict</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span>
                <span class="k">return</span> <span class="n">field</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">"Unknown field '</span><span class="si">%s</span><span class="s2">'"</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_instantiate_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fieldrecipes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">func</span>
        <span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fieldrecipes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">units</span>
        <span class="n">accept_kwargs</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">func</span><span class="p">)</span><span class="o">.</span><span class="n">varkw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">func_kwargs</span> <span class="o">=</span> <span class="n">get_kwargs</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="n">dkwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fieldrecipes_kwargs</span>
        <span class="n">ureg</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s2">"ureg"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dkwargs</span><span class="p">:</span>
            <span class="n">ureg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ureg</span><span class="p">()</span>
            <span class="n">dkwargs</span><span class="p">[</span><span class="s2">"ureg"</span><span class="p">]</span> <span class="o">=</span> <span class="n">ureg</span>
        <span class="c1"># first, we overwrite all optional arguments with class instance defaults where func kwarg is None</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">dkwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="nb">set</span><span class="p">(</span><span class="n">dkwargs</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">([</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">func_kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="p">}</span>
        <span class="c1"># next, we add all optional arguments if func is accepting **kwargs and varname not yet in signature</span>
        <span class="k">if</span> <span class="n">accept_kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="o">**</span><span class="p">{</span>
                    <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dkwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">func</span><span class="p">)</span><span class="o">.</span><span class="n">args</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="c1"># finally, instantiate field</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">withunits</span> <span class="ow">and</span> <span class="n">units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="s2">"units"</span><span class="p">):</span>
                <span class="n">field</span> <span class="o">=</span> <span class="n">field</span> <span class="o">*</span> <span class="n">units</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">units</span> <span class="o">!=</span> <span class="n">units</span><span class="p">:</span>
                    <span class="c1"># if unit is present, but unit from metadata is unknown,</span>
                    <span class="c1"># we stick with the former</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="s2">"units"</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">units</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"unknown"</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
                        <span class="k">except</span> <span class="n">pint</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">DimensionalityError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="s2">"Field '</span><span class="si">%s</span><span class="s2">' units '</span><span class="si">%s</span><span class="s2">' do not match '</span><span class="si">%s</span><span class="s2">'"</span>
                                <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>
                            <span class="p">)</span>
        <span class="k">return</span> <span class="n">field</span>

    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fieldrecipes</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fieldrecipes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_containers</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_containers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">"Unknown key '</span><span class="si">%s</span><span class="s2">'"</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_derived</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force_derived</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fieldrecipes</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">allow_derived</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">"Field '</span><span class="si">%s</span><span class="s2">' is derived (allow_derived=False)"</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getitem</span><span class="p">(</span>
                    <span class="n">key</span><span class="p">,</span> <span class="n">force_derived</span><span class="o">=</span><span class="n">force_derived</span><span class="p">,</span> <span class="n">update_dict</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">value</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">

















  <div class="doc doc-object doc-method">



<h4 id="scida.fields.FieldContainer.__repr__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h4>

    <div class="doc doc-contents ">

      <p>Return a string representation of the object.
Returns</p>
<hr>
<p>str</p>

        <details class="quote">
          <summary>Source code in <code>scida/fields.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Return a string representation of the object.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">    """</span>
    <span class="n">txt</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="n">txt</span> <span class="o">+=</span> <span class="s2">"FieldContainer[containers=</span><span class="si">%s</span><span class="s2">, fields=</span><span class="si">%s</span><span class="s2">]"</span> <span class="o">%</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_containers</span><span class="p">),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fieldcount</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">txt</span>
</code></pre></div>
        </details>
    </div>

  </div>







  <div class="doc doc-object doc-method">



<h4 id="scida.fields.FieldContainer.get" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">allow_derived</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">force_derived</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span></code>


</h4>

    <div class="doc doc-contents ">

      <p>D.get(k[,d]) -&gt; D[k] if k in D, else d.  d defaults to None.</p>

        <details class="quote">
          <summary>Source code in <code>scida/fields.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_derived</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force_derived</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fieldrecipes</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">allow_derived</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">"Field '</span><span class="si">%s</span><span class="s2">' is derived (allow_derived=False)"</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getitem</span><span class="p">(</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">force_derived</span><span class="o">=</span><span class="n">force_derived</span><span class="p">,</span> <span class="n">update_dict</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>
</code></pre></div>
        </details>
    </div>

  </div>






  <div class="doc doc-object doc-method">



<h4 id="scida.fields.FieldContainer.items" class="doc doc-heading">
<code class="highlight language-python"><span class="n">items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">withrecipes</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">withfields</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">evaluate</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span></code>


</h4>

    <div class="doc doc-contents ">

      <p>D.items() -&gt; a set-like object providing a view on D's items</p>

        <details class="quote">
          <summary>Source code in <code>scida/fields.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">withrecipes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">withfields</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">evaluate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getitem</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">evaluate_recipe</span><span class="o">=</span><span class="n">evaluate</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">withrecipes</span><span class="o">=</span><span class="n">withrecipes</span><span class="p">,</span> <span class="n">withfields</span><span class="o">=</span><span class="n">withfields</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="scida.fields.FieldContainer.keys" class="doc doc-heading">
<code class="highlight language-python"><span class="n">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">withgroups</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">withrecipes</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">withinternal</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">withfields</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span></code>


</h4>

    <div class="doc doc-contents ">

      <p>D.keys() -&gt; a set-like object providing a view on D's keys</p>

        <details class="quote">
          <summary>Source code in <code>scida/fields.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">keys</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">withgroups</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">withrecipes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">withinternal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">withfields</span><span class="o">=</span><span class="kc">True</span>
<span class="p">):</span>
    <span class="n">fieldkeys</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">recipekeys</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">withfields</span><span class="p">:</span>
        <span class="n">fieldkeys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">withinternal</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ikey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">internals</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ikey</span> <span class="ow">in</span> <span class="n">fieldkeys</span><span class="p">:</span>
                    <span class="n">fieldkeys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ikey</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">withrecipes</span><span class="p">:</span>
        <span class="n">recipekeys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fieldrecipes</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">fieldkeys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">fieldkeys</span><span class="p">)</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">recipekeys</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">withgroups</span><span class="p">:</span>
        <span class="n">groupkeys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_containers</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">fieldkeys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">fieldkeys</span><span class="p">)</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">groupkeys</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">fieldkeys</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>






  <div class="doc doc-object doc-method">



<h4 id="scida.fields.FieldContainer.values" class="doc doc-heading">
<code class="highlight language-python"><span class="n">values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evaluate</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span></code>


</h4>

    <div class="doc doc-contents ">

      <p>D.values() -&gt; an object providing a view on D's values</p>

        <details class="quote">
          <summary>Source code in <code>scida/fields.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evaluate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getitem</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">evaluate_recipe</span><span class="o">=</span><span class="n">evaluate</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>




  <div class="doc doc-object doc-class">



<h3 id="scida.fields.FieldType" class="doc doc-heading">
        <code>
FieldType            (<span title="enum.Enum">Enum</span>)
        </code>



</h3>

    <div class="doc doc-contents ">

      <p>An enumeration.</p>

        <details class="quote">
          <summary>Source code in <code>scida/fields.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">FieldType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">INTERNAL</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">IO</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">DERIVED</span> <span class="o">=</span> <span class="mi">3</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">














  </div>

    </div>

  </div>








  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="scida.helpers_hdf5" class="doc doc-heading">
        <code>helpers_hdf5</code>



</h2>

    <div class="doc doc-contents ">




  <div class="doc doc-children">









  <div class="doc doc-object doc-function">



<h3 id="scida.helpers_hdf5.create_mergedhdf5file" class="doc doc-heading">
<code class="highlight language-python"><span class="n">create_mergedhdf5file</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">max_workers</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">virtual</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">groupwise_shape</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Creates a virtual hdf5 file from list of given files. Virtual by default.</p>
<h5 id="scida.helpers_hdf5.create_mergedhdf5file--parameters">Parameters</h5>
<p>fn: file to write to
files: files to merge
max_workers: parallel workers to process files
virtual: whether to create linked ("virtual") dataset on disk (otherwise copy)
groupwise_shape: Require shapes to be the same within a group</p>
<h5 id="scida.helpers_hdf5.create_mergedhdf5file--returns">Returns</h5>

        <details class="quote">
          <summary>Source code in <code>scida/helpers_hdf5.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">create_mergedhdf5file</span><span class="p">(</span>
    <span class="n">fn</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">max_workers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">virtual</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">groupwise_shape</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Creates a virtual hdf5 file from list of given files. Virtual by default.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fn: file to write to</span>
<span class="sd">    files: files to merge</span>
<span class="sd">    max_workers: parallel workers to process files</span>
<span class="sd">    virtual: whether to create linked ("virtual") dataset on disk (otherwise copy)</span>
<span class="sd">    groupwise_shape: Require shapes to be the same within a group</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">max_workers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># read from config</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>
        <span class="n">max_workers</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"nthreads"</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
    <span class="c1"># first obtain all datasets and groups</span>
    <span class="n">trees</span> <span class="o">=</span> <span class="p">[{}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">))]</span>

    <span class="k">with</span> <span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">max_workers</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">walk_hdf5file</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">trees</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="n">groups</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">item</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">result</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">r</span><span class="p">[</span><span class="s2">"groups"</span><span class="p">]])</span>
    <span class="n">datasets</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">result</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">r</span><span class="p">[</span><span class="s2">"datasets"</span><span class="p">]])</span>

    <span class="k">def</span> <span class="nf">todct</span><span class="p">(</span><span class="n">lst</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">[</span><span class="s2">"datasets"</span><span class="p">]}</span>

    <span class="n">dcts</span> <span class="o">=</span> <span class="p">[</span><span class="n">todct</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span> <span class="k">for</span> <span class="n">lst</span> <span class="ow">in</span> <span class="n">result</span><span class="p">]</span>
    <span class="n">shapes</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">((</span><span class="n">d</span><span class="p">,</span> <span class="p">{})</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">shps</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">shapes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">i</span><span class="p">:</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]})</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="p">[</span><span class="n">shps</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">dct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">datasets</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dct</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dcts</span><span class="p">)]</span>
    <span class="n">dtypes</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">dtps</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]})</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="p">[</span><span class="n">dtps</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">dct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">datasets</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dct</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dcts</span><span class="p">)]</span>

    <span class="c1"># get shapes of the respective chunks</span>
    <span class="n">chunks</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">shapes</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">chunks</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="n">k</span><span class="p">,</span> <span class="n">shapes</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">shapes</span><span class="p">[</span><span class="n">field</span><span class="p">]]</span>
    <span class="n">groupchunks</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># assert that all datasets in a given group have the same chunks.</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">groups</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">group</span> <span class="o">==</span> <span class="s2">"/"</span><span class="p">:</span>
            <span class="n">group</span> <span class="o">=</span> <span class="s2">""</span>  <span class="c1"># this is needed to have consistent levels for 0th level</span>
        <span class="n">groupfields</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">shapes</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">group</span><span class="p">)]</span>
        <span class="n">groupfields</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">groupfields</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">group</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)]</span>
        <span class="n">groupfields</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">groupfields</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">groupfields</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">arr0</span> <span class="o">=</span> <span class="n">chunks</span><span class="p">[</span><span class="n">groupfields</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">groupfields</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">chunks</span><span class="p">[</span><span class="n">field</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">groupwise_shape</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">arr0</span><span class="p">,</span> <span class="n">arr</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Requiring same shape (see 'groupwise_shape' flag)"</span><span class="p">)</span>
            <span class="c1"># then save the chunking information for this group</span>
            <span class="n">groupchunks</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr0</span>

    <span class="c1"># next fill merger file</span>
    <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">,</span> <span class="n">libver</span><span class="o">=</span><span class="s2">"latest"</span><span class="p">)</span> <span class="k">as</span> <span class="n">hf</span><span class="p">:</span>
        <span class="c1"># create groups</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">groups</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">group</span> <span class="o">==</span> <span class="s2">"/"</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># nothing to do.</span>
            <span class="n">hf</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
            <span class="n">groupfields</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">field</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">shapes</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">group</span><span class="p">)</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">group</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">groupfields</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># fill fields</span>
            <span class="k">if</span> <span class="n">virtual</span><span class="p">:</span>
                <span class="c1"># for virtual datasets, iterate over all fields and concat each file to virtual dataset</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">groupfields</span><span class="p">:</span>
                    <span class="n">totentries</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">[</span><span class="n">field</span><span class="p">]])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                    <span class="n">newshape</span> <span class="o">=</span> <span class="p">(</span><span class="n">totentries</span><span class="p">,)</span> <span class="o">+</span> <span class="n">shapes</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">shapes</span><span class="p">[</span><span class="n">field</span><span class="p">]))][</span>
                        <span class="mi">1</span><span class="p">:</span>
                    <span class="p">]</span>

                    <span class="c1"># create virtual sources</span>
                    <span class="n">vsources</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">shapes</span><span class="p">[</span><span class="n">field</span><span class="p">]:</span>
                        <span class="n">vsources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">h5py</span><span class="o">.</span><span class="n">VirtualSource</span><span class="p">(</span>
                                <span class="n">files</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>
                                <span class="n">name</span><span class="o">=</span><span class="n">field</span><span class="p">,</span>
                                <span class="n">shape</span><span class="o">=</span><span class="n">shapes</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="n">k</span><span class="p">],</span>
                                <span class="n">dtype</span><span class="o">=</span><span class="n">dtypes</span><span class="p">[</span><span class="n">field</span><span class="p">],</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="n">layout</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">VirtualLayout</span><span class="p">(</span>
                        <span class="n">shape</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">newshape</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtypes</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
                    <span class="p">)</span>

                    <span class="c1"># fill virtual dataset</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">vsource</span> <span class="ow">in</span> <span class="n">vsources</span><span class="p">:</span>
                        <span class="n">length</span> <span class="o">=</span> <span class="n">vsource</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">layout</span><span class="p">[</span><span class="n">offset</span> <span class="p">:</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">length</span><span class="p">]</span> <span class="o">=</span> <span class="n">vsource</span>
                        <span class="n">offset</span> <span class="o">+=</span> <span class="n">length</span>
                    <span class="k">assert</span> <span class="p">(</span>
                        <span class="n">newshape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">offset</span>
                    <span class="p">)</span>  <span class="c1"># make sure we filled the array up fully.</span>
                    <span class="n">hf</span><span class="o">.</span><span class="n">create_virtual_dataset</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">layout</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># copied dataset. For performance, we iterate differently: Loop over each file's fields</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">groupfields</span><span class="p">:</span>
                    <span class="n">totentries</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">[</span><span class="n">field</span><span class="p">]])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                    <span class="n">extrashapes</span> <span class="o">=</span> <span class="n">shapes</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">shapes</span><span class="p">[</span><span class="n">field</span><span class="p">]))][</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="n">newshape</span> <span class="o">=</span> <span class="p">(</span><span class="n">totentries</span><span class="p">,)</span> <span class="o">+</span> <span class="n">extrashapes</span>
                    <span class="n">hf</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">newshape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtypes</span><span class="p">[</span><span class="n">field</span><span class="p">])</span>
                <span class="n">counters</span> <span class="o">=</span> <span class="p">{</span><span class="n">field</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">groupfields</span><span class="p">}</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">fl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
                    <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fl</span><span class="p">)</span> <span class="k">as</span> <span class="n">hf_load</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">groupfields</span><span class="p">:</span>
                            <span class="n">n</span> <span class="o">=</span> <span class="n">shapes</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="n">offset</span> <span class="o">=</span> <span class="n">counters</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
                            <span class="n">hf</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="n">offset</span> <span class="p">:</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">hf_load</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
                            <span class="n">counters</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">n</span>

        <span class="c1"># save information regarding chunks</span>
        <span class="n">grp</span> <span class="o">=</span> <span class="n">hf</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">"_chunks"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">groupchunks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">grp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="c1"># write the attributes</span>
        <span class="c1"># find attributes that change across data sets</span>
        <span class="n">attrs_key_lists</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s2">"attrs"</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">result</span>
        <span class="p">]</span>  <span class="c1"># attribute paths for each file</span>
        <span class="n">attrspaths_all</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="o">*</span><span class="n">attrs_key_lists</span><span class="p">)</span>
        <span class="n">attrspaths_intersec</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">attrspaths_all</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="o">*</span><span class="n">attrs_key_lists</span><span class="p">)</span>
        <span class="n">attrspath_diff</span> <span class="o">=</span> <span class="n">attrspaths_all</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">attrspaths_intersec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attrspaths_all</span> <span class="o">!=</span> <span class="n">attrspaths_intersec</span><span class="p">:</span>
            <span class="c1"># if difference only stems from missing datasets (and their assoc. attrs); thats fine</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">attrspath_diff</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">datasets</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="s2">"Some attribute paths not present in each partial data file."</span>
                <span class="p">)</span>
        <span class="c1"># check for common key+values across all files</span>
        <span class="n">attrs_same</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">attrs_differ</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">nfiles</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">apath</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">attrspaths_all</span><span class="p">):</span>
            <span class="n">attrs_same</span><span class="p">[</span><span class="n">apath</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">attrs_differ</span><span class="p">[</span><span class="n">apath</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">attrsnames</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>
                <span class="o">*</span><span class="p">[</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">"attrs"</span><span class="p">][</span><span class="n">apath</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nfiles</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">apath</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">"attrs"</span><span class="p">]</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">attrsnames</span><span class="p">:</span>
                <span class="c1"># we ignore apaths and k existing in some files.</span>
                <span class="n">attrvallist</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">"attrs"</span><span class="p">][</span><span class="n">apath</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nfiles</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">apath</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">"attrs"</span><span class="p">]</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">"attrs"</span><span class="p">][</span><span class="n">apath</span><span class="p">]</span>
                <span class="p">]</span>
                <span class="n">attrval0</span> <span class="o">=</span> <span class="n">attrvallist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attrval0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">attrval0</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attrvallist</span><span class="p">])):</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> has different values."</span> <span class="o">%</span> <span class="p">(</span><span class="n">apath</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
                        <span class="n">attrs_differ</span><span class="p">[</span><span class="n">apath</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">attrvallist</span><span class="p">)</span>
                        <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">same</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">attrvallist</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attrval0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">):</span>
                        <span class="c1"># for floats we do not require binary equality</span>
                        <span class="c1"># (we had some incident...)</span>
                        <span class="n">same</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">attrval0</span><span class="p">,</span> <span class="n">attrvallist</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">same</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> has different values."</span> <span class="o">%</span> <span class="p">(</span><span class="n">apath</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
                        <span class="n">attrs_differ</span><span class="p">[</span><span class="n">apath</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">attrvallist</span><span class="p">)</span>
                        <span class="k">continue</span>
                <span class="n">attrs_same</span><span class="p">[</span><span class="n">apath</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">attrval0</span>
        <span class="k">for</span> <span class="n">apath</span> <span class="ow">in</span> <span class="n">attrspaths_all</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attrs_same</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">apath</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">hf</span><span class="p">[</span><span class="n">apath</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attrs_differ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">apath</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">hf</span><span class="p">[</span><span class="n">apath</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
</code></pre></div>
        </details>
    </div>

  </div>










  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="scida.helpers_misc" class="doc doc-heading">
        <code>helpers_misc</code>



</h2>

    <div class="doc doc-contents ">




  <div class="doc doc-children">









  <div class="doc doc-object doc-class">



<h3 id="scida.helpers_misc.RecursiveNamespace" class="doc doc-heading">
        <code>
RecursiveNamespace            (<span title="types.SimpleNamespace">SimpleNamespace</span>)
        </code>



</h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>scida/helpers_misc.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">RecursiveNamespace</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">SimpleNamespace</span><span class="p">):</span>
    <span class="c1"># see https://stackoverflow.com/questions/2597278/python-load-variables-in-a-dict-into-namespace</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Create a SimpleNamespace recursively"""</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__elt</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>

    <span class="k">def</span> <span class="nf">__elt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elt</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Recurse into elt to create leaf namespace objects"""</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elt</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="o">**</span><span class="n">elt</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">elt</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__elt</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">elt</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">elt</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="scida.helpers_misc.RecursiveNamespace.__init__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h4>

    <div class="doc doc-contents ">

      <p>Create a SimpleNamespace recursively</p>

        <details class="quote">
          <summary>Source code in <code>scida/helpers_misc.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Create a SimpleNamespace recursively"""</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__elt</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>









  <div class="doc doc-object doc-function">



<h3 id="scida.helpers_misc.map_blocks" class="doc doc-heading">
<code class="highlight language-python"><span class="n">map_blocks</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">token</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">chunks</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">drop_axis</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">new_axis</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">enforce_ndim</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">output_units</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>map_blocks with units</p>

        <details class="quote">
          <summary>Source code in <code>scida/helpers_misc.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">map_blocks</span><span class="p">(</span>
    <span class="n">func</span><span class="p">,</span>
    <span class="o">*</span><span class="n">args</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">token</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">chunks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">drop_axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">new_axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">enforce_ndim</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">meta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">output_units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">"""map_blocks with units"""</span>
    <span class="n">da_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
        <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
        <span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">,</span>
        <span class="n">drop_axis</span><span class="o">=</span><span class="n">drop_axis</span><span class="p">,</span>
        <span class="n">new_axis</span><span class="o">=</span><span class="n">new_axis</span><span class="p">,</span>
        <span class="n">enforce_ndim</span><span class="o">=</span><span class="n">enforce_ndim</span><span class="p">,</span>
        <span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">map_blocks</span><span class="p">(</span>
        <span class="n">func</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="o">**</span><span class="n">da_kwargs</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">output_units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="s2">"magnitude"</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"map_blocks output already has units, overwriting."</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">magnitude</span> <span class="o">*</span> <span class="n">output_units</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">res</span> <span class="o">*</span> <span class="n">output_units</span>

    <span class="k">return</span> <span class="n">res</span>
</code></pre></div>
        </details>
    </div>

  </div>




  <div class="doc doc-object doc-function">



<h3 id="scida.helpers_misc.sprint" class="doc doc-heading">
<code class="highlight language-python"><span class="n">sprint</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>print to string</p>

        <details class="quote">
          <summary>Source code in <code>scida/helpers_misc.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">sprint</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""print to string"""</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">output</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">contents</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
    <span class="n">output</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">contents</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h2 id="scida.interface" class="doc doc-heading">
        <code>interface</code>



</h2>

    <div class="doc doc-contents ">




  <div class="doc doc-children">








  <div class="doc doc-object doc-class">



<h3 id="scida.interface.BaseDataset" class="doc doc-heading">
        <code>
BaseDataset        </code>



</h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>scida/interface.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">BaseDataset</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">MixinMeta</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path</span><span class="p">,</span>
        <span class="n">chunksize</span><span class="o">=</span><span class="s2">"auto"</span><span class="p">,</span>
        <span class="n">virtualcache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">overwritecache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">fileprefix</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span>
        <span class="n">hints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hints</span> <span class="o">=</span> <span class="n">hints</span> <span class="k">if</span> <span class="n">hints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># need this 'tempfile' reference to keep garbage collection away for the tempfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tempfile</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunksize</span> <span class="o">=</span> <span class="n">chunksize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">virtualcache</span> <span class="o">=</span> <span class="n">virtualcache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overwritecache</span> <span class="o">=</span> <span class="n">overwritecache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">withunits</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"units"</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Let's find the data and metadata for the object at 'path'</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_raw</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">FieldContainer</span><span class="p">(</span><span class="n">withunits</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">withunits</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Specified path '</span><span class="si">%s</span><span class="s2">' does not exist."</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

        <span class="n">loadkwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">overwrite</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">overwritecache</span><span class="p">,</span>
            <span class="n">fileprefix</span><span class="o">=</span><span class="n">fileprefix</span><span class="p">,</span>
            <span class="n">virtualcache</span><span class="o">=</span><span class="n">virtualcache</span><span class="p">,</span>
            <span class="n">derivedfields_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">snap</span><span class="o">=</span><span class="bp">self</span><span class="p">),</span>
            <span class="n">token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__dask_tokenize__</span><span class="p">(),</span>
            <span class="n">withunits</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">withunits</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="s2">"choose_prefix"</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">loadkwargs</span><span class="p">[</span><span class="s2">"choose_prefix"</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">"choose_prefix"</span><span class="p">]</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">scida</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">loadkwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_raw</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tempfile</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># any identifying metadata?</span>
        <span class="k">if</span> <span class="s2">"dsname"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hints</span><span class="p">:</span>
            <span class="n">candidates</span> <span class="o">=</span> <span class="n">check_config_for_dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata_raw</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dsname</span> <span class="o">=</span> <span class="n">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">"Dataset is identified as '</span><span class="si">%s</span><span class="s2">'."</span> <span class="o">%</span> <span class="n">dsname</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hints</span><span class="p">[</span><span class="s2">"dsname"</span><span class="p">]</span> <span class="o">=</span> <span class="n">dsname</span>

    <span class="k">def</span> <span class="nf">_info_custom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Custom information to be printed by info() method.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        """</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">listfields</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Print information about the dataset.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        listfields: bool</span>
<span class="sd">            If True, list all fields in the dataset.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        """</span>
        <span class="n">rep</span> <span class="o">=</span> <span class="s2">""</span>
        <span class="n">rep</span> <span class="o">+=</span> <span class="s2">"class: "</span> <span class="o">+</span> <span class="n">sprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repr_dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">props</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">rep</span> <span class="o">+=</span> <span class="n">sprint</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info_custom</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rep</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info_custom</span><span class="p">()</span>
        <span class="n">rep</span> <span class="o">+=</span> <span class="n">sprint</span><span class="p">(</span><span class="s2">"=== data ==="</span><span class="p">)</span>
        <span class="n">rep</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"root"</span><span class="p">)</span>
        <span class="n">rep</span> <span class="o">+=</span> <span class="n">sprint</span><span class="p">(</span><span class="s2">"============"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">rep</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_repr_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Return a dictionary of properties to be printed by __repr__ method.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">        """</span>
        <span class="n">props</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">props</span><span class="p">[</span><span class="s2">"source"</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span>
        <span class="k">return</span> <span class="n">props</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Return a string representation of the object.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">        """</span>
        <span class="n">props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repr_dict</span><span class="p">()</span>
        <span class="n">clsname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">clsname</span> <span class="o">+</span> <span class="s2">"["</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">props</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="s2">"</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">, "</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s2">"]"</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_repr_pretty_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cycle</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Pretty print representation for IPython.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        p</span>
<span class="sd">        cycle</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        """</span>
        <span class="n">rpr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">rpr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init_subclass__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init_subclass__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"Delay"</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># nothing to register for Delay objects</span>
        <span class="k">if</span> <span class="s2">"Mixin"</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># do not register classes with Mixins</span>
        <span class="n">dataset_type_registry</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">validate_path</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Validate whether the given path is a valid path for this dataset.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path</span>
<span class="sd">        args</span>
<span class="sd">        kwargs</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        """</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Hash for Dataset instance to be derived from the file location.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">        """</span>
        <span class="c1"># determinstic hash; note that hash() on a string is no longer deterministic in python3.</span>
        <span class="n">hash_value</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">"utf-8"</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(),</span> <span class="mi">16</span><span class="p">)</span>
            <span class="o">%</span> <span class="mi">10</span><span class="o">**</span><span class="mi">10</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">hash_value</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__dask_tokenize__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Token for dask to be derived -- naively from the file location.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__hash__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">return_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FieldContainer</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Return the data container.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">fname</span><span class="p">,</span>
        <span class="n">fields</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
            <span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">da</span><span class="o">.</span><span class="n">Array</span><span class="p">]]],</span> <span class="n">FieldContainer</span>
        <span class="p">]</span> <span class="o">=</span> <span class="s2">"all"</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">zarr_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cast_uints</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">extra_attrs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Save the dataset to a file using the 'zarr' format.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fname: str</span>
<span class="sd">            Filename to save to.</span>
<span class="sd">        fields: str or dict</span>
<span class="sd">            dictionary of dask arrays to save. If equal to 'all', save all fields in current dataset.</span>
<span class="sd">        overwrite</span>
<span class="sd">            overwrite existing file</span>
<span class="sd">        zarr_kwargs</span>
<span class="sd">            optional arguments to pass to zarr</span>
<span class="sd">        cast_uints</span>
<span class="sd">            need to potentially cast uints to ints for some compressions; TODO: clean this up</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        """</span>
        <span class="c1"># We use zarr, as this way we have support to directly write into the file by the workers</span>
        <span class="c1"># (rather than passing back the data chunk over the scheduler to the interface)</span>
        <span class="c1"># Also, this way we can leverage new features, such as a large variety of compression methods.</span>
        <span class="c1"># cast_uints: if true, we cast uints to ints; needed for some compressions (particularly zfp)</span>
        <span class="k">if</span> <span class="n">zarr_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">zarr_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">store</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">DirectoryStore</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="o">**</span><span class="n">zarr_kwargs</span><span class="p">)</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>

        <span class="c1"># Metadata</span>
        <span class="n">defaultattributes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"Config"</span><span class="p">,</span> <span class="s2">"Header"</span><span class="p">,</span> <span class="s2">"Parameters"</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">dctname</span> <span class="ow">in</span> <span class="n">defaultattributes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dctname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
                <span class="n">grp</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">dctname</span><span class="p">)</span>
                <span class="n">dct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">dctname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dct</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">make_serializable</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="n">grp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">if</span> <span class="n">extra_attrs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">extra_attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">root</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="c1"># Data</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ptypes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">ptypes</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fields</span> <span class="o">==</span> <span class="s2">"all"</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Invalid field specifier."</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Invalid type for fields."</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ptypes</span><span class="p">:</span>
            <span class="n">root</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fields</span> <span class="o">==</span> <span class="s2">"all"</span><span class="p">:</span>
                <span class="n">fieldkeys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="n">p</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">fieldkeys</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fieldkeys</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">fieldkeys</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="n">p</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">arr</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="s2">"magnitude"</span><span class="p">):</span>  <span class="c1"># if we have units, remove those here</span>
                    <span class="c1"># TODO: save units in metadata!</span>
                    <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">magnitude</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">)):</span>
                    <span class="n">arr</span><span class="o">.</span><span class="n">compute_chunk_sizes</span><span class="p">()</span>  <span class="c1"># very inefficient (have to do it separately for every array)</span>
                    <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">rechunk</span><span class="p">(</span><span class="n">chunks</span><span class="o">=</span><span class="s2">"auto"</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cast_uints</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">:</span>
                        <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">arr</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">:</span>
                        <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
                <span class="n">task</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">to_zarr</span><span class="p">(</span>
                    <span class="n">arr</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">compute</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
                <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="n">dask</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="scida.interface.BaseDataset.__dask_tokenize__" class="doc doc-heading">
<code class="highlight language-python"><span class="n">__dask_tokenize__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h4>

    <div class="doc doc-contents ">

      <p>Token for dask to be derived -- naively from the file location.
Returns</p>
<hr>
<p>int</p>

        <details class="quote">
          <summary>Source code in <code>scida/interface.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">__dask_tokenize__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Token for dask to be derived -- naively from the file location.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__hash__</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>




  <div class="doc doc-object doc-method">



<h4 id="scida.interface.BaseDataset.__hash__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h4>

    <div class="doc doc-contents ">

      <p>Hash for Dataset instance to be derived from the file location.</p>
<h6 id="scida.interface.BaseDataset.__hash__--returns">Returns</h6>
<p>int</p>

        <details class="quote">
          <summary>Source code in <code>scida/interface.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Hash for Dataset instance to be derived from the file location.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">    """</span>
    <span class="c1"># determinstic hash; note that hash() on a string is no longer deterministic in python3.</span>
    <span class="n">hash_value</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">int</span><span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">"utf-8"</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(),</span> <span class="mi">16</span><span class="p">)</span>
        <span class="o">%</span> <span class="mi">10</span><span class="o">**</span><span class="mi">10</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">hash_value</span>
</code></pre></div>
        </details>
    </div>

  </div>




  <div class="doc doc-object doc-method">



<h4 id="scida.interface.BaseDataset.__init_subclass__" class="doc doc-heading">
<code class="highlight language-python"><span class="n">__init_subclass__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-classmethod"><code>classmethod</code></small>
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h4>

    <div class="doc doc-contents ">

      <p>This method is called when a class is subclassed.</p>
<p>The default implementation does nothing. It may be
overridden to extend subclasses.</p>

        <details class="quote">
          <summary>Source code in <code>scida/interface.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">__init_subclass__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init_subclass__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"Delay"</span><span class="p">:</span>
        <span class="k">return</span>  <span class="c1"># nothing to register for Delay objects</span>
    <span class="k">if</span> <span class="s2">"Mixin"</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span>
        <span class="k">return</span>  <span class="c1"># do not register classes with Mixins</span>
    <span class="n">dataset_type_registry</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="scida.interface.BaseDataset.__repr__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h4>

    <div class="doc doc-contents ">

      <p>Return a string representation of the object.
Returns</p>
<hr>
<p>str</p>

        <details class="quote">
          <summary>Source code in <code>scida/interface.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Return a string representation of the object.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">    """</span>
    <span class="n">props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repr_dict</span><span class="p">()</span>
    <span class="n">clsname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">clsname</span> <span class="o">+</span> <span class="s2">"["</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">props</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="s2">"</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">, "</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s2">"]"</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="scida.interface.BaseDataset.info" class="doc doc-heading">
<code class="highlight language-python"><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">listfields</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span></code>


</h4>

    <div class="doc doc-contents ">

      <p>Print information about the dataset.
Parameters</p>
<hr>
<div class="admonition listfields">
<p class="admonition-title">bool</p>
<p>If True, list all fields in the dataset.</p>
</div>
<h6 id="scida.interface.BaseDataset.info--returns">Returns</h6>

        <details class="quote">
          <summary>Source code in <code>scida/interface.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">listfields</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Print information about the dataset.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    listfields: bool</span>
<span class="sd">        If True, list all fields in the dataset.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    """</span>
    <span class="n">rep</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="n">rep</span> <span class="o">+=</span> <span class="s2">"class: "</span> <span class="o">+</span> <span class="n">sprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repr_dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">props</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">rep</span> <span class="o">+=</span> <span class="n">sprint</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info_custom</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rep</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info_custom</span><span class="p">()</span>
    <span class="n">rep</span> <span class="o">+=</span> <span class="n">sprint</span><span class="p">(</span><span class="s2">"=== data ==="</span><span class="p">)</span>
    <span class="n">rep</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"root"</span><span class="p">)</span>
    <span class="n">rep</span> <span class="o">+=</span> <span class="n">sprint</span><span class="p">(</span><span class="s2">"============"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">rep</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="scida.interface.BaseDataset.return_data" class="doc doc-heading">
<code class="highlight language-python"><span class="n">return_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FieldContainer</span></code>


</h4>

    <div class="doc doc-contents ">

      <p>Return the data container.
Returns</p>
<hr>

        <details class="quote">
          <summary>Source code in <code>scida/interface.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">return_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FieldContainer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Return the data container.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    """</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="scida.interface.BaseDataset.save" class="doc doc-heading">
<code class="highlight language-python"><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">fields</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">dask</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Array</span><span class="p">]]],</span> <span class="n">scida</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">FieldContainer</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'all'</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">zarr_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cast_uints</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">extra_attrs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span></code>


</h4>

    <div class="doc doc-contents ">

      <p>Save the dataset to a file using the 'zarr' format.
Parameters</p>
<hr>
<div class="admonition fname">
<p class="admonition-title">str</p>
<p>Filename to save to.</p>
</div>
<div class="admonition fields">
<p class="admonition-title">str or dict</p>
<p>dictionary of dask arrays to save. If equal to 'all', save all fields in current dataset.</p>
</div>
<p>overwrite
    overwrite existing file
zarr_kwargs
    optional arguments to pass to zarr
cast_uints
    need to potentially cast uints to ints for some compressions; TODO: clean this up</p>
<h6 id="scida.interface.BaseDataset.save--returns">Returns</h6>

        <details class="quote">
          <summary>Source code in <code>scida/interface.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">save</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">fname</span><span class="p">,</span>
    <span class="n">fields</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
        <span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">da</span><span class="o">.</span><span class="n">Array</span><span class="p">]]],</span> <span class="n">FieldContainer</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">"all"</span><span class="p">,</span>
    <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">zarr_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cast_uints</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">extra_attrs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Save the dataset to a file using the 'zarr' format.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fname: str</span>
<span class="sd">        Filename to save to.</span>
<span class="sd">    fields: str or dict</span>
<span class="sd">        dictionary of dask arrays to save. If equal to 'all', save all fields in current dataset.</span>
<span class="sd">    overwrite</span>
<span class="sd">        overwrite existing file</span>
<span class="sd">    zarr_kwargs</span>
<span class="sd">        optional arguments to pass to zarr</span>
<span class="sd">    cast_uints</span>
<span class="sd">        need to potentially cast uints to ints for some compressions; TODO: clean this up</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    """</span>
    <span class="c1"># We use zarr, as this way we have support to directly write into the file by the workers</span>
    <span class="c1"># (rather than passing back the data chunk over the scheduler to the interface)</span>
    <span class="c1"># Also, this way we can leverage new features, such as a large variety of compression methods.</span>
    <span class="c1"># cast_uints: if true, we cast uints to ints; needed for some compressions (particularly zfp)</span>
    <span class="k">if</span> <span class="n">zarr_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">zarr_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">store</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">DirectoryStore</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="o">**</span><span class="n">zarr_kwargs</span><span class="p">)</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>

    <span class="c1"># Metadata</span>
    <span class="n">defaultattributes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"Config"</span><span class="p">,</span> <span class="s2">"Header"</span><span class="p">,</span> <span class="s2">"Parameters"</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">dctname</span> <span class="ow">in</span> <span class="n">defaultattributes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dctname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="n">grp</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">dctname</span><span class="p">)</span>
            <span class="n">dct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">dctname</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dct</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">make_serializable</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="n">grp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">if</span> <span class="n">extra_attrs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">extra_attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">root</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="c1"># Data</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ptypes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">ptypes</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fields</span> <span class="o">==</span> <span class="s2">"all"</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Invalid field specifier."</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Invalid type for fields."</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ptypes</span><span class="p">:</span>
        <span class="n">root</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fields</span> <span class="o">==</span> <span class="s2">"all"</span><span class="p">:</span>
            <span class="n">fieldkeys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="n">p</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">fieldkeys</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fieldkeys</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">fieldkeys</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="n">p</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">arr</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="s2">"magnitude"</span><span class="p">):</span>  <span class="c1"># if we have units, remove those here</span>
                <span class="c1"># TODO: save units in metadata!</span>
                <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">)):</span>
                <span class="n">arr</span><span class="o">.</span><span class="n">compute_chunk_sizes</span><span class="p">()</span>  <span class="c1"># very inefficient (have to do it separately for every array)</span>
                <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">rechunk</span><span class="p">(</span><span class="n">chunks</span><span class="o">=</span><span class="s2">"auto"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cast_uints</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">:</span>
                    <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">arr</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">:</span>
                    <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">to_zarr</span><span class="p">(</span>
                <span class="n">arr</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">compute</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
    <span class="n">dask</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h4 id="scida.interface.BaseDataset.validate_path" class="doc doc-heading">
<code class="highlight language-python"><span class="n">validate_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-classmethod"><code>classmethod</code></small>
  </span>

</h4>

    <div class="doc doc-contents ">

      <p>Validate whether the given path is a valid path for this dataset.
Parameters</p>
<hr>
<p>path
args
kwargs</p>
<h6 id="scida.interface.BaseDataset.validate_path--returns">Returns</h6>

        <details class="quote">
          <summary>Source code in <code>scida/interface.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@classmethod</span>
<span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
<span class="k">def</span> <span class="nf">validate_path</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Validate whether the given path is a valid path for this dataset.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path</span>
<span class="sd">    args</span>
<span class="sd">    kwargs</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    """</span>
    <span class="k">return</span> <span class="kc">False</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="scida.interface.Dataset" class="doc doc-heading">
        <code>
Dataset            (<a class="autorefs autorefs-internal" title="scida.interface.BaseDataset" href="#scida.interface.BaseDataset">BaseDataset</a>)
        </code>



</h3>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>scida/interface.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Dataset</span><span class="p">(</span><span class="n">BaseDataset</span><span class="p">):</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">validate_path</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Validate whether the given path is a valid path for this dataset.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path</span>
<span class="sd">        args</span>
<span class="sd">        kwargs</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        """</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_clean_metadata_from_raw</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">rawmetadata</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{}</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">









  <div class="doc doc-object doc-method">



<h4 id="scida.interface.Dataset.validate_path" class="doc doc-heading">
<code class="highlight language-python"><span class="n">validate_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-classmethod"><code>classmethod</code></small>
  </span>

</h4>

    <div class="doc doc-contents ">

      <p>Validate whether the given path is a valid path for this dataset.
Parameters</p>
<hr>
<p>path
args
kwargs</p>
<h6 id="scida.interface.Dataset.validate_path--returns">Returns</h6>

        <details class="quote">
          <summary>Source code in <code>scida/interface.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">validate_path</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Validate whether the given path is a valid path for this dataset.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path</span>
<span class="sd">    args</span>
<span class="sd">    kwargs</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    """</span>
    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>





  <div class="doc doc-object doc-class">



<h3 id="scida.interface.Selector" class="doc doc-heading">
        <code>
Selector        </code>



</h3>

    <div class="doc doc-contents ">

      <p>Base Class for data selection decorator factory</p>

        <details class="quote">
          <summary>Source code in <code>scida/interface.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Selector</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Base Class for data selection decorator factory"""</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keys</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># the keys we check for.</span>
        <span class="c1"># holds a copy of the species' fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_backup</span> <span class="o">=</span> <span class="n">FieldContainer</span><span class="p">()</span>
        <span class="c1"># holds the species' fields we operate on</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span> <span class="n">FieldContainer</span> <span class="o">=</span> <span class="n">FieldContainer</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">newfn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="c1"># TODO: Add graceful exit/restore after exception in self.prepare</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_backup</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy_skeleton</span><span class="p">()</span>
            <span class="c1"># deepdictkeycopy(self.data_backup, self.data)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="s2">"Subclass implementation needed for self.keys!"</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"dropkeys"</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">newfn</span>

    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">"Subclass implementation needed!"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_backup</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">















  </div>

    </div>

  </div>









  </div>

    </div>

  </div>




  <div class="doc doc-object doc-module">



<h2 id="scida.misc" class="doc doc-heading">
        <code>misc</code>



</h2>

    <div class="doc doc-contents ">




  <div class="doc doc-children">









  <div class="doc doc-object doc-function">



<h3 id="scida.misc.check_config_for_dataset" class="doc doc-heading">
<code class="highlight language-python"><span class="n">check_config_for_dataset</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">unique</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Check whether the given dataset can be identified to be a certain simulation (type) by its metadata.
Parameters</p>
<hr>
<div class="admonition metadata">
<p class="admonition-title">dict</p>
<p>metadata of the dataset used for identification</p>
</div>
<div class="admonition path">
<p class="admonition-title">str</p>
<p>path to the dataset, sometimes helpful for identification</p>
</div>
<div class="admonition unique">
<p class="admonition-title">bool</p>
<p>whether to expect return to be unique</p>
</div>
<h5 id="scida.misc.check_config_for_dataset--returns">Returns</h5>

        <details class="quote">
          <summary>Source code in <code>scida/misc.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">check_config_for_dataset</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">unique</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Check whether the given dataset can be identified to be a certain simulation (type) by its metadata.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    metadata: dict</span>
<span class="sd">        metadata of the dataset used for identification</span>
<span class="sd">    path: str</span>
<span class="sd">        path to the dataset, sometimes helpful for identification</span>
<span class="sd">    unique: bool</span>
<span class="sd">        whether to expect return to be unique</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    """</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">get_simulationconfig</span><span class="p">()</span>

    <span class="n">candidates</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="s2">"data"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">candidates</span>
    <span class="n">simdct</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="s2">"data"</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">simdct</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">simdct</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">simdct</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">vals</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">possible_candidate</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="s2">"identifiers"</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
            <span class="n">idtfrs</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="s2">"identifiers"</span><span class="p">]</span>
            <span class="c1"># special key not specifying identifying metadata</span>
            <span class="n">specialkeys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"name_contains"</span><span class="p">]</span>
            <span class="n">allkeys</span> <span class="o">=</span> <span class="n">idtfrs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">allkeys</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">specialkeys</span><span class="p">])</span>
            <span class="k">if</span> <span class="s2">"name_contains"</span> <span class="ow">in</span> <span class="n">idtfrs</span> <span class="ow">and</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="c1"># we only check the last three path elements</span>
                <span class="n">dirnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                <span class="n">substring</span> <span class="o">=</span> <span class="n">idtfrs</span><span class="p">[</span><span class="s2">"name_contains"</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">substring</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dirnames</span><span class="p">]):</span>
                    <span class="n">possible_candidate</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">allkeys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">possible_candidate</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">idtfrs</span><span class="p">[</span><span class="n">grp</span><span class="p">]</span>
                <span class="n">h5path</span> <span class="o">=</span> <span class="s2">"/"</span> <span class="o">+</span> <span class="n">grp</span>
                <span class="k">if</span> <span class="n">h5path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
                    <span class="n">possible_candidate</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">h5path</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">ikey</span><span class="p">,</span> <span class="n">ival</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">ikey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
                        <span class="n">possible_candidate</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                    <span class="n">av</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="n">ikey</span><span class="p">]</span>
                    <span class="n">matchtype</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ival</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="n">matchtype</span> <span class="o">=</span> <span class="n">ival</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"match"</span><span class="p">,</span> <span class="n">matchtype</span><span class="p">)</span>  <span class="c1"># default means equal</span>
                        <span class="n">ival</span> <span class="o">=</span> <span class="n">ival</span><span class="p">[</span><span class="s2">"content"</span><span class="p">]</span>

                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                        <span class="n">av</span> <span class="o">=</span> <span class="n">av</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">"UTF-8"</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">matchtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">av</span> <span class="o">!=</span> <span class="n">ival</span><span class="p">:</span>
                            <span class="n">possible_candidate</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">break</span>
                    <span class="k">elif</span> <span class="n">matchtype</span> <span class="o">==</span> <span class="s2">"substring"</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">ival</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">av</span><span class="p">:</span>
                            <span class="n">possible_candidate</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">possible_candidate</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">possible_candidate</span><span class="p">:</span>
            <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">unique</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Multiple dataset candidates (set unique=False?):"</span><span class="p">,</span> <span class="n">candidates</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">candidates</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="scida.misc.deepdictkeycopy" class="doc doc-heading">
<code class="highlight language-python"><span class="n">deepdictkeycopy</span><span class="p">(</span><span class="n">olddict</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">newdict</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Recursively walk nested dictionary, only creating empty dictionaries for entries that are dictionaries themselves.
Parameters</p>
<hr>
<p>olddict
newdict</p>
<h5 id="scida.misc.deepdictkeycopy--returns">Returns</h5>

        <details class="quote">
          <summary>Source code in <code>scida/misc.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">deepdictkeycopy</span><span class="p">(</span><span class="n">olddict</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">newdict</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Recursively walk nested dictionary, only creating empty dictionaries for entries that are dictionaries themselves.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    olddict</span>
<span class="sd">    newdict</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    """</span>
    <span class="bp">cls</span> <span class="o">=</span> <span class="n">olddict</span><span class="o">.</span><span class="vm">__class__</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">olddict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">MutableMapping</span><span class="p">):</span>
            <span class="n">newdict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
            <span class="n">deepdictkeycopy</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">newdict</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
</code></pre></div>
        </details>
    </div>

  </div>




  <div class="doc doc-object doc-function">



<h3 id="scida.misc.map_interface_args" class="doc doc-heading">
<code class="highlight language-python"><span class="n">map_interface_args</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Map arguments for interface if they are not lists</p>

        <details class="quote">
          <summary>Source code in <code>scida/misc.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">map_interface_args</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Map arguments for interface if they are not lists"""</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paths</span><span class="p">):</span>
        <span class="n">targs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">!=</span> <span class="n">n</span><span class="p">:</span>
                <span class="n">targs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">targs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">tkwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">!=</span> <span class="n">n</span><span class="p">:</span>
                <span class="n">tkwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tkwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">yield</span> <span class="n">path</span><span class="p">,</span> <span class="n">targs</span><span class="p">,</span> <span class="n">tkwargs</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 id="scida.misc.path_hdf5cachefile_exists" class="doc doc-heading">
<code class="highlight language-python"><span class="n">path_hdf5cachefile_exists</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Checks whether a cache file exists for given path.</p>

        <details class="quote">
          <summary>Source code in <code>scida/misc.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">path_hdf5cachefile_exists</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Checks whether a cache file exists for given path."""</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="n">return_hdf5cachepath</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fp</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span>
</code></pre></div>
        </details>
    </div>

  </div>




  <div class="doc doc-object doc-function">



<h3 id="scida.misc.return_cachefile_path" class="doc doc-heading">
<code class="highlight language-python"><span class="n">return_cachefile_path</span><span class="p">(</span><span class="n">fname</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>If path cannot be generated, return None</p>

        <details class="quote">
          <summary>Source code in <code>scida/misc.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">return_cachefile_path</span><span class="p">(</span><span class="n">fname</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""If path cannot be generated, return None"""</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>
    <span class="k">if</span> <span class="s2">"cache_path"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">cp</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">"cache_path"</span><span class="p">]</span>
    <span class="n">cp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">cp</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">cp</span><span class="p">)</span>
    <span class="n">path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
    <span class="n">bp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">bp</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fp</span>
</code></pre></div>
        </details>
    </div>

  </div>








  </div>

    </div>

  </div>




  <div class="doc doc-object doc-module">



<h2 id="scida.series" class="doc doc-heading">
        <code>series</code>



</h2>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h3 id="scida.series.DatasetSeries" class="doc doc-heading">
        <code>
DatasetSeries        </code>



</h3>

    <div class="doc doc-contents ">

      <p>A container for collection of interface instances</p>

        <details class="quote">
          <summary>Source code in <code>scida/series.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">DatasetSeries</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""A container for collection of interface instances"""</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">paths</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Path</span><span class="p">]],</span>
        <span class="o">*</span><span class="n">interface_args</span><span class="p">,</span>
        <span class="n">datasetclass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">overwrite_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">lazy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># lazy will only initialize data sets on demand.</span>
        <span class="n">async_caching</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">interface_kwargs</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paths</span> <span class="o">=</span> <span class="n">paths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="n">names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hash</span> <span class="o">=</span> <span class="n">hash_path</span><span class="p">(</span><span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadatafile</span> <span class="o">=</span> <span class="n">return_cachefile_path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hash</span><span class="p">,</span> <span class="s2">"data.json"</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span> <span class="o">=</span> <span class="n">lazy</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">Path</span><span class="p">)):</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">exists</span><span class="p">()):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Specified path '</span><span class="si">%s</span><span class="s2">' does not exist."</span> <span class="o">%</span> <span class="n">p</span><span class="p">)</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="n">delay_init</span>  <span class="c1"># lazy loading</span>

        <span class="c1"># Catch Mixins and create type:</span>
        <span class="n">mixins</span> <span class="o">=</span> <span class="n">interface_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"mixins"</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">datasetclass</span> <span class="o">=</span> <span class="n">create_MixinDataset</span><span class="p">(</span><span class="n">datasetclass</span><span class="p">,</span> <span class="n">mixins</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset_cls</span> <span class="o">=</span> <span class="n">datasetclass</span>

        <span class="n">gen</span> <span class="o">=</span> <span class="n">map_interface_args</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="o">*</span><span class="n">interface_args</span><span class="p">,</span> <span class="o">**</span><span class="n">interface_kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span> <span class="o">=</span> <span class="p">[</span><span class="n">dec</span><span class="p">(</span><span class="n">datasetclass</span><span class="p">)(</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"Have not cached this data series. Can take a while."</span><span class="p">)</span>
            <span class="n">dct</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                <span class="n">tqdm</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">))</span>
            <span class="p">):</span>
                <span class="n">rawmeta</span> <span class="o">=</span> <span class="n">load_metadata</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">choose_prefix</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="c1"># class method does not initiate obj.</span>
                <span class="n">dct</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">_clean_metadata_from_raw</span><span class="p">(</span><span class="n">rawmeta</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">dct</span>
        <span class="k">elif</span> <span class="n">async_caching</span><span class="p">:</span>
            <span class="c1"># hacky and should not be here this explicitly, just a proof of concept</span>
            <span class="c1"># for p in paths:</span>
            <span class="c1">#     loader = scida.io.determine_loader(p)</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__init_subclass__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init_subclass__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">dataseries_type_registry</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rep</span> <span class="o">=</span> <span class="s2">""</span>
        <span class="n">rep</span> <span class="o">+=</span> <span class="s2">"class: "</span> <span class="o">+</span> <span class="n">sprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repr_dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">props</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">rep</span> <span class="o">+=</span> <span class="n">sprint</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rep</span> <span class="o">+=</span> <span class="n">sprint</span><span class="p">(</span><span class="s2">"=== metadata ==="</span><span class="p">)</span>
            <span class="c1"># we print the range of each metadata attribute</span>
            <span class="n">minmax_dct</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">mdct</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mdct</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">minmax_dct</span><span class="p">:</span>
                        <span class="n">minmax_dct</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                            <span class="k">continue</span>  <span class="c1"># cannot compare arrays</span>
                        <span class="n">minmax_dct</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">minmax_dct</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">v</span><span class="p">)</span>
                        <span class="n">minmax_dct</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">minmax_dct</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">minmax_dct</span><span class="p">:</span>
                <span class="n">reprval1</span><span class="p">,</span> <span class="n">reprval2</span> <span class="o">=</span> <span class="n">minmax_dct</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">minmax_dct</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reprval1</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                    <span class="n">reprval1</span> <span class="o">=</span> <span class="s2">"</span><span class="si">%.2f</span><span class="s2">"</span> <span class="o">%</span> <span class="n">reprval1</span>
                    <span class="n">reprval2</span> <span class="o">=</span> <span class="s2">"</span><span class="si">%.2f</span><span class="s2">"</span> <span class="o">%</span> <span class="n">reprval2</span>
                <span class="n">m1</span> <span class="o">=</span> <span class="n">minmax_dct</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">m2</span> <span class="o">=</span> <span class="n">minmax_dct</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">m1</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">m1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">m1</span> <span class="o">==</span> <span class="n">m2</span><span class="p">):</span>
                    <span class="n">rep</span> <span class="o">+=</span> <span class="n">sprint</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">minmax_dct</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rep</span> <span class="o">+=</span> <span class="n">sprint</span><span class="p">(</span>
                        <span class="s2">"</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> -- </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">minmax_dct</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">minmax_dct</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                    <span class="p">)</span>
            <span class="n">rep</span> <span class="o">+=</span> <span class="n">sprint</span><span class="p">(</span><span class="s2">"============"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">rep</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
            <span class="s2">"Series do not have 'data' attribute. Load a dataset from series.get_dataset()."</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_repr_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Return a dictionary of properties to be printed by __repr__ method.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">        """</span>
        <span class="n">props</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">]</span>
        <span class="n">props</span><span class="p">[</span><span class="s2">"source(id=0)"</span><span class="p">]</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">props</span><span class="p">[</span><span class="s2">"Ndatasets"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">props</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Return a string representation of the object.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">        """</span>
        <span class="n">props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repr_dict</span><span class="p">()</span>
        <span class="n">clsname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">clsname</span> <span class="o">+</span> <span class="s2">"["</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">props</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="s2">"</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">, "</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s2">"]"</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">validate_path</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CandidateStatus</span><span class="p">:</span>
        <span class="c1"># estimate whether we have a valid path for this dataseries</span>
        <span class="k">return</span> <span class="n">CandidateStatus</span><span class="o">.</span><span class="n">NO</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_directory</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">interface_args</span><span class="p">,</span> <span class="n">datasetclass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">interface_kwargs</span>
    <span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">exists</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Specified path does not exist."</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pattern</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="s2">"*"</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">pattern</span><span class="p">)]</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">paths</span><span class="p">,</span> <span class="o">*</span><span class="n">interface_args</span><span class="p">,</span> <span class="n">datasetclass</span><span class="o">=</span><span class="n">datasetclass</span><span class="p">,</span> <span class="o">**</span><span class="n">interface_kwargs</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_dataset</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">reltol</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">"""Get dataset by some metadata property. In the base class, we go by list index."""</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Specify index/name or some parameter to select for."</span><span class="p">)</span>
        <span class="c1"># aliases for index:</span>
        <span class="n">aliases</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"snap"</span><span class="p">,</span> <span class="s2">"snapshot"</span><span class="p">]</span>
        <span class="n">aliases_given</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">aliases</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">aliases_given</span> <span class="o">+=</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aliases_given</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Multiple aliases for index specified."</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">aliases_given</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"No names specified for members of this series."</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Name </span><span class="si">%s</span><span class="s2"> not found in this series."</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">"Cannot select by given keys before dataset evaluation."</span>
                <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Unknown error."</span><span class="p">)</span>  <span class="c1"># should not happen?</span>
        <span class="n">candidates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">candidates_props</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">props_compare</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># save names of fields we want to compare</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">candidates_props</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">dm</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">assert</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="n">is_candidate</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dm</span><span class="p">:</span>
                    <span class="n">is_candidate</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                    <span class="n">candidates_props</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dm</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                    <span class="n">props_compare</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">v</span> <span class="o">!=</span> <span class="n">dm</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                    <span class="n">is_candidate</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">is_candidate</span><span class="p">:</span>
                <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># unroll changes</span>
                <span class="k">for</span> <span class="n">lst</span> <span class="ow">in</span> <span class="n">candidates_props</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">):</span>
                        <span class="n">lst</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="c1"># find candidate closest to request</span>
        <span class="n">idxlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">props_compare</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">candidates_props</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">-</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
            <span class="n">idxlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">idxlist</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Ambiguous selection request"</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">idxlist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"No candidate found."</span><span class="p">)</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">candidates</span><span class="p">[</span><span class="n">idxlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="c1"># TODO: reintroduce tolerance check</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dataset</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadatafile</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fp</span><span class="p">):</span>
            <span class="n">md</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">))</span>
            <span class="n">ikeys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">md</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
            <span class="n">mdnew</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">ik</span> <span class="ow">in</span> <span class="n">ikeys</span><span class="p">:</span>
                <span class="n">mdnew</span><span class="p">[</span><span class="n">ik</span><span class="p">]</span> <span class="o">=</span> <span class="n">md</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">ik</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="n">mdnew</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@metadata</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dct</span><span class="p">):</span>
        <span class="k">class</span> <span class="nc">ComplexEncoder</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">JSONEncoder</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">):</span>
                    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">):</span>
                    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">):</span>
                    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">"utf-8"</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1000</span>  <span class="c1"># dont want large obs here...</span>
                    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONEncoder</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">"obj failing json encoding:"</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">e</span>

        <span class="c1"># def serialize_numpy(obj):</span>
        <span class="c1">#    if isinstance(obj, np.int64): return int(obj)</span>
        <span class="c1">#    if isinstance(obj, np.int32): return int(obj)</span>
        <span class="c1">#    return json.JSONEncoder.default(self, obj)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="n">dct</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadatafile</span>
        <span class="c1"># print(dct)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fp</span><span class="p">):</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dct</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">),</span> <span class="bp">cls</span><span class="o">=</span><span class="n">ComplexEncoder</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">













  <div class="doc doc-object doc-method">



<h4 id="scida.series.DatasetSeries.__init_subclass__" class="doc doc-heading">
<code class="highlight language-python"><span class="n">__init_subclass__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-classmethod"><code>classmethod</code></small>
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h4>

    <div class="doc doc-contents ">

      <p>This method is called when a class is subclassed.</p>
<p>The default implementation does nothing. It may be
overridden to extend subclasses.</p>

        <details class="quote">
          <summary>Source code in <code>scida/series.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">__init_subclass__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init_subclass__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">dataseries_type_registry</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span>
</code></pre></div>
        </details>
    </div>

  </div>




  <div class="doc doc-object doc-method">



<h4 id="scida.series.DatasetSeries.__repr__" class="doc doc-heading">
<code class="highlight language-python"><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h4>

    <div class="doc doc-contents ">

      <p>Return a string representation of the object.
Returns</p>
<hr>
<p>str</p>

        <details class="quote">
          <summary>Source code in <code>scida/series.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Return a string representation of the object.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">    """</span>
    <span class="n">props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repr_dict</span><span class="p">()</span>
    <span class="n">clsname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">clsname</span> <span class="o">+</span> <span class="s2">"["</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">props</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="s2">"</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">, "</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s2">"]"</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
        </details>
    </div>

  </div>




  <div class="doc doc-object doc-method">



<h4 id="scida.series.DatasetSeries.get_dataset" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">reltol</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


</h4>

    <div class="doc doc-contents ">

      <p>Get dataset by some metadata property. In the base class, we go by list index.</p>

        <details class="quote">
          <summary>Source code in <code>scida/series.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_dataset</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">reltol</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">"""Get dataset by some metadata property. In the base class, we go by list index."""</span>
    <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Specify index/name or some parameter to select for."</span><span class="p">)</span>
    <span class="c1"># aliases for index:</span>
    <span class="n">aliases</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"snap"</span><span class="p">,</span> <span class="s2">"snapshot"</span><span class="p">]</span>
    <span class="n">aliases_given</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">aliases</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">aliases_given</span> <span class="o">+=</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aliases_given</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Multiple aliases for index specified."</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">aliases_given</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"No names specified for members of this series."</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Name </span><span class="si">%s</span><span class="s2"> not found in this series."</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lazy</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">"Cannot select by given keys before dataset evaluation."</span>
            <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Unknown error."</span><span class="p">)</span>  <span class="c1"># should not happen?</span>
    <span class="n">candidates</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">candidates_props</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">props_compare</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># save names of fields we want to compare</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">candidates_props</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">dm</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="k">assert</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="n">is_candidate</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dm</span><span class="p">:</span>
                <span class="n">is_candidate</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                <span class="n">candidates_props</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dm</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="n">props_compare</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">v</span> <span class="o">!=</span> <span class="n">dm</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                <span class="n">is_candidate</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">is_candidate</span><span class="p">:</span>
            <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># unroll changes</span>
            <span class="k">for</span> <span class="n">lst</span> <span class="ow">in</span> <span class="n">candidates_props</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">):</span>
                    <span class="n">lst</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="c1"># find candidate closest to request</span>
    <span class="n">idxlist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">props_compare</span><span class="p">:</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">candidates_props</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">-</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
        <span class="n">idxlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">idxlist</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Ambiguous selection request"</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">idxlist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"No candidate found."</span><span class="p">)</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">candidates</span><span class="p">[</span><span class="n">idxlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="c1"># TODO: reintroduce tolerance check</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dataset</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="scida.series.DirectoryCatalog" class="doc doc-heading">
        <code>
DirectoryCatalog        </code>



</h3>

    <div class="doc doc-contents ">

      <p>A catalog consisting of interface instances contained in a directory.</p>

        <details class="quote">
          <summary>Source code in <code>scida/series.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">DirectoryCatalog</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""A catalog consisting of interface instances contained in a directory."""</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">












  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h3 id="scida.series.HomogeneousSeries" class="doc doc-heading">
        <code>
HomogeneousSeries            (<a class="autorefs autorefs-internal" title="scida.series.DatasetSeries" href="#scida.series.DatasetSeries">DatasetSeries</a>)
        </code>



</h3>

    <div class="doc doc-contents ">

      <p>Series consisting of same-type data sets.</p>

        <details class="quote">
          <summary>Source code in <code>scida/series.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">HomogeneousSeries</span><span class="p">(</span><span class="n">DatasetSeries</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Series consisting of same-type data sets."""</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">interface_kwargs</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">












  </div>

    </div>

  </div>








  </div>

    </div>

  </div>





  </div>

    </div>

  </div></div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../faq/" class="md-footer__link md-footer__link--prev" aria-label="Previous: FAQ" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              FAQ
            </div>
          </div>
        </a>
      
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["content.code.annotate", "navigation.sections", "navigation.indexes"], "search": "../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.5a2dcb6a.min.js"></script>
      
        <script src="../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
    
  <script>document$.subscribe(() => {const lightbox = GLightbox({"touchNavigation": true, "loop": true, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});})</script></body>
</html>